<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permit2 é“¶è¡Œåˆçº¦æµ‹è¯•é¡µé¢</title>
    <script type="module">
        // å¯¼å…¥Viemæ¨¡å—
        import { createPublicClient, createWalletClient, custom, http, formatEther, parseEther, getContract } from 'https://esm.sh/viem@2.21.45'
        import { privateKeyToAccount } from 'https://esm.sh/viem@2.21.45/accounts'
        import { localhost } from 'https://esm.sh/viem@2.21.45/chains'
        
        // å…¨å±€å˜é‡
        window.viemClient = null;
        window.walletClient = null;
        window.bankContract = null;
        window.tokenContract = null;
        window.permit2Contract = null;
        window.currentAccount = null;
        
        // ç®€åŒ–çš„ ABI
        window.BANK_ABI = [
            {"inputs":[],"name":"deposit","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"depositor","type":"address"}],"name":"getDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getContractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getTopDepositorsWithAmounts","outputs":[{"internalType":"address[3]","name":"","type":"address[3]"},{"internalType":"uint256[3]","name":"","type":"uint256[3]"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"components":[{"components":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint160","name":"amount","type":"uint160"},{"internalType":"uint48","name":"expiration","type":"uint48"},{"internalType":"uint48","name":"nonce","type":"uint48"}],"internalType":"struct IPermit2.PermitDetails","name":"details","type":"tuple"},{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"sigDeadline","type":"uint256"}],"internalType":"struct IPermit2.PermitSingle","name":"permitSingle","type":"tuple"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"depositWithPermit2","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        window.ERC20_ABI = [
            {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_owner","type":"address"},{"internalType":"address","name":"_spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"remaining","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        window.PERMIT2_ABI = [
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"token","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint160","name":"amount","type":"uint160"},{"internalType":"uint48","name":"expiration","type":"uint48"},{"internalType":"uint48","name":"nonce","type":"uint48"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"DOMAIN_SEPARATOR","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"nonces","outputs":[{"internalType":"uint48","name":"","type":"uint48"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"components":[{"components":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint160","name":"amount","type":"uint160"},{"internalType":"uint48","name":"expiration","type":"uint48"},{"internalType":"uint48","name":"nonce","type":"uint48"}],"internalType":"struct IPermit2.PermitDetails","name":"details","type":"tuple"},{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"sigDeadline","type":"uint256"}],"internalType":"struct IPermit2.PermitSingle","name":"permitSingle","type":"tuple"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"permit","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.connectWallet = async function() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // é¦–å…ˆå°è¯•åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x539' }], // 1337 çš„åå…­è¿›åˆ¶
                        });
                    } catch (switchError) {
                        // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œæ·»åŠ æœ¬åœ°ç½‘ç»œ
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x539', // 1337 çš„åå…­è¿›åˆ¶
                                    chainName: 'Anvil Local Network',
                                    nativeCurrency: {
                                        name: 'Ethereum',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: ['http://127.0.0.1:8545'],
                                    blockExplorerUrls: null
                                }]
                            });
                        } else if (switchError.code === -32602) {
                            // ç½‘ç»œå·²å­˜åœ¨ä½†RPCç«¯ç‚¹å†²çªï¼Œç›´æ¥å°è¯•è¿æ¥
                            showStatus('connectionStatus', 'âš ï¸ æ£€æµ‹åˆ°ç½‘ç»œé…ç½®å†²çªï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°Chain ID 1337', 'warning');
                        } else {
                            throw switchError;
                        }
                    }
                    
                    // åˆ›å»ºå…¬å…±å®¢æˆ·ç«¯
                    window.viemClient = createPublicClient({
                        chain: localhost,
                        transport: http('http://127.0.0.1:8545')
                    });
                    
                    // åˆ›å»ºé’±åŒ…å®¢æˆ·ç«¯
                    window.walletClient = createWalletClient({
                        chain: localhost,
                        transport: custom(window.ethereum)
                    });
                    
                    // è¯·æ±‚è´¦æˆ·è®¿é—®
                    const accounts = await window.walletClient.requestAddresses();
                    window.currentAccount = accounts[0];
                    document.getElementById('currentAccount').textContent = window.currentAccount;
                    
                    // è·å–ç½‘ç»œä¿¡æ¯
                    const chainId = await window.viemClient.getChainId();
                    document.getElementById('networkInfo').textContent = `Chain ID: ${chainId}`;
                    
                    showStatus('connectionStatus', 'âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼å·²åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ', 'success');
                    
                    // ç›‘å¬è´¦æˆ·å˜åŒ–
                    window.ethereum.on('accountsChanged', function (accounts) {
                        if (accounts.length > 0) {
                            window.currentAccount = accounts[0];
                            document.getElementById('currentAccount').textContent = window.currentAccount;
                        } else {
                            window.currentAccount = null;
                            document.getElementById('currentAccount').textContent = 'æœªè¿æ¥';
                        }
                    });
                    
                    // ç›‘å¬ç½‘ç»œå˜åŒ–
                    window.ethereum.on('chainChanged', function (chainId) {
                        const decimalChainId = parseInt(chainId, 16);
                        document.getElementById('networkInfo').textContent = `Chain ID: ${decimalChainId}`;
                        if (decimalChainId !== 1337) {
                            showStatus('connectionStatus', 'âš ï¸ è¯·åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ (Chain ID: 1337)', 'warning');
                        }
                    });
                } catch (error) {
                    showStatus('connectionStatus', 'âŒ è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                showStatus('connectionStatus', 'âŒ è¯·å®‰è£… MetaMask!', 'error');
            }
        };

        // åˆå§‹åŒ–åˆçº¦
        window.initContracts = function() {
            const bankAddress = document.getElementById('bankAddress').value;
            const tokenAddress = document.getElementById('tokenAddress').value;
            const permit2Address = document.getElementById('permit2Address').value;
            
            if (!window.viemClient || !window.walletClient) {
                showStatus('connectionStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            
            try {
                if (bankAddress) {
                    window.bankContract = getContract({
                        address: bankAddress,
                        abi: window.BANK_ABI,
                        client: { public: window.viemClient, wallet: window.walletClient }
                    });
                }
                if (tokenAddress) {
                    window.tokenContract = getContract({
                        address: tokenAddress,
                        abi: window.ERC20_ABI,
                        client: { public: window.viemClient, wallet: window.walletClient }
                    });
                }
                if (permit2Address) {
                    window.permit2Contract = getContract({
                        address: permit2Address,
                        abi: window.PERMIT2_ABI,
                        client: { public: window.viemClient, wallet: window.walletClient }
                    });
                }
                
                showStatus('connectionStatus', 'âœ… åˆçº¦åˆå§‹åŒ–æˆåŠŸï¼', 'success');
            } catch (error) {
                showStatus('connectionStatus', 'âŒ åˆçº¦åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        };

        // è·å–Tokenä¿¡æ¯
        window.getTokenInfo = async function() {
            if (!window.tokenContract) {
                showStatus('tokenStatus', 'âŒ è¯·å…ˆåˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                const name = await window.tokenContract.read.name();
                const symbol = await window.tokenContract.read.symbol();
                const decimals = await window.tokenContract.read.decimals();
                const totalSupply = await window.tokenContract.read.totalSupply();
                
                const results = `
                    Tokenåç§°: ${name}
                    Tokenç¬¦å·: ${symbol}
                    å°æ•°ä½æ•°: ${decimals}
                    æ€»ä¾›åº”é‡: ${formatEther(totalSupply)} ${symbol}
                `;
                
                document.getElementById('tokenResults').textContent = results;
                document.getElementById('tokenResults').style.display = 'block';
                showStatus('tokenStatus', 'âœ… Tokenä¿¡æ¯è·å–æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('tokenStatus', 'âŒ è·å–Tokenä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢Tokenä½™é¢
        window.getMyTokenBalance = async function() {
            if (!window.tokenContract || !window.currentAccount) {
                showStatus('tokenStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                const balance = await window.tokenContract.read.balanceOf([window.currentAccount]);
                const symbol = await window.tokenContract.read.symbol();
                
                const results = `æˆ‘çš„${symbol}ä½™é¢: ${formatEther(balance)} ${symbol}`;
                
                document.getElementById('tokenResults').textContent = results;
                document.getElementById('tokenResults').style.display = 'block';
                showStatus('tokenStatus', 'âœ… ä½™é¢æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('tokenStatus', 'âŒ æŸ¥è¯¢ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };

        // è·å–æµ‹è¯•ä»£å¸
        window.mintTokens = async function() {
            if (!window.tokenContract || !window.currentAccount) {
                showStatus('tokenStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                 // ç›´æ¥ä½¿ç”¨castå‘½ä»¤ä»éƒ¨ç½²è€…åœ°å€è½¬è´¦ä»£å¸
                 const response = await fetch('/transfer-tokens', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         to: window.currentAccount,
                         amount: '10000'
                     })
                 });
                 
                 if (response.ok) {
                     showStatus('tokenStatus', 'âœ… è·å–æµ‹è¯•ä»£å¸æˆåŠŸ', 'success');
                 } else {
                     throw new Error('è½¬è´¦å¤±è´¥');
                 }
             } catch (error) {
                 // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                 try {
                     // åˆ›å»ºä¸€ä¸ªæ–°çš„åˆçº¦å®ä¾‹ï¼Œä½¿ç”¨éƒ¨ç½²è€…è´¦æˆ·
                     const deployerPrivateKey = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';
                     const deployerAccount = privateKeyToAccount(deployerPrivateKey);
                     
                     const deployerWalletClient = createWalletClient({
                         account: deployerAccount,
                         chain: localhost,
                         transport: http('http://localhost:8545')
                     });
                     
                     const tokenAddress = document.getElementById('tokenAddress').value;
                     const deployerTokenContract = getContract({
                         address: tokenAddress,
                         abi: window.ERC20_ABI,
                         client: { public: window.viemClient, wallet: deployerWalletClient }
                     });
                     
                     const amount = parseEther('10000'); // è½¬è´¦1ä¸‡ä¸ªtokenç»™ç”¨æˆ·
                     const hash = await deployerTokenContract.write.transfer([window.currentAccount, amount]);
                     
                     showStatus('tokenStatus', 'âœ… è·å–æµ‹è¯•ä»£å¸æˆåŠŸï¼Œäº¤æ˜“å“ˆå¸Œ: ' + hash, 'success');
                 } catch (backupError) {
                     showStatus('tokenStatus', 'âŒ è·å–æµ‹è¯•ä»£å¸å¤±è´¥: ' + backupError.message, 'error');
                 }
             }
        };

        // æˆæƒToken
        window.approveToken = async function() {
            if (!window.tokenContract || !window.currentAccount) {
                showStatus('tokenStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            const permit2Address = document.getElementById('permit2Address').value;
            if (!permit2Address) {
                showStatus('tokenStatus', 'âŒ è¯·è¾“å…¥Permit2åœ°å€', 'error');
                return;
            }
            
            try {
                const amount = parseEther('1000000'); // æˆæƒ100ä¸‡ä¸ªtoken
                const hash = await window.tokenContract.write.approve([permit2Address, amount], {
                    account: window.currentAccount
                });
                showStatus('tokenStatus', 'âœ… TokenæˆæƒæˆåŠŸï¼Œäº¤æ˜“å“ˆå¸Œ: ' + hash, 'success');
            } catch (error) {
                showStatus('tokenStatus', 'âŒ Tokenæˆæƒå¤±è´¥: ' + error.message, 'error');
            }
        };

        // è½¬è´¦Token
        window.transferToken = async function() {
            if (!window.tokenContract || !window.currentAccount) {
                showStatus('tokenStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            const to = document.getElementById('transferTo').value;
            const amount = document.getElementById('transferAmount').value;
            
            if (!to || !amount) {
                showStatus('tokenStatus', 'âŒ è¯·è¾“å…¥è½¬è´¦åœ°å€å’Œæ•°é‡', 'error');
                return;
            }
            
            try {
                const amountWei = parseEther(amount);
                const hash = await window.tokenContract.write.transfer([to, amountWei], {
                    account: window.currentAccount
                });
                showStatus('tokenStatus', 'âœ… è½¬è´¦æˆåŠŸï¼Œäº¤æ˜“å“ˆå¸Œ: ' + hash, 'success');
            } catch (error) {
                showStatus('tokenStatus', 'âŒ è½¬è´¦å¤±è´¥: ' + error.message, 'error');
            }
        };

        // å­˜æ¬¾ETH
        window.depositETH = async function() {
            if (!window.bankContract || !window.currentAccount) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            const amount = document.getElementById('depositAmount').value;
            if (!amount) {
                showStatus('bankStatus', 'âŒ è¯·è¾“å…¥å­˜æ¬¾é‡‘é¢', 'error');
                return;
            }
            
            try {
                const amountWei = parseEther(amount);
                const hash = await window.bankContract.write.deposit([], {
                    account: window.currentAccount,
                    value: amountWei
                });
                showStatus('bankStatus', 'âœ… å­˜æ¬¾æˆåŠŸï¼Œäº¤æ˜“å“ˆå¸Œ: ' + hash, 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };

        // ææ¬¾ETH
        window.withdrawETH = async function() {
            if (!window.bankContract || !window.currentAccount) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            const amount = document.getElementById('withdrawAmount').value;
            if (!amount) {
                showStatus('bankStatus', 'âŒ è¯·è¾“å…¥ææ¬¾é‡‘é¢', 'error');
                return;
            }
            
            try {
                const amountWei = parseEther(amount);
                const hash = await window.bankContract.write.withdraw([amountWei], {
                    account: window.currentAccount
                });
                showStatus('bankStatus', 'âœ… ææ¬¾æˆåŠŸï¼Œäº¤æ˜“å“ˆå¸Œ: ' + hash, 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ ææ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢æˆ‘çš„å­˜æ¬¾
        window.getMyDeposit = async function() {
            if (!window.bankContract || !window.currentAccount) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                const deposit = await window.bankContract.read.getDeposit([window.currentAccount]);
                const results = `æˆ‘çš„å­˜æ¬¾: ${formatEther(deposit)} ETH`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… å­˜æ¬¾æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢åˆçº¦ä½™é¢
        window.getContractBalance = async function() {
            if (!window.bankContract) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆåˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                const balance = await window.bankContract.read.getContractBalance();
                const results = `åˆçº¦æ€»ä½™é¢: ${formatEther(balance)} ETH`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… åˆçº¦ä½™é¢æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢åˆçº¦ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢æ’è¡Œæ¦œ
        window.getTopDepositors = async function() {
            if (!window.bankContract) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆåˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                const [addresses, amounts] = await window.bankContract.read.getTopDepositorsWithAmounts();
                
                let results = 'å­˜æ¬¾æ’è¡Œæ¦œ:\n';
                for (let i = 0; i < addresses.length; i++) {
                    if (addresses[i] !== '0x0000000000000000000000000000000000000000') {
                        results += `${i + 1}. ${addresses[i]}: ${formatEther(amounts[i])} ETH\n`;
                    }
                }
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… æ’è¡Œæ¦œæŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢æ’è¡Œæ¦œå¤±è´¥: ' + error.message, 'error');
            }
        };

        // ===== æ–°å¢çš„åˆ†ç¦»ETHå’ŒERC20çš„å‡½æ•° =====

        // æŸ¥è¯¢æˆ‘çš„ETHå­˜æ¬¾
        window.getMyETHDeposit = async function() {
            if (!window.bankContract || !window.currentAccount) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                showStatus('bankStatus', 'ğŸ”„ æ­£åœ¨æŸ¥è¯¢ETHå­˜æ¬¾è®°å½•...', 'info');
                
                const bankAddress = document.getElementById('bankAddress').value;
                const currentBlock = await window.viemClient.getBlockNumber();
                
                // æŸ¥è¯¢ETHå­˜æ¬¾äº‹ä»¶ (Depositäº‹ä»¶)
                const ethDepositLogs = await window.viemClient.getLogs({
                    address: bankAddress,
                    event: {
                        type: 'event',
                        name: 'Deposit',
                        inputs: [
                            { name: 'depositor', type: 'address', indexed: true },
                            { name: 'amount', type: 'uint256', indexed: false }
                        ]
                    },
                    args: {
                        depositor: window.currentAccount
                    },
                    fromBlock: 0n,
                    toBlock: currentBlock
                });
                
                // è®¡ç®—ETHå­˜æ¬¾æ€»é¢
                let totalETHDeposit = 0n;
                ethDepositLogs.forEach(log => {
                    totalETHDeposit += log.args.amount;
                });
                
                const results = `æˆ‘çš„ETHå­˜æ¬¾: ${formatEther(totalETHDeposit)} ETH\n` +
                    `å­˜æ¬¾æ¬¡æ•°: ${ethDepositLogs.length} æ¬¡`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… ETHå­˜æ¬¾æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                console.error('æŸ¥è¯¢ETHå­˜æ¬¾å¤±è´¥:', error);
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢ETHå­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢åˆçº¦ETHä½™é¢
        window.getContractETHBalance = async function() {
            if (!window.bankContract) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆåˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                const balance = await window.bankContract.read.getContractBalance();
                const results = `åˆçº¦ETHä½™é¢: ${formatEther(balance)} ETH`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… åˆçº¦ETHä½™é¢æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢åˆçº¦ETHä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };

        // ERC20ä»£å¸å­˜æ¬¾ï¼ˆä½¿ç”¨Permit2æ–¹å¼ï¼‰
        window.depositERC20 = async function() {
            if (!window.tokenContract || !window.bankContract || !window.currentAccount) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            const amount = document.getElementById('erc20DepositAmount').value;
            if (!amount) {
                showStatus('bankStatus', 'âŒ è¯·è¾“å…¥å­˜æ¬¾æ•°é‡', 'error');
                return;
            }
            
            try {
                showStatus('bankStatus', 'ğŸ”„ æ­£åœ¨å¤„ç†ERC20å­˜æ¬¾...', 'info');
                
                // ä½¿ç”¨ç°æœ‰çš„Permit2å­˜æ¬¾åŠŸèƒ½
                const originalAmount = document.getElementById('permit2Amount').value;
                document.getElementById('permit2Amount').value = amount;
                
                // è°ƒç”¨Permit2å­˜æ¬¾å‡½æ•°
                await window.depositWithPermit2();
                
                // æ¢å¤åŸå§‹å€¼
                document.getElementById('permit2Amount').value = originalAmount;
                
            } catch (error) {
                showStatus('bankStatus', 'âŒ ERC20å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢æˆ‘çš„ERC20å­˜æ¬¾
        window.getMyERC20Deposit = async function() {
            if (!window.bankContract || !window.currentAccount) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                showStatus('bankStatus', 'ğŸ”„ æ­£åœ¨æŸ¥è¯¢ERC20å­˜æ¬¾è®°å½•...', 'info');
                
                const bankAddress = document.getElementById('bankAddress').value;
                const currentBlock = await window.viemClient.getBlockNumber();
                
                // æŸ¥è¯¢ERC20å­˜æ¬¾äº‹ä»¶ (DepositWithPermit2äº‹ä»¶)
                const erc20DepositLogs = await window.viemClient.getLogs({
                    address: bankAddress,
                    event: {
                        type: 'event',
                        name: 'DepositWithPermit2',
                        inputs: [
                            { name: 'depositor', type: 'address', indexed: true },
                            { name: 'token', type: 'address', indexed: true },
                            { name: 'amount', type: 'uint256', indexed: false }
                        ]
                    },
                    args: {
                        depositor: window.currentAccount
                    },
                    fromBlock: 0n,
                    toBlock: currentBlock
                });
                
                // è®¡ç®—ERC20å­˜æ¬¾æ€»é¢
                let totalERC20Deposit = 0n;
                erc20DepositLogs.forEach(log => {
                    totalERC20Deposit += log.args.amount;
                });
                
                const results = `æˆ‘çš„ERC20å­˜æ¬¾: ${formatEther(totalERC20Deposit)} SUI\n` +
                    `å­˜æ¬¾æ¬¡æ•°: ${erc20DepositLogs.length} æ¬¡`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… ERC20å­˜æ¬¾æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                console.error('æŸ¥è¯¢ERC20å­˜æ¬¾å¤±è´¥:', error);
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢ERC20å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢åˆçº¦ERC20ä½™é¢
        window.getContractERC20Balance = async function() {
            if (!window.tokenContract) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆåˆå§‹åŒ–Tokenåˆçº¦', 'error');
                return;
            }
            
            try {
                const bankAddress = document.getElementById('bankAddress').value;
                const balance = await window.tokenContract.read.balanceOf([bankAddress]);
                const results = `åˆçº¦ERC20ä½™é¢: ${formatEther(balance)} SUI`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… åˆçº¦ERC20ä½™é¢æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢åˆçº¦ERC20ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢æˆ‘çš„æ‰€æœ‰å­˜æ¬¾ï¼ˆåˆ†ç¦»ETHå’ŒERC20ï¼‰
        window.getAllMyDeposits = async function() {
            if (!window.bankContract || !window.tokenContract || !window.currentAccount) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                showStatus('bankStatus', 'ğŸ”„ æ­£åœ¨æŸ¥è¯¢å­˜æ¬¾è®°å½•...', 'info');
                
                const bankAddress = document.getElementById('bankAddress').value;
                
                // è·å–å½“å‰åŒºå—å·
                const currentBlock = await window.viemClient.getBlockNumber();
                
                // æŸ¥è¯¢ETHå­˜æ¬¾äº‹ä»¶ (Depositäº‹ä»¶)
                const ethDepositLogs = await window.viemClient.getLogs({
                    address: bankAddress,
                    event: {
                        type: 'event',
                        name: 'Deposit',
                        inputs: [
                            { name: 'depositor', type: 'address', indexed: true },
                            { name: 'amount', type: 'uint256', indexed: false }
                        ]
                    },
                    args: {
                        depositor: window.currentAccount
                    },
                    fromBlock: 0n,
                    toBlock: currentBlock
                });
                
                // æŸ¥è¯¢ERC20å­˜æ¬¾äº‹ä»¶ (DepositWithPermit2äº‹ä»¶)
                const erc20DepositLogs = await window.viemClient.getLogs({
                    address: bankAddress,
                    event: {
                        type: 'event',
                        name: 'DepositWithPermit2',
                        inputs: [
                            { name: 'depositor', type: 'address', indexed: true },
                            { name: 'token', type: 'address', indexed: true },
                            { name: 'amount', type: 'uint256', indexed: false }
                        ]
                    },
                    args: {
                        depositor: window.currentAccount
                    },
                    fromBlock: 0n,
                    toBlock: currentBlock
                });
                
                // è®¡ç®—ETHå­˜æ¬¾æ€»é¢
                let totalETHDeposit = 0n;
                ethDepositLogs.forEach(log => {
                    totalETHDeposit += log.args.amount;
                });
                
                // è®¡ç®—ERC20å­˜æ¬¾æ€»é¢
                let totalERC20Deposit = 0n;
                erc20DepositLogs.forEach(log => {
                    totalERC20Deposit += log.args.amount;
                });
                
                // æŸ¥è¯¢æˆ‘çš„é’±åŒ…ä½™é¢
                const myETHBalance = await window.viemClient.getBalance({
                    address: window.currentAccount
                });
                const myTokenBalance = await window.tokenContract.read.balanceOf([window.currentAccount]);
                
                // æŸ¥è¯¢Bankåˆçº¦ä¸­çš„æ€»å­˜æ¬¾ï¼ˆç”¨äºéªŒè¯ï¼‰
                const bankTotalDeposit = await window.bankContract.read.getDeposit([window.currentAccount]);
                
                const results = `æˆ‘çš„å­˜æ¬¾æƒ…å†µ (åˆ†ç¦»æ˜¾ç¤º):\n` +
                    `ğŸ“Š Bankåˆçº¦ä¸­çš„å­˜æ¬¾:\n` +
                    `  â€¢ ETHå­˜æ¬¾: ${formatEther(totalETHDeposit)} ETH\n` +
                    `  â€¢ ERC20å­˜æ¬¾: ${formatEther(totalERC20Deposit)} SUI\n` +
                    `  â€¢ æ€»è®¡: ${formatEther(bankTotalDeposit)} (éªŒè¯: ${formatEther(totalETHDeposit + totalERC20Deposit)})\n\n` +
                    `ğŸ’° æˆ‘çš„é’±åŒ…ä½™é¢:\n` +
                    `  â€¢ ETHä½™é¢: ${formatEther(myETHBalance)} ETH\n` +
                    `  â€¢ Tokenä½™é¢: ${formatEther(myTokenBalance)} SUI\n\n` +
                    `ğŸ“ˆ å­˜æ¬¾è®°å½•ç»Ÿè®¡:\n` +
                    `  â€¢ ETHå­˜æ¬¾æ¬¡æ•°: ${ethDepositLogs.length} æ¬¡\n` +
                    `  â€¢ ERC20å­˜æ¬¾æ¬¡æ•°: ${erc20DepositLogs.length} æ¬¡`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… å­˜æ¬¾æŸ¥è¯¢æˆåŠŸï¼ˆå·²åˆ†ç¦»ETHå’ŒERC20ï¼‰', 'success');
            } catch (error) {
                console.error('æŸ¥è¯¢å­˜æ¬¾å¤±è´¥:', error);
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢æ‰€æœ‰å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢åˆçº¦æ‰€æœ‰ä½™é¢
        window.getAllContractBalances = async function() {
            if (!window.bankContract || !window.tokenContract) {
                showStatus('bankStatus', 'âŒ è¯·å…ˆåˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            try {
                const bankAddress = document.getElementById('bankAddress').value;
                
                // æŸ¥è¯¢åˆçº¦ETHä½™é¢
                const ethBalance = await window.bankContract.read.getContractBalance();
                
                // æŸ¥è¯¢åˆçº¦ERC20ä½™é¢
                const erc20Balance = await window.tokenContract.read.balanceOf([bankAddress]);
                
                const results = `åˆçº¦ä½™é¢æƒ…å†µ:\n` +
                    `â€¢ ETHä½™é¢: ${formatEther(ethBalance)} ETH\n` +
                    `â€¢ ERC20ä½™é¢: ${formatEther(erc20Balance)} SUI`;
                
                document.getElementById('bankResults').textContent = results;
                document.getElementById('bankResults').style.display = 'block';
                showStatus('bankStatus', 'âœ… åˆçº¦ä½™é¢æŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('bankStatus', 'âŒ æŸ¥è¯¢åˆçº¦ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æŸ¥è¯¢Permit2æˆæƒ
        window.checkPermit2Allowance = async function() {
            if (!window.permit2Contract || !window.currentAccount) {
                showStatus('permit2Status', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }
            
            const tokenAddress = document.getElementById('tokenAddress').value;
            const bankAddress = document.getElementById('bankAddress').value;
            
            if (!tokenAddress || !bankAddress) {
                showStatus('permit2Status', 'âŒ è¯·è¾“å…¥Tokenå’ŒBankåœ°å€', 'error');
                return;
            }
            
            try {
                const [amount, expiration, nonce] = await window.permit2Contract.read.allowance([
                    window.currentAccount,
                    tokenAddress,
                    bankAddress
                ]);
                
                const results = `
                    æˆæƒæ•°é‡: ${formatEther(amount)}
                    è¿‡æœŸæ—¶é—´: ${expiration}
                    Nonce: ${nonce}
                `;
                
                document.getElementById('permit2Results').textContent = results;
                document.getElementById('permit2Results').style.display = 'block';
                showStatus('permit2Status', 'âœ… Permit2æˆæƒæŸ¥è¯¢æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('permit2Status', 'âŒ æŸ¥è¯¢Permit2æˆæƒå¤±è´¥: ' + error.message, 'error');
            }
        };

        // EIP-712 ç­¾åç”Ÿæˆå‡½æ•°
        window.generatePermit2Signature = async function(tokenAddress, amount, spender, deadline, nonce, permit2Address) {
            // EIP-712 åŸŸåˆ†éš”ç¬¦
            const domain = {
                name: 'Permit2',
                version: '1',
                chainId: await window.walletClient.getChainId(),
                verifyingContract: permit2Address
            };

            // EIP-712 ç±»å‹å®šä¹‰
            const types = {
                PermitSingle: [
                    { name: 'details', type: 'PermitDetails' },
                    { name: 'spender', type: 'address' },
                    { name: 'sigDeadline', type: 'uint256' }
                ],
                PermitDetails: [
                    { name: 'token', type: 'address' },
                    { name: 'amount', type: 'uint160' },
                    { name: 'expiration', type: 'uint48' },
                    { name: 'nonce', type: 'uint48' }
                ]
            };

            // ç»“æ„åŒ–æ•°æ®
            const value = {
                details: {
                    token: tokenAddress,
                    amount: amount,
                    expiration: deadline,
                    nonce: nonce
                },
                spender: spender,
                sigDeadline: deadline
            };

            // ç”Ÿæˆç­¾å
            const signature = await window.walletClient.signTypedData({
                account: window.currentAccount,
                domain,
                types,
                primaryType: 'PermitSingle',
                message: value
            });

            return { signature, permitSingle: value };
        };

        // Permit2å­˜æ¬¾åŠŸèƒ½
        window.depositWithPermit2 = async function() {
            const amount = document.getElementById('permit2Amount').value;
            if (!amount || amount <= 0) {
                showStatus('permit2Status', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾æ•°é‡', 'error');
                return;
            }

            if (!window.tokenContract || !window.currentAccount || !window.bankContract) {
                showStatus('permit2Status', 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–æ‰€æœ‰åˆçº¦', 'error');
                return;
            }

            try {
                showStatus('permit2Status', 'æ­£åœ¨ç”ŸæˆPermit2ç­¾å...', 'warning');
                
                // è·å–å¿…è¦çš„åœ°å€å’Œå‚æ•°
                const permit2Address = document.getElementById('permit2Address').value;
                const tokenAddress = document.getElementById('tokenAddress').value;
                const bankAddress = document.getElementById('bankAddress').value;
                
                if (!permit2Address || !tokenAddress || !bankAddress) {
                    showStatus('permit2Status', 'âŒ è¯·ç¡®ä¿æ‰€æœ‰åˆçº¦åœ°å€éƒ½å·²å¡«å†™', 'error');
                    return;
                }
                
                const amountWei = parseEther(amount);
                const deadline = Math.floor(Date.now() / 1000) + 3600; // 1å°æ—¶åè¿‡æœŸ
                
                // è·å–å½“å‰nonce
                console.log('Creating permit2Contract with:', {
                    address: permit2Address,
                    abi: window.PERMIT2_ABI,
                    publicClient: window.viemClient,
                    walletClient: window.walletClient
                });
                
                const permit2Contract = getContract({
                    address: permit2Address,
                    abi: window.PERMIT2_ABI,
                    client: { public: window.viemClient, wallet: window.walletClient }
                });
                
                console.log('permit2Contract created:', permit2Contract);
                console.log('permit2Contract.read:', permit2Contract.read);
                console.log('permit2Contract.read.nonces:', permit2Contract.read.nonces);
                
                const nonce = await permit2Contract.read.nonces([window.currentAccount, tokenAddress, bankAddress]);
                
                showStatus('permit2Status', 'æ­£åœ¨è¯·æ±‚ç”¨æˆ·ç­¾å...', 'warning');
                
                // ç”ŸæˆEIP-712ç­¾å
                const { signature, permitSingle } = await generatePermit2Signature(
                    tokenAddress,
                    amountWei,
                    bankAddress,
                    deadline,
                    nonce,
                    permit2Address
                );
                
                showStatus('permit2Status', 'æ­£åœ¨æ‰§è¡ŒPermit2å­˜æ¬¾...', 'warning');
                
                // è°ƒç”¨Bankåˆçº¦çš„depositWithPermit2æ–¹æ³•
                const hash = await window.bankContract.write.depositWithPermit2([
                    tokenAddress,
                    amountWei,
                    permitSingle,
                    signature
                ], {
                    account: window.currentAccount
                });
                
                showStatus('permit2Status', `âœ… Permit2å­˜æ¬¾æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${hash}`, 'success');
                
                // æ›´æ–°ä½™é¢æ˜¾ç¤º
                setTimeout(() => {
                    if (window.updateTokenBalance) window.updateTokenBalance();
                    if (window.updateBankBalance) window.updateBankBalance();
                }, 2000);
                
            } catch (error) {
                console.error('Permit2å­˜æ¬¾é”™è¯¯:', error);
                if (error.message.includes('User rejected')) {
                    showStatus('permit2Status', 'âŒ ç”¨æˆ·å–æ¶ˆäº†ç­¾å', 'error');
                } else {
                    showStatus('permit2Status', 'âŒ æ“ä½œå¤±è´¥: ' + error.message, 'error');
                }
            }
        };

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        window.showStatus = function(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status ' + type;
            element.style.display = 'block';
            
            // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            }
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        .step-card {
            position: relative;
            border-left: 4px solid #667eea;
        }
         
         .step-header {
             display: flex;
             align-items: center;
             margin-bottom: 15px;
         }
         
         .step-badge {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 6px 12px;
             border-radius: 20px;
             font-size: 12px;
             font-weight: bold;
             margin-right: 15px;
             text-transform: uppercase;
         }
         
         .step-header h3 {
             margin: 0;
             color: #333;
         }
         
         .step-description {
             color: #666;
             font-size: 14px;
             margin-bottom: 20px;
             line-height: 1.5;
             background: #f8f9fa;
             padding: 12px;
             border-radius: 6px;
             border-left: 3px solid #667eea;
         }
        
        .explanation-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 30px;
        }
        
        .explanation-card h3 {
            color: white;
            margin-bottom: 20px;
        }
        
        .architecture-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .flow-step {
            flex: 1;
            min-width: 200px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .flow-step h4 {
            margin: 10px 0;
            color: white;
        }
        
        .flow-step p {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .flow-arrow {
            font-size: 24px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            margin: 0 10px;
        }
        
        .usage-guide {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .usage-guide h4 {
            color: white;
            margin-bottom: 15px;
        }
        
        .usage-guide ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .usage-guide li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .architecture-flow {
                flex-direction: column;
            }
            
            .flow-arrow {
                transform: rotate(90deg);
                margin: 10px 0;
            }
        }
        
        .card h3 {
            color: #555;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 500;
        }
        
        .flex {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffeaa7, #fab1a0);
            color: #2d3436;
        }
        
        input[type="text"], input[type="number"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            flex: 1;
            min-width: 400px;
            width: 100%;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .result-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-line;
            color: #495057;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .info-value {
            font-family: 'Courier New', monospace;
            color: #6c757d;
            word-break: break-all;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .flex {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Permit2 æˆæƒå­˜æ¬¾æ¼”ç¤º</h1>
        
        <!-- ç³»ç»Ÿè¯´æ˜ -->
        <div class="card explanation-card">
            <h3>ğŸ“– ç³»ç»Ÿæ¶æ„è¯´æ˜</h3>
            <div class="architecture-flow">
                <div class="flow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>ğŸª™ ERC20 Token</h4>
                        <p>SUIä»£å¸åˆçº¦ï¼Œç”¨æˆ·éœ€è¦å…ˆè·å–ä»£å¸æ‰èƒ½è¿›è¡Œåç»­æ“ä½œ</p>
                    </div>
                </div>
                <div class="flow-arrow">â†’</div>
                <div class="flow-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>ğŸ” Permit2 åˆçº¦</h4>
                        <p>ç»Ÿä¸€æˆæƒç®¡ç†åˆçº¦ï¼Œç”¨æˆ·æˆæƒåå¯ä»¥å®‰å…¨åœ°è¿›è¡Œä»£å¸æ“ä½œ</p>
                    </div>
                </div>
                <div class="flow-arrow">â†’</div>
                <div class="flow-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>ğŸ¦ Bank åˆçº¦</h4>
                        <p>é“¶è¡Œåˆçº¦ï¼Œå¯ä»¥å­˜å‚¨ETHå’Œé€šè¿‡Permit2å®‰å…¨åœ°å¤„ç†ERC20ä»£å¸</p>
                    </div>
                </div>
            </div>
            <div class="usage-guide">
                <h4>ğŸš€ ä½¿ç”¨æµç¨‹ï¼š</h4>
                <ol>
                    <li><strong>è¿æ¥é’±åŒ…</strong> â†’ åˆå§‹åŒ–åˆçº¦</li>
                    <li><strong>è·å–æµ‹è¯•ä»£å¸</strong> â†’ ä»éƒ¨ç½²è€…åœ°å€è·å–SUIä»£å¸</li>
                    <li><strong>æˆæƒPermit2</strong> â†’ å…è®¸Permit2åˆçº¦ç®¡ç†ä½ çš„ä»£å¸</li>
                    <li><strong>ä½¿ç”¨BankåŠŸèƒ½</strong> â†’ å­˜å‚¨ETHæˆ–é€šè¿‡Permit2è¿›è¡Œä»£å¸æ“ä½œ</li>
                </ol>
            </div>
        </div>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="card">
            <h3>ğŸ“± è¿æ¥çŠ¶æ€</h3>
            <div class="flex">
                <button class="btn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
                <button class="btn btn-secondary" onclick="initContracts()">åˆå§‹åŒ–åˆçº¦</button>
            </div>
            
            <div class="info-row">
                <span class="info-label">å½“å‰è´¦æˆ·:</span>
                <span class="info-value" id="currentAccount">æœªè¿æ¥</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç½‘ç»œä¿¡æ¯:</span>
                <span class="info-value" id="networkInfo">æœªè¿æ¥</span>
            </div>
            
            <div class="input-group">
                <label>Bankåˆçº¦åœ°å€:</label>
                <input type="text" id="bankAddress" value="0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0" placeholder="Bankåˆçº¦åœ°å€">
            </div>
            <div class="input-group">
                <label>ERC20 Tokenåœ°å€:</label>
                <input type="text" id="tokenAddress" value="0x5FbDB2315678afecb367f032d93F642f64180aa3" placeholder="Tokenåˆçº¦åœ°å€">
            </div>
            <div class="input-group">
                <label>Permit2åˆçº¦åœ°å€:</label>
                <input type="text" id="permit2Address" value="0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512" placeholder="Permit2åˆçº¦åœ°å€">
            </div>
            <div id="connectionStatus" class="status"></div>
        </div>

        <!-- ç¬¬ä¸€æ­¥ï¼šERC20 Token æµ‹è¯• -->
        <div class="card step-card">
            <div class="step-header">
                <span class="step-badge">æ­¥éª¤ 1</span>
                <h3>ğŸª™ è·å– ERC20ä»£å¸</h3>
            </div>
            <p class="step-description">é¦–å…ˆéœ€è¦è·å–ä¸€äº›æµ‹è¯•ä»£å¸ï¼Œç„¶åå¯ä»¥æŸ¥çœ‹ä½™é¢å’Œè¿›è¡ŒåŸºæœ¬çš„è½¬è´¦æ“ä½œ</p>
            <div class="flex">
                <button class="btn" onclick="getTokenInfo()">è·å–Tokenä¿¡æ¯</button>
                <button class="btn" onclick="getMyTokenBalance()">æŸ¥è¯¢æˆ‘çš„ä½™é¢</button>
                <button class="btn btn-warning" onclick="mintTokens()">è·å–æµ‹è¯•ä»£å¸</button>
            </div>
            <div class="input-group" style="margin-top: 15px;">
                <label>è½¬è´¦åœ°å€:</label>
                <input type="text" id="transferTo" placeholder="æ¥æ”¶æ–¹åœ°å€">
            </div>
            <div class="flex">
                <input type="number" id="transferAmount" placeholder="è½¬è´¦æ•°é‡" step="0.001" min="0" style="flex: 1;">
                <button class="btn btn-success" onclick="transferToken()">è½¬è´¦</button>
            </div>
            <div id="tokenStatus" class="status"></div>
            <div id="tokenResults" class="result-box" style="display: none;"></div>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šPermit2 æˆæƒ -->
        <div class="card step-card">
            <div class="step-header">
                <span class="step-badge">æ­¥éª¤ 2</span>
                <h3>ğŸ” Permit2 æˆæƒç®¡ç†</h3>
            </div>
            <p class="step-description">æˆæƒPermit2åˆçº¦ç®¡ç†ä½ çš„ä»£å¸ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨æ›´å®‰å…¨çš„ç­¾åæ–¹å¼è¿›è¡Œæ“ä½œ</p>
            <div class="flex">
                <button class="btn btn-secondary" onclick="approveToken()">æˆæƒç»™Permit2</button>
                <button class="btn btn-success" onclick="depositWithPermit2()">Permit2ç­¾åå­˜æ¬¾</button>
            </div>
            <div class="flex" style="margin-top: 10px;">
                <input type="number" id="permit2Amount" placeholder="Permit2å­˜æ¬¾æ•°é‡" step="0.001" min="0" style="flex: 1;">
                <button class="btn" onclick="checkPermit2Allowance()" style="margin-left: 10px;">æŸ¥è¯¢Permit2æˆæƒ</button>
            </div>
            <div id="permit2Status" class="status"></div>
            <div id="permit2Results" class="result-box" style="display: none;"></div>
        </div>

        <!-- ç¬¬ä¸‰æ­¥ï¼šBank åˆçº¦æ“ä½œ -->
        <div class="card step-card">
            <div class="step-header">
                <span class="step-badge">æ­¥éª¤ 3</span>
                <h3>ğŸ¦ Bank åˆçº¦æ“ä½œ</h3>
            </div>
            <p class="step-description">ä½¿ç”¨Bankåˆçº¦å­˜å‚¨ETHå’ŒERC20ä»£å¸ï¼ŒæŸ¥çœ‹å­˜æ¬¾è®°å½•å’Œæ’è¡Œæ¦œ</p>
            
            <!-- ETH å­˜æ¬¾æ“ä½œ -->
            <div style="border: 2px solid #4CAF50; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <h4 style="color: #4CAF50; margin-top: 0;">ğŸ’° ETH å­˜æ¬¾æ“ä½œ</h4>
                <div class="flex">
                    <input type="number" id="depositAmount" placeholder="å­˜æ¬¾é‡‘é¢ (ETH)" step="0.001" min="0" style="flex: 1;">
                    <button class="btn" onclick="depositETH()">å­˜æ¬¾ETH</button>
                </div>
                <div class="flex" style="margin-top: 10px;">
                    <input type="number" id="withdrawAmount" placeholder="ææ¬¾é‡‘é¢ (ETH)" step="0.001" min="0" style="flex: 1;">
                    <button class="btn btn-secondary" onclick="withdrawETH()">ææ¬¾ETH</button>
                </div>
                <div class="flex" style="margin-top: 10px;">
                    <button class="btn" onclick="getMyETHDeposit()">æŸ¥è¯¢æˆ‘çš„ETHå­˜æ¬¾</button>
                    <button class="btn" onclick="getContractETHBalance()">æŸ¥è¯¢åˆçº¦ETHä½™é¢</button>
                </div>
            </div>

            <!-- ERC20 å­˜æ¬¾æ“ä½œ -->
            <div style="border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <h4 style="color: #2196F3; margin-top: 0;">ğŸª™ ERC20 ä»£å¸å­˜æ¬¾æ“ä½œ</h4>
                <div class="flex">
                    <input type="number" id="erc20DepositAmount" placeholder="å­˜æ¬¾æ•°é‡ (ERC20)" step="0.001" min="0" style="flex: 1;">
                    <button class="btn" onclick="depositERC20()">æ™®é€šå­˜æ¬¾ERC20</button>
                </div>
                <div class="flex" style="margin-top: 10px;">
                    <button class="btn" onclick="getMyERC20Deposit()">æŸ¥è¯¢æˆ‘çš„ERC20å­˜æ¬¾</button>
                    <button class="btn" onclick="getContractERC20Balance()">æŸ¥è¯¢åˆçº¦ERC20ä½™é¢</button>
                </div>
            </div>

            <!-- ç»¼åˆæŸ¥è¯¢ -->
            <div style="border: 2px solid #FF9800; border-radius: 8px; padding: 15px;">
                <h4 style="color: #FF9800; margin-top: 0;">ğŸ“Š ç»¼åˆæŸ¥è¯¢</h4>
                <div class="flex">
                    <button class="btn" onclick="getAllMyDeposits()">æŸ¥è¯¢æˆ‘çš„æ‰€æœ‰å­˜æ¬¾</button>
                    <button class="btn" onclick="getAllContractBalances()">æŸ¥è¯¢åˆçº¦æ‰€æœ‰ä½™é¢</button>
                    <button class="btn btn-success" onclick="getTopDepositors()">æŸ¥è¯¢æ’è¡Œæ¦œ</button>
                </div>
            </div>

            <div id="bankStatus" class="status"></div>
            <div id="bankResults" class="result-box" style="display: none;"></div>
        </div>
            <div id="permit2Status" class="status"></div>
            <div id="permit2Results" class="result-box" style="display: none;"></div>
        </div>
    </div>
</body>
</html>