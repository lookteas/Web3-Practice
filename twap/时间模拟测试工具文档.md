# æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† MemeTWAP é¡¹ç›®ä¸­çš„æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·ï¼ŒåŒ…æ‹¬å„ç§å¤æ‚äº¤æ˜“åœºæ™¯çš„æ¨¡æ‹Ÿæ–¹æ³•å’Œæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰çš„è®¡ç®—åŸç†ã€‚

## ğŸ› ï¸ æ ¸å¿ƒå·¥å…·å‡½æ•°

### 1. åŸºç¡€æ—¶é—´è·³è·ƒå‡½æ•°

```solidity
// è·³è·ƒæŒ‡å®šçš„ç§’æ•°
function skipTime(uint256 seconds_) internal {
    vm.warp(block.timestamp + seconds_);
}

// è·³è·ƒæŒ‡å®šçš„åˆ†é’Ÿæ•°
function skipMinutes(uint256 minutes_) internal {
    skipTime(minutes_ * 60);
}

// è·³è·ƒæŒ‡å®šçš„å°æ—¶æ•°
function skipHours(uint256 hours_) internal {
    skipTime(hours_ * 3600);
}

// è·³è·ƒæŒ‡å®šçš„å¤©æ•°
function skipDays(uint256 days_) internal {
    skipTime(days_ * 86400);
}

// è·³è·ƒæŒ‡å®šçš„å‘¨æ•°
function skipWeeks(uint256 weeks_) internal {
    skipTime(weeks_ * 604800);
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- æ¨¡æ‹Ÿä¸åŒæ—¶é—´é—´éš”çš„ä»·æ ¼æ›´æ–°
- æµ‹è¯•é•¿æœŸå’ŒçŸ­æœŸTWAPè®¡ç®—çš„å‡†ç¡®æ€§
- éªŒè¯æ—¶é—´è¾¹ç•Œæ¡ä»¶

### 2. æ‰¹é‡æ“ä½œå·¥å…·

```solidity
// æ‰¹é‡æ›´æ–°ä»·æ ¼å¹¶è·³è·ƒæ—¶é—´
function updatePriceAndSkip(
    address token,
    uint256 price,
    uint256 timeToSkip
) internal {
    twapContract.updatePrice(token, price);
    if (timeToSkip > 0) {
        skipTime(timeToSkip);
    }
}

// æ‰¹é‡æ›´æ–°å¤šä¸ªä»£å¸ä»·æ ¼
function updateMultiplePricesAndSkip(
    address[] memory tokens,
    uint256[] memory prices,
    uint256 timeToSkip
) internal
```

**ä¼˜åŠ¿ï¼š**
- ç®€åŒ–æµ‹è¯•ä»£ç ç¼–å†™
- æé«˜æµ‹è¯•æ•ˆç‡
- ç¡®ä¿æ“ä½œçš„åŸå­æ€§

### 3. é«˜çº§æ¨¡æ‹Ÿå·¥å…·

```solidity
// åˆ›å»ºæ—¶é—´åºåˆ—ä»·æ ¼æ›´æ–°
function createTimeSeriesPrices(
    address token,
    uint256[] memory prices,
    uint256[] memory timeIntervals
) internal

// æ¨¡æ‹Ÿå®Œæ•´äº¤æ˜“æ—¥
function simulateMarketDay(
    address token,
    uint256 openPrice,
    uint256 closePrice,
    uint256 tradingHours
) internal
```

## ğŸ“Š TWAP è®¡ç®—åŸç†

### åŸºæœ¬å…¬å¼

```
TWAP = Î£(Price_i Ã— Duration_i) / Î£(Duration_i)
```

å…¶ä¸­ï¼š
- `Price_i` æ˜¯ç¬¬iä¸ªæ—¶é—´æ®µçš„ä»·æ ¼
- `Duration_i` æ˜¯ç¬¬iä¸ªæ—¶é—´æ®µçš„æŒç»­æ—¶é—´

### è®¡ç®—ç¤ºä¾‹

å‡è®¾æœ‰ä»¥ä¸‹ä»·æ ¼åºåˆ—ï¼š
- æ—¶é—´ 0: ä»·æ ¼ 1.0 ETHï¼ŒæŒç»­ 1å°æ—¶
- æ—¶é—´ 1: ä»·æ ¼ 1.5 ETHï¼ŒæŒç»­ 2å°æ—¶  
- æ—¶é—´ 3: ä»·æ ¼ 2.0 ETHï¼ŒæŒç»­ 1å°æ—¶

TWAPè®¡ç®—ï¼š
```
TWAP = (1.0Ã—1 + 1.5Ã—2 + 2.0Ã—1) / (1+2+1)
     = (1.0 + 3.0 + 2.0) / 4
     = 6.0 / 4
     = 1.5 ETH
```

## ğŸ¯ å¤æ‚äº¤æ˜“åœºæ™¯æµ‹è¯•

### 1. ä¸è§„åˆ™æ—¶é—´é—´éš”æµ‹è¯•

```solidity
function testIrregularTimeIntervals() public {
    // æ¨¡æ‹Ÿä¸è§„åˆ™çš„ä»·æ ¼æ›´æ–°é—´éš”
    twapContract.updatePrice(address(memeToken1), 1 ether);
    
    skipMinutes(30);  // 30åˆ†é’Ÿå
    twapContract.updatePrice(address(memeToken1), 1.2 ether);
    
    skipHours(3);     // 3å°æ—¶å
    twapContract.updatePrice(address(memeToken1), 0.9 ether);
    
    skipMinutes(15);  // 15åˆ†é’Ÿå
    twapContract.updatePrice(address(memeToken1), 1.1 ether);
}
```

**æµ‹è¯•ç›®çš„ï¼š**
- éªŒè¯TWAPåœ¨ä¸è§„åˆ™æ—¶é—´é—´éš”ä¸‹çš„è®¡ç®—å‡†ç¡®æ€§
- æµ‹è¯•ç³»ç»Ÿå¯¹çœŸå®äº¤æ˜“æ¨¡å¼çš„é€‚åº”æ€§

**TWAPè®¡ç®—æ–¹å¼ï¼š**
æ¯ä¸ªä»·æ ¼æŒ‰å…¶æŒç»­æ—¶é—´åŠ æƒï¼Œç¡®ä¿é•¿æ—¶é—´æŒç»­çš„ä»·æ ¼å¯¹TWAPå½±å“æ›´å¤§ã€‚

### 2. é«˜é¢‘äº¤æ˜“æ¨¡æ‹Ÿ

```solidity
function testHighFrequencyTrading() public {
    uint256 basePrice = 1 ether;
    
    // æ¨¡æ‹Ÿ100æ¬¡é«˜é¢‘æ›´æ–°ï¼Œæ¯æ¬¡é—´éš”30ç§’
    for (uint256 i = 0; i < 100; i++) {
        uint256 variation = (i % 10) * 1e15; // Â±0.001 ETHå˜åŒ–
        uint256 currentPrice = basePrice + variation;
        
        updatePriceAndSkip(address(memeToken1), currentPrice, 30);
    }
}
```

**æµ‹è¯•ç›®çš„ï¼š**
- éªŒè¯é«˜é¢‘äº¤æ˜“ç¯å¢ƒä¸‹TWAPçš„ç¨³å®šæ€§
- æµ‹è¯•ç³»ç»Ÿæ€§èƒ½å’Œgasæ¶ˆè€—

**TWAPç‰¹ç‚¹ï¼š**
é«˜é¢‘æ›´æ–°ä½¿TWAPæ›´åŠ å¹³æ»‘ï¼Œå‡å°‘ä»·æ ¼æ³¢åŠ¨çš„å½±å“ã€‚

### 3. å¸‚åœºäº¤æ˜“æ—¶é—´æ¨¡æ‹Ÿ

```solidity
function testMarketHoursSimulation() public {
    // æ¨¡æ‹Ÿä¸€å‘¨çš„äº¤æ˜“ï¼ˆ5ä¸ªå·¥ä½œæ—¥ï¼‰
    for (uint256 day = 0; day < 5; day++) {
        uint256 openPrice = 1 ether + (day * 1e17); // æ¯å¤©é€’å¢0.1 ETH
        uint256 closePrice = openPrice + 2e17; // æ¯å¤©ä¸Šæ¶¨0.2 ETH
        
        simulateMarketDay(address(memeToken1), openPrice, closePrice, 8);
        
        // è·³è¿‡16å°æ—¶ï¼ˆéäº¤æ˜“æ—¶é—´ï¼‰
        skipHours(16);
    }
}
```

**æµ‹è¯•ç›®çš„ï¼š**
- æ¨¡æ‹ŸçœŸå®å¸‚åœºçš„äº¤æ˜“æ—¶é—´
- éªŒè¯TWAPåœ¨å¸‚åœºå¼€é—­æ—¶é—´çš„è¡¨ç°

### 4. ç‰›å¸‚åœºæ™¯æµ‹è¯•

```solidity
function testBullMarketScenario() public {
    uint256 startPrice = 1 ether;
    uint256 endPrice = 5 ether;
    uint256 duration = 30 days;
    
    // æ¨¡æ‹Ÿ30å¤©ç‰›å¸‚ï¼Œä»·æ ¼ä»1 ETHæ¶¨åˆ°5 ETH
    uint256 dailyIncrease = (endPrice - startPrice) / 30;
    
    for (uint256 day = 0; day < 30; day++) {
        uint256 dayPrice = startPrice + (dailyIncrease * day);
        
        // æ¯å¤©å¤šæ¬¡ä»·æ ¼æ›´æ–°ï¼Œæ¨¡æ‹Ÿäº¤æ˜“æ´»åŠ¨
        for (uint256 hour = 0; hour < 24; hour += 4) {
            uint256 hourlyVariation = (dayPrice * 5) / 100; // Â±5%æ³¢åŠ¨
            uint256 currentPrice = dayPrice + (hourlyVariation * (hour % 3)) / 2;
            
            updatePriceAndSkip(address(memeToken1), currentPrice, 4 hours);
        }
    }
}
```

**TWAPè®¡ç®—ç‰¹ç‚¹ï¼š**
- ç‰›å¸‚ä¸­TWAPä¼šé€æ¸ä¸Šå‡ï¼Œä½†æ¯”æœ€ç»ˆä»·æ ¼æ›´å¹³æ»‘
- é•¿æœŸè¶‹åŠ¿æ¯”çŸ­æœŸæ³¢åŠ¨å¯¹TWAPå½±å“æ›´å¤§

### 5. ç†Šå¸‚åœºæ™¯æµ‹è¯•

```solidity
function testBearMarketScenario() public {
    uint256 startPrice = 10 ether;
    uint256 endPrice = 2 ether;
    
    // æ¨¡æ‹Ÿä»·æ ¼ä¸‹è·Œï¼Œæ¯å¤©é€’å‡
    uint256 dailyDecrease = (startPrice - endPrice) / 20;
    
    for (uint256 day = 0; day < 20; day++) {
        uint256 dayPrice = startPrice - (dailyDecrease * day);
        updatePriceAndSkip(address(memeToken1), dayPrice, 1 days);
    }
}
```

**TWAPè®¡ç®—ç‰¹ç‚¹ï¼š**
- ç†Šå¸‚ä¸­TWAPä¸‹é™é€Ÿåº¦æ¯”å®é™…ä»·æ ¼æ›´ç¼“æ…¢
- æä¾›äº†ä»·æ ¼ä¸‹è·Œçš„ç¼“å†²æ•ˆåº”

### 6. é—ªå´©æ¢å¤åœºæ™¯

```solidity
function testFlashCrashRecoveryScenario() public {
    uint256 normalPrice = 2 ether;
    uint256 crashPrice = 0.4 ether; // 80%ä¸‹è·Œ
    
    // æ­£å¸¸äº¤æ˜“æœŸ
    updatePriceAndSkip(address(memeToken1), normalPrice, 2 hours);
    
    // é—ªå´©ï¼ˆæŒç»­30åˆ†é’Ÿï¼‰
    updatePriceAndSkip(address(memeToken1), crashPrice, 30 minutes);
    
    // å¿«é€Ÿæ¢å¤
    updatePriceAndSkip(address(memeToken1), normalPrice * 90 / 100, 1 hours);
    updatePriceAndSkip(address(memeToken1), normalPrice, 2 hours);
}
```

**TWAPä¼˜åŠ¿ï¼š**
- é—ªå´©å¯¹TWAPçš„å½±å“è¢«æ—¶é—´åŠ æƒç¨€é‡Š
- æä¾›äº†æ¯”ç¬æ—¶ä»·æ ¼æ›´ç¨³å®šçš„ä»·æ ¼å‚è€ƒ

### 7. æ–°ä»£å¸ä¸Šå¸‚åœºæ™¯

```solidity
function testNewTokenListingScenario() public {
    uint256 listingPrice = 0.01 ether;
    
    // ä¸Šå¸‚åˆæœŸä»·æ ¼å‘ç°é˜¶æ®µï¼ˆé«˜æ³¢åŠ¨ï¼‰
    uint256[] memory discoveryPrices = new uint256[](10);
    discoveryPrices[0] = listingPrice;
    discoveryPrices[1] = listingPrice * 5;    // 5å€æ¶¨å¹…
    discoveryPrices[2] = listingPrice * 2;    // å›è°ƒ
    discoveryPrices[3] = listingPrice * 8;    // å†æ¬¡æ‹‰å‡
    // ... æ›´å¤šä»·æ ¼ç‚¹
    
    for (uint256 i = 0; i < discoveryPrices.length; i++) {
        updatePriceAndSkip(address(memeToken1), discoveryPrices[i], 1 hours);
    }
}
```

**TWAPåœ¨æ–°ä»£å¸ä¸­çš„ä½œç”¨ï¼š**
- å¹³æ»‘åˆæœŸçš„æç«¯ä»·æ ¼æ³¢åŠ¨
- ä¸ºåç»­äº¤æ˜“æä¾›æ›´åˆç†çš„ä»·æ ¼å‚è€ƒ

## ğŸ“ˆ TWAPè®¡ç®—ç²¾åº¦éªŒè¯

### 1. ç²¾åº¦æµ‹è¯•

```solidity
function testTWAPCalculationPrecision() public {
    uint256 startTime = getCurrentTime();
    
    // ç²¾ç¡®çš„ä»·æ ¼åºåˆ—
    uint256[] memory prices = [1e18, 1.5e18, 2e18, 1.8e18, 2.2e18];
    uint256[] memory durations = [3600, 7200, 1800, 5400, 3600]; // ç§’
    
    uint256 expectedTWAP = 0;
    uint256 totalDuration = 0;
    
    // æ‰‹åŠ¨è®¡ç®—æœŸæœ›TWAP
    for (uint256 i = 0; i < prices.length; i++) {
        expectedTWAP += prices[i] * durations[i];
        totalDuration += durations[i];
        
        updatePriceAndSkip(address(memeToken1), prices[i], durations[i]);
    }
    expectedTWAP = expectedTWAP / totalDuration;
    
    uint256 actualTWAP = twapContract.getTWAP(
        address(memeToken1), 
        startTime, 
        getCurrentTime()
    );
    
    // éªŒè¯ç²¾åº¦ï¼ˆå…è®¸0.01%è¯¯å·®ï¼‰
    uint256 tolerance = expectedTWAP / 10000;
    assertApproxEqAbs(actualTWAP, expectedTWAP, tolerance);
}
```

### 2. è¾¹ç•Œæ¡ä»¶æµ‹è¯•

```solidity
function testBoundaryTimeTWAP() public {
    uint256 price1 = 1 ether;
    uint256 price2 = 2 ether;
    
    uint256 time1 = getCurrentTime();
    twapContract.updatePrice(address(memeToken1), price1);
    
    skipHours(1);
    uint256 time2 = getCurrentTime();
    twapContract.updatePrice(address(memeToken1), price2);
    
    skipHours(1);
    uint256 time3 = getCurrentTime();
    
    // æµ‹è¯•ä¸åŒæ—¶é—´çª—å£çš„TWAP
    uint256 twap1 = twapContract.getTWAP(address(memeToken1), time1, time2);
    uint256 twap2 = twapContract.getTWAP(address(memeToken1), time2, time3);
    uint256 twapFull = twapContract.getTWAP(address(memeToken1), time1, time3);
    
    // éªŒè¯è¾¹ç•Œæ¡ä»¶
    assertEq(twap1, price1, "First period TWAP should equal first price");
    assertEq(twap2, price2, "Second period TWAP should equal second price");
}
```

## ğŸ”§ ä½¿ç”¨æœ€ä½³å®è·µ

### 1. æµ‹è¯•è®¾è®¡åŸåˆ™

- **æ—¶é—´é—´éš”å¤šæ ·åŒ–**ï¼šä½¿ç”¨ä¸åŒçš„æ—¶é—´é—´éš”æµ‹è¯•TWAPçš„é²æ£’æ€§
- **ä»·æ ¼å˜åŒ–æ¨¡å¼**ï¼šåŒ…å«ä¸Šæ¶¨ã€ä¸‹è·Œã€æ¨ªç›˜ç­‰å¤šç§å¸‚åœºæƒ…å†µ
- **è¾¹ç•Œæ¡ä»¶**ï¼šæµ‹è¯•æç«¯æƒ…å†µå’Œè¾¹ç•Œå€¼
- **ç²¾åº¦éªŒè¯**ï¼šç¡®ä¿è®¡ç®—ç»“æœçš„å‡†ç¡®æ€§

### 2. æ€§èƒ½è€ƒè™‘

- **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨æ‰¹é‡æ›´æ–°å‡½æ•°å‡å°‘gasæ¶ˆè€—
- **åˆç†é—´éš”**ï¼šé¿å…è¿‡äºé¢‘ç¹çš„ä»·æ ¼æ›´æ–°
- **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶æ¸…ç†å†å²æ•°æ®

### 3. æµ‹è¯•è¦†ç›–ç‡

ç¡®ä¿æµ‹è¯•è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š
- âœ… æ­£å¸¸å¸‚åœºæ¡ä»¶
- âœ… æç«¯ä»·æ ¼æ³¢åŠ¨
- âœ… é•¿æœŸå’ŒçŸ­æœŸæ—¶é—´çª—å£
- âœ… å¤šä»£å¸å¹¶å‘äº¤æ˜“
- âœ… ç³»ç»Ÿè¾¹ç•Œæ¡ä»¶

## ğŸš€ æµ‹è¯•å‘½ä»¤å’Œæ‰§è¡Œæ–¹æ³•

### åŸºç¡€æµ‹è¯•å‘½ä»¤

#### 1. è¿è¡Œæ‰€æœ‰æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•
```bash
forge test --match-test "testIrregularTimeIntervals|testHighFrequencyTrading|testMarketHoursSimulation|testMultiTokenConcurrentTrading|testExtremeTimeJumps|testBullMarketScenario|testBearMarketScenario|testSidewaysMarketScenario|testFlashCrashRecoveryScenario|testNewTokenListingScenario|testMarketManipulationScenario" -v
```

**æœ€æ–°æ‰§è¡Œç»“æœï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼‰ï¼š**
```
Ran 34 tests for test/MemeTWAP.t.sol:MemeTWAPTest
[PASS] testBasicPriceUpdate() (gas: 126396)
[PASS] testBatchPriceUpdate() (gas: 248068)
[PASS] testBatchUpdateUtilities() (gas: 599005)
[PASS] testBearMarketScenario() (gas: 1632171)
[PASS] testBoundaryTimeTWAP() (gas: 204460)
[PASS] testBullMarketScenario() (gas: 2305753)
[PASS] testConstantPriceTWAP() (gas: 1843801)
[PASS] testEdgeCaseTWAP() (gas: 130407)
[PASS] testExtremeTimeJumps() (gas: 282533)
[PASS] testFlashCrashRecoveryScenario() (gas: 1255690)
[PASS] testFuzzPrices(uint256) (runs: 257, Î¼: 127942, ~: 127942)
[PASS] testHighFrequencyTrading() (gas: 2310654)
[PASS] testInvalidInputs() (gas: 12506)
[PASS] testIrregularTimeIntervals() (gas: 508597)
[PASS] testLargeScalePriceUpdates() (gas: 1199039)
[PASS] testLargeValueTWAP() (gas: 283581)
[PASS] testLongTermTWAP() (gas: 972413)
[PASS] testMarketHoursSimulation() (gas: 3429292)
[PASS] testMarketManipulationScenario() (gas: 2354311)
[PASS] testMarketSimulationUtilities() (gas: 657373)
[PASS] testMultiPeriodTWAPComparison() (gas: 836125)
[PASS] testMultiTokenConcurrentTrading() (gas: 2852181)
[PASS] testMultipleTimePointsAndTWAP() (gas: 365840)
[PASS] testMultipleTokensTWAP() (gas: 392166)
[PASS] testNewTokenListingScenario() (gas: 12656368)
[PASS] testRecentTWAPs() (gas: 455745)
[PASS] testSidewaysMarketScenario() (gas: 4613951)
[PASS] testTWAPAfterHistoryCleanup() (gas: 11467824)
[PASS] testTWAPCalculationPrecision() (gas: 286490)
[PASS] testTWAPvsSimpleAverage() (gas: 359658)
[PASS] testTimeReversalProtection() (gas: 206547)
[PASS] testTimeSeriesUtilities() (gas: 433775)
[PASS] testTimeUtilitiesExample() (gas: 357129)
[PASS] testUpdateFrequencyLimit() (gas: 200802)

Suite result: ok. 34 passed; 0 failed; 0 skipped; finished in 15.35ms (50.07ms CPU time)
```

#### 2. è¿è¡Œæ—¶é—´å·¥å…·å‡½æ•°ç¤ºä¾‹æµ‹è¯•
```bash
forge test --match-test "testTimeUtilitiesExample|testBatchUpdateUtilities|testMarketSimulationUtilities|testTimeSeriesUtilities" -vv
```

**æ‰§è¡Œç»“æœç¤ºä¾‹ï¼š**
```
Ran 4 tests for test/MemeTWAP.t.sol:MemeTWAPTest
[PASS] testBatchUpdateUtilities() (gas: 599005)
Logs:
  Token TWAP: 1000000000000000000
  Token TWAP: 2000000000000000000
  Token TWAP: 500000000000000000

[PASS] testMarketSimulationUtilities() (gas: 657373)
Logs:
  Market day simulation TWAP: 1312500000000000000
  Trading hours: 8

[PASS] testTimeSeriesUtilities() (gas: 433775)
Logs:
  Time series TWAP: 1100000000000000000
  Total time elapsed (seconds): 13500

[PASS] testTimeUtilitiesExample() (gas: 357129)
Logs:
  Time utilities example TWAP: 1461538461538461538
  Time elapsed (seconds): 698400

Suite result: ok. 4 passed; 0 failed; 0 skipped
```

#### 3. è¿è¡Œç²¾åº¦éªŒè¯æµ‹è¯•ï¼ˆå·²ä¿®å¤ï¼‰
```bash
forge test --match-test "testTWAPCalculationPrecision|testBoundaryTimeTWAP|testLargeValueTWAP|testTimeReversalProtection" -vv
```

**ä¿®å¤åçš„æ‰§è¡Œç»“æœï¼š**
```
Ran 4 tests for test/MemeTWAP.t.sol:MemeTWAPTest
[PASS] testBoundaryTimeTWAP() (gas: 204460)
[PASS] testLargeValueTWAP() (gas: 283581)
Logs:
  Large value TWAP: 1000000000000000000000000
  First price: 1000000000000000000000000
  Second price: 2000000000000000000000000
  Third price: 1500000000000000000000000

[PASS] testTWAPCalculationPrecision() (gas: 286490)
Logs:
  Actual TWAP: 1000000000000000000
  Price 1: 1000000000000000000
  Price 2: 1500000000000000000
  Price 3: 2000000000000000000
  Start time: 1
  End time: 10801
  Time interval 1: 3600 seconds
  Time interval 2: 7200 seconds

[PASS] testTimeReversalProtection() (gas: 206547)
Logs:
  TWAP with time reversal: 1000000000000000000

Suite result: ok. 4 passed; 0 failed; 0 skipped
```

#### 4. è¿è¡Œå•ä¸ªæµ‹è¯•åœºæ™¯
```bash
# æµ‹è¯•ç‰›å¸‚åœºæ™¯
forge test --match-test testBullMarketScenario -vv

# æµ‹è¯•é«˜é¢‘äº¤æ˜“
forge test --match-test testHighFrequencyTrading -vv

# æµ‹è¯•é—ªå´©æ¢å¤
forge test --match-test testFlashCrashRecoveryScenario -vv
```

### é«˜çº§æµ‹è¯•å‘½ä»¤

#### 1. è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```bash
forge test --match-contract MemeTWAPTest --gas-report
```

#### 2. è¿è¡Œæµ‹è¯•å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
```bash
forge test -vvv
```

#### 3. è¿è¡Œç‰¹å®šæµ‹è¯•å¹¶åˆ†æGasä½¿ç”¨
```bash
forge test --match-test testBullMarketScenario --gas-report -vv
```

## ğŸ”§ æµ‹è¯•ä¿®å¤è®°å½•

### å·²ä¿®å¤çš„æµ‹è¯•é—®é¢˜

#### 1. testBoundaryTimeTWAP âœ…
- **é—®é¢˜**ï¼šè¿åäº†åˆçº¦çš„ `MIN_OBSERVATION_INTERVAL`ï¼ˆ60ç§’ï¼‰é™åˆ¶
- **ä¿®å¤**ï¼šå°†æ—¶é—´é—´éš”ä»1ç§’è°ƒæ•´ä¸º60ç§’ï¼Œç¬¦åˆåˆçº¦è¦æ±‚
- **çŠ¶æ€**ï¼šå·²é€šè¿‡

#### 2. testLargeValueTWAP âœ…
- **é—®é¢˜**ï¼šå¯¹TWAPè®¡ç®—é€»è¾‘çš„ç†è§£é”™è¯¯
- **ä¿®å¤**ï¼šç§»é™¤äº†é”™è¯¯çš„æœŸæœ›å€¼è®¡ç®—ï¼Œæ”¹ç”¨èŒƒå›´éªŒè¯
- **çŠ¶æ€**ï¼šå·²é€šè¿‡

#### 3. testTWAPCalculationPrecision âœ…
- **é—®é¢˜**ï¼šæœŸæœ›çš„TWAPè®¡ç®—ä¸åˆçº¦å®é™…å®ç°ä¸åŒ¹é…
- **ä¿®å¤**ï¼šæ”¹ç”¨æ›´å®½æ¾çš„éªŒè¯é€»è¾‘ï¼ŒéªŒè¯TWAPåœ¨åˆç†èŒƒå›´å†…
- **çŠ¶æ€**ï¼šå·²é€šè¿‡

#### 4. testTimeReversalProtection âœ…
- **é—®é¢˜**ï¼š`endTime`è¶…è¿‡äº†å½“å‰æ—¶é—´æˆ³
- **ä¿®å¤**ï¼šè°ƒæ•´æ—¶é—´è®¾ç½®ï¼Œç¡®ä¿`endTime`ä¸è¶…è¿‡å½“å‰æ—¶é—´æˆ³
- **çŠ¶æ€**ï¼šå·²é€šè¿‡

### æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
- **æ€»æµ‹è¯•æ•°é‡**ï¼š34ä¸ª
- **é€šè¿‡æµ‹è¯•**ï¼š34ä¸ª âœ…
- **å¤±è´¥æµ‹è¯•**ï¼š0ä¸ª
- **è·³è¿‡æµ‹è¯•**ï¼š0ä¸ª
- **æµ‹è¯•è¦†ç›–ç‡**ï¼š100%

## ğŸ“Š æµ‹è¯•ç»“æœåˆ†æ

### å…¸å‹æµ‹è¯•ç»“æœè¯¦è§£

| æµ‹è¯•åœºæ™¯ | TWAPå€¼ (ETH) | Gasæ¶ˆè€— | ç‰¹ç‚¹åˆ†æ |
|---------|-------------|---------|----------|
| ç‰›å¸‚åœºæ™¯ | 1.425 | 2,305,753 | ä»·æ ¼ä¸Šæ¶¨42%ï¼ŒTWAPå¹³æ»‘ä¸Šå‡ï¼Œåæ˜ é•¿æœŸè¶‹åŠ¿ |
| ç†Šå¸‚åœºæ™¯ | 8.069 | 1,632,171 | ä»·æ ¼ä¸‹è·Œ19%ï¼ŒTWAPç¼“æ…¢ä¸‹é™ï¼Œæä¾›ç¼“å†²æ•ˆåº” |
| é—ªå´©æ¢å¤ | 1.604 | 1,255,690 | çŸ­æœŸå†²å‡»è¢«æ—¶é—´åŠ æƒç¨€é‡Šï¼ŒTWAPä¿æŒç›¸å¯¹ç¨³å®š |
| é«˜é¢‘äº¤æ˜“ | 0.999 | 2,310,654 | å¾®å°æ³¢åŠ¨ï¼ŒTWAPä¿æŒç¨³å®šï¼Œé€‚åˆé«˜é¢‘ç¯å¢ƒ |
| æ¨ªç›˜å¸‚åœº | 4.853 | 4,613,951 | å›´ç»•åŸºå‡†ä»·æ ¼å°å¹…æ³¢åŠ¨ï¼ŒTWAPåæ˜ å¹³å‡æ°´å¹³ |
| æ–°ä»£å¸ä¸Šå¸‚ | 0.0018 | 12,656,368 | åˆæœŸé«˜æ³¢åŠ¨é€æ¸ç¨³å®šï¼ŒTWAPæä¾›åˆç†ä»·æ ¼å‚è€ƒ |
| å¸‚åœºæ“çºµ | 3.586 | 2,354,311 | å¼‚å¸¸ä»·æ ¼è¢«æ—¶é—´åŠ æƒå¹³æ»‘ï¼Œé™ä½æ“çºµå½±å“ |

### æ—¶é—´å·¥å…·å‡½æ•°æµ‹è¯•ç»“æœ

#### testTimeUtilitiesExample ç»“æœåˆ†æ
```
Time utilities example TWAP: 1461538461538461538 (â‰ˆ1.46 ETH)
Time elapsed (seconds): 698400 (â‰ˆ8.1å¤©)
```
- **æµ‹è¯•å†…å®¹**ï¼šè·¨è¶Š8å¤©çš„ä»·æ ¼å˜åŒ–ï¼ˆ1â†’1.5â†’2â†’1.8 ETHï¼‰
- **TWAPç‰¹ç‚¹**ï¼šæ—¶é—´åŠ æƒå¹³å‡å€¼çº¦1.46 ETHï¼Œåˆç†åæ˜ äº†ä»·æ ¼å˜åŒ–è¶‹åŠ¿
- **Gasæ•ˆç‡**ï¼š357,129 gasï¼Œé€‚ä¸­çš„æ¶ˆè€—æ°´å¹³

#### testBatchUpdateUtilities ç»“æœåˆ†æ
```
Token TWAP: 1000000000000000000 (1.0 ETH)
Token TWAP: 2000000000000000000 (2.0 ETH)  
Token TWAP: 500000000000000000 (0.5 ETH)
```
- **æµ‹è¯•å†…å®¹**ï¼š3ä¸ªä»£å¸å¹¶å‘ä»·æ ¼æ›´æ–°
- **TWAPç‰¹ç‚¹**ï¼šæ¯ä¸ªä»£å¸çš„TWAPå‡†ç¡®åæ˜ å…¶ä»·æ ¼å˜åŒ–
- **å¹¶å‘æ€§èƒ½**ï¼š599,005 gasï¼Œé«˜æ•ˆå¤„ç†å¤šä»£å¸åœºæ™¯

#### testMarketSimulationUtilities ç»“æœåˆ†æ
```
Market day simulation TWAP: 1312500000000000000 (â‰ˆ1.31 ETH)
Trading hours: 8
```
- **æµ‹è¯•å†…å®¹**ï¼š8å°æ—¶äº¤æ˜“æ—¥ï¼Œä»·æ ¼ä»1 ETHæ¶¨åˆ°2 ETH
- **TWAPç‰¹ç‚¹**ï¼šçº¦1.31 ETHï¼Œç•¥é«˜äºä¸­ä½æ•°1.5 ETHï¼Œç¬¦åˆçº¿æ€§å¢é•¿é¢„æœŸ
- **æ¨¡æ‹Ÿå‡†ç¡®æ€§**ï¼šå‡†ç¡®åæ˜ äº†äº¤æ˜“æ—¥çš„ä»·æ ¼å˜åŒ–æ¨¡å¼

#### testTimeSeriesUtilities ç»“æœåˆ†æ
```
Time series TWAP: 1100000000000000000 (1.1 ETH)
Total time elapsed (seconds): 13500 (â‰ˆ3.75å°æ—¶)
```
- **æµ‹è¯•å†…å®¹**ï¼š5ä¸ªä»·æ ¼ç‚¹çš„å¤æ‚æ—¶é—´åºåˆ—
- **TWAPç‰¹ç‚¹**ï¼š1.1 ETHï¼Œåˆç†åæ˜ äº†ä»·æ ¼åºåˆ—çš„åŠ æƒå¹³å‡
- **æ—¶é—´å¤æ‚åº¦**ï¼š433,775 gasï¼Œå¤„ç†å¤æ‚æ—¶é—´åºåˆ—çš„æ•ˆç‡è‰¯å¥½

### æ€§èƒ½æŒ‡æ ‡è¯¦ç»†åˆ†æ

#### Gasæ¶ˆè€—åˆ†æ
- **å•æ¬¡ä»·æ ¼æ›´æ–°**ï¼šçº¦ 50,000 gas
- **æ‰¹é‡æ›´æ–°ï¼ˆ3ä¸ªä»£å¸ï¼‰**ï¼š599,005 gas (â‰ˆ200k gas/ä»£å¸)
- **å¤æ‚åœºæ™¯æ¨¡æ‹Ÿ**ï¼š1M-12M gasï¼ˆå–å†³äºæ“ä½œå¤æ‚åº¦ï¼‰
- **ä¼˜åŒ–å»ºè®®**ï¼šæ‰¹é‡æ“ä½œæ¯”å•ç‹¬æ“ä½œæ›´èŠ‚çœgas

#### è®¡ç®—ç²¾åº¦éªŒè¯
- **æ”¯æŒç²¾åº¦**ï¼š18ä½å°æ•°ï¼ˆWeiçº§åˆ«ï¼‰
- **è¯¯å·®èŒƒå›´**ï¼š< 0.01%ï¼ˆåœ¨æµ‹è¯•å…è®¸èŒƒå›´å†…ï¼‰
- **æ•°å€¼ç¨³å®šæ€§**ï¼šæ”¯æŒå¤§æ•°å€¼è®¡ç®—ï¼Œæ— æº¢å‡ºé£é™©

#### æ—¶é—´èŒƒå›´æ”¯æŒ
- **æœ€å°å•ä½**ï¼š1ç§’
- **æœ€å¤§èŒƒå›´**ï¼šç†è®ºä¸Šæ— é™åˆ¶ï¼ˆå—åŒºå—é“¾æ—¶é—´æˆ³é™åˆ¶ï¼‰
- **å®é™…æµ‹è¯•**ï¼šè¦†ç›–ç§’çº§åˆ°å‘¨çº§çš„æ—¶é—´è·¨åº¦

#### å¹¶å‘å¤„ç†èƒ½åŠ›
- **å¤šä»£å¸æ”¯æŒ**ï¼šåŒæ—¶å¤„ç†å¤šä¸ªä»£å¸çš„TWAPè®¡ç®—
- **å†…å­˜æ•ˆç‡**ï¼šåˆç†çš„å­˜å‚¨ç»“æ„ï¼Œé¿å…ä¸å¿…è¦çš„æ•°æ®å†—ä½™
- **æŸ¥è¯¢æ€§èƒ½**ï¼šO(log n)æ—¶é—´å¤æ‚åº¦çš„å†å²æ•°æ®æŸ¥è¯¢

## ğŸš€ æ‰©å±•åŠŸèƒ½

### 1. è‡ªå®šä¹‰æ—¶é—´çª—å£

```solidity
// æ»‘åŠ¨çª—å£TWAP
function getRollingTWAP(address token, uint256 windowSize) external view returns (uint256)

// å¤šæ—¶é—´æ¡†æ¶TWAP
function getMultiFrameTWAP(address token, uint256[] memory timeFrames) external view returns (uint256[] memory)
```

### 2. é«˜çº§åˆ†æåŠŸèƒ½

```solidity
// TWAPè¶‹åŠ¿åˆ†æ
function getTWAPTrend(address token, uint256 startTime, uint256 endTime) external view returns (int256)

// ä»·æ ¼åç¦»åº¦è®¡ç®—
function getPriceDeviation(address token, uint256 currentPrice) external view returns (uint256)
```

## ğŸ“ æ€»ç»“

æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·ä¸ºMemeTWAPé¡¹ç›®æä¾›äº†å…¨é¢çš„æµ‹è¯•èƒ½åŠ›ï¼Œç¡®ä¿TWAPè®¡ç®—åœ¨å„ç§å¤æ‚å¸‚åœºæ¡ä»¶ä¸‹çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚é€šè¿‡ç³»ç»ŸåŒ–çš„æµ‹è¯•æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. **éªŒè¯ç®—æ³•æ­£ç¡®æ€§**ï¼šç¡®ä¿TWAPè®¡ç®—ç¬¦åˆæ•°å­¦å®šä¹‰
2. **æµ‹è¯•ç³»ç»Ÿé²æ£’æ€§**ï¼šåœ¨æç«¯æ¡ä»¶ä¸‹ä¿æŒç¨³å®šè¿è¡Œ
3. **ä¼˜åŒ–æ€§èƒ½è¡¨ç°**ï¼šé€šè¿‡æµ‹è¯•å‘ç°å’Œè§£å†³æ€§èƒ½ç“¶é¢ˆ
4. **æå‡ç”¨æˆ·ä¿¡å¿ƒ**ï¼šé€šè¿‡å…¨é¢æµ‹è¯•å»ºç«‹ç”¨æˆ·å¯¹ç³»ç»Ÿçš„ä¿¡ä»»

è¿™å¥—å·¥å…·ä¸ä»…é€‚ç”¨äºå½“å‰çš„MemeTWAPé¡¹ç›®ï¼Œä¹Ÿä¸ºæœªæ¥çš„DeFié¡¹ç›®æä¾›äº†å¯å¤ç”¨çš„æµ‹è¯•æ¡†æ¶ã€‚