# MemeTWAP - æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼åˆçº¦

## ğŸ“– é¡¹ç›®ç®€ä»‹

MemeTWAP æ˜¯ä¸€ä¸ªä¸“é—¨ä¸º **[Meme](https://github.com/lookteas/Web3-Practice/tree/main/launchPad)** ä»£å¸æä¾›æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰è®¡ç®—æœåŠ¡ã€‚è¯¥åˆçº¦èƒ½å¤Ÿè·Ÿè¸ªå¤šä¸ªä»£å¸çš„ä»·æ ¼å†å²ï¼Œå¹¶æä¾›å‡†ç¡®çš„ TWAP è®¡ç®—åŠŸèƒ½ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

- **ä»·æ ¼æ›´æ–°**: æ”¯æŒå•ä¸ªå’Œæ‰¹é‡ä»·æ ¼æ›´æ–°
- **TWAPè®¡ç®—**: æä¾›ç²¾ç¡®çš„æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼è®¡ç®—
- **å†å²æ•°æ®**: ç»´æŠ¤å®Œæ•´çš„ä»·æ ¼å†å²è®°å½•
- **è®¿é—®æ§åˆ¶**: åŸºäºè§’è‰²çš„æƒé™ç®¡ç†
- **é¢‘ç‡é™åˆ¶**: é˜²æ­¢ä»·æ ¼æ“çºµçš„æ›´æ–°é¢‘ç‡æ§åˆ¶
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒå¤šä»£å¸æ‰¹é‡ä»·æ ¼æ›´æ–°

## ğŸ“Š TWAP å®ç°åŸç†å›¾è§£

ä¸ºäº†æ›´å¥½åœ°ç†è§£ TWAPï¼ˆæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼‰çš„å®ç°åŸç†ï¼Œè¯·å‚è€ƒä»¥ä¸‹è¯¦ç»†çš„å›¾è§£è¯´æ˜ï¼š

### 1. TWAP æ¦‚å¿µè§£é‡Š

![TWAPæ¦‚å¿µå›¾](./images/twap-concept.svg)

TWAPï¼ˆTime-Weighted Average Priceï¼‰æ˜¯ä¸€ç§è®¡ç®—èµ„äº§åœ¨ç‰¹å®šæ—¶é—´æ®µå†…å¹³å‡ä»·æ ¼çš„æ–¹æ³•ã€‚ä¸ç®€å•å¹³å‡ä»·æ ¼ä¸åŒï¼ŒTWAP è€ƒè™‘äº†æ¯ä¸ªä»·æ ¼ç‚¹æŒç»­çš„æ—¶é—´é•¿åº¦ï¼Œä¸ºæŒç»­æ—¶é—´æ›´é•¿çš„ä»·æ ¼èµ‹äºˆæ›´å¤§çš„æƒé‡ã€‚

**æ ¸å¿ƒå…¬å¼**ï¼š

```
TWAP = Î£(ä»·æ ¼i Ã— æŒç»­æ—¶é—´i) / æ€»æ—¶é—´
```

### 2. ä»·æ ¼æ›´æ–°æµç¨‹

![ä»·æ ¼æ›´æ–°æµç¨‹å›¾](./images/price-update-flow.svg)

ä»·æ ¼æ›´æ–°æ˜¯ TWAP ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š

1. **æƒé™éªŒè¯**ï¼šç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥æ›´æ–°ä»·æ ¼
2. **é¢‘ç‡æ£€æŸ¥**ï¼šé˜²æ­¢è¿‡äºé¢‘ç¹çš„ä»·æ ¼æ›´æ–°
3. **æ•°æ®éªŒè¯**ï¼šéªŒè¯ä»·æ ¼æ•°æ®çš„æœ‰æ•ˆæ€§
4. **å­˜å‚¨æ›´æ–°**ï¼šå°†æ–°ä»·æ ¼ç‚¹æ·»åŠ åˆ°å†å²è®°å½•
5. **äº‹ä»¶å‘å‡º**ï¼šé€šçŸ¥å¤–éƒ¨ç³»ç»Ÿä»·æ ¼å·²æ›´æ–°

### 3. TWAP è®¡ç®—è¿‡ç¨‹

![TWAPè®¡ç®—è¿‡ç¨‹å›¾](./images/twap-calculation.svg)

TWAP è®¡ç®—æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œæ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼š

1. **æ•°æ®æ”¶é›†**ï¼šè·å–æŒ‡å®šæ—¶é—´æ®µå†…çš„æ‰€æœ‰ä»·æ ¼ç‚¹
2. **æ—¶é—´åˆ†æ®µ**ï¼šè®¡ç®—æ¯ä¸ªä»·æ ¼ç‚¹çš„æŒç»­æ—¶é—´
3. **åŠ æƒè®¡ç®—**ï¼šæ ¹æ®æŒç»­æ—¶é—´è®¡ç®—åŠ æƒä»·æ ¼
4. **ç»“æœæ±‡æ€»**ï¼šå¾—å‡ºæœ€ç»ˆçš„ TWAP å€¼

**å®é™…è®¡ç®—ç¤ºä¾‹**ï¼š
- ä»·æ ¼ $100 æŒç»­ 2 å°æ—¶ = $200 å°æ—¶
- ä»·æ ¼ $120 æŒç»­ 1 å°æ—¶ = $120 å°æ—¶  
- ä»·æ ¼ $110 æŒç»­ 1 å°æ—¶ = $110 å°æ—¶
- TWAP = ($200 + $120 + $110) Ã· 4 å°æ—¶ = $107.5

### 4. åˆçº¦æ¶æ„å›¾

![åˆçº¦æ¶æ„å›¾](./images/contract-architecture.svg)

åˆçº¦æ¶æ„å±•ç¤ºäº† MemeTWAP ç³»ç»Ÿçš„å®Œæ•´ç»“æ„ï¼š

- **ä¸»åˆçº¦**ï¼šMemeTWAP.sol åŒ…å«æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- **ç»§æ‰¿å…³ç³»**ï¼šç»§æ‰¿ OpenZeppelin çš„ Ownable æä¾›è®¿é—®æ§åˆ¶
- **æ•°æ®å­˜å‚¨**ï¼šä½¿ç”¨æ˜ å°„å­˜å‚¨ä»·æ ¼å†å²å’Œç›¸å…³æ•°æ®
- **å¤–éƒ¨äº¤äº’**ï¼šæ”¯æŒå¤šç§å¤–éƒ¨ç³»ç»Ÿçš„è°ƒç”¨
- **äº‹ä»¶ç³»ç»Ÿ**ï¼šå®Œæ•´çš„äº‹ä»¶è®°å½•æœºåˆ¶

## ğŸ—ï¸ åˆçº¦æ¶æ„

### æ ¸å¿ƒåˆçº¦

- **MemeTWAP.sol**: ä¸»åˆçº¦ï¼Œå®ç°æ‰€æœ‰TWAPç›¸å…³åŠŸèƒ½
- **DeployTWAP.s.sol**: éƒ¨ç½²è„šæœ¬

### ä¸»è¦ç»„ä»¶

```solidity
struct PricePoint {
    uint256 price;      // ä»·æ ¼
    uint256 timestamp;  // æ—¶é—´æˆ³
}

struct TWAPData {
    uint256 twap;       // TWAPå€¼
    uint256 startTime;  // å¼€å§‹æ—¶é—´
    uint256 endTime;    // ç»“æŸæ—¶é—´
    uint256 dataPoints; // æ•°æ®ç‚¹æ•°é‡
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 16.0.0
- Foundry
- Git

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd twap

# å®‰è£… Foundry ä¾èµ–
forge install

# å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.example .env
```

### é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
# ç§é’¥ï¼ˆç”¨æœ¬åœ°äºéƒ¨ç½²ï¼‰
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80  ï¼ˆæœ¬åœ°æµ‹è¯•é’±åŒ…ï¼Œç”Ÿäº§ç¯å¢ƒè¯·å‹¿å¡«å†™ï¼‰

# RPC URL
RPC_URL=http://localhost:8545

# Etherscan API Keyï¼ˆå¯é€‰ï¼‰
ETHERSCAN_API_KEY=your_etherscan_api_key

# åˆçº¦åœ°å€
MEME_FACTORY_ADDRESS=0x1234567890123456789012345678901234567890
```

## ğŸ”§ å¼€å‘æŒ‡å—

### ç¼–è¯‘åˆçº¦

```bash
forge build
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
forge test

# è¿è¡Œè¯¦ç»†æµ‹è¯•
forge test -vv

# è¿è¡Œç‰¹å®šæµ‹è¯•
forge test --match-test testBasicPriceUpdate
```

### éƒ¨ç½²åˆçº¦

#### æœ¬åœ°éƒ¨ç½²

1. å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹ï¼š
```bash
anvil
```

2. éƒ¨ç½²åˆçº¦ï¼š
```bash
forge script script/DeployTWAP.s.sol --rpc-url http://localhost:8545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast
```

#### æµ‹è¯•ç½‘éƒ¨ç½²

```bash
forge script script/DeployTWAP.s.sol --rpc-url $RPC_URL --private-key $PRIVATE_KEY --broadcast --verify
```

## ğŸ“‹ API æ–‡æ¡£

### ä¸»è¦å‡½æ•°

#### ä»·æ ¼æ›´æ–°

```solidity
// æ›´æ–°å•ä¸ªä»£å¸ä»·æ ¼
function updatePrice(address token, uint256 price) external onlyUpdater

// æ‰¹é‡æ›´æ–°ä»·æ ¼
function batchUpdatePrices(address[] calldata tokens, uint256[] calldata prices) external onlyUpdater
```

#### TWAPè®¡ç®—

```solidity
// è®¡ç®—æŒ‡å®šæ—¶é—´æ®µçš„TWAP
function calculateTWAP(address token, uint256 startTime, uint256 endTime) external view returns (uint256)

// è·å–æœ€è¿‘çš„TWAPæ•°æ®
function getRecentTWAPs(address token, uint256 periods, uint256 periodDuration) external view returns (TWAPData[] memory)
```

#### æ•°æ®æŸ¥è¯¢

```solidity
// è·å–å½“å‰ä»·æ ¼
function getCurrentPrice(address token) external view returns (uint256)

// è·å–ä»·æ ¼å†å²
function getPriceHistory(address token, uint256 limit) external view returns (PricePoint[] memory)
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

é¡¹ç›®åŒ…å«å…¨é¢çš„æµ‹è¯•å¥—ä»¶ï¼Œè¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š

- âœ… åŸºæœ¬ä»·æ ¼æ›´æ–°
- âœ… æ‰¹é‡ä»·æ ¼æ›´æ–°  
- âœ… TWAPè®¡ç®—å‡†ç¡®æ€§
- âœ… è¾¹ç•Œæ¡ä»¶å¤„ç†
- âœ… è®¿é—®æ§åˆ¶éªŒè¯
- âœ… é¢‘ç‡é™åˆ¶æµ‹è¯•
- âœ… å¤§è§„æ¨¡æ•°æ®å¤„ç†
- âœ… é•¿æœŸTWAPè®¡ç®—
- âœ… å¤šä»£å¸æ”¯æŒ
- âœ… æ¨¡ç³Šæµ‹è¯•
- âœ… æ— æ•ˆè¾“å…¥å¤„ç†

### æµ‹è¯•ç»“æœ

```
Ran 11 tests for test/MemeTWAP.t.sol:MemeTWAPTest
[PASS] testBasicPriceUpdate() (gas: 126438)
[PASS] testBatchPriceUpdate() (gas: 248024)
[PASS] testEdgeCaseTWAP() (gas: 130363)
[PASS] testFuzzPrices(uint256) (runs: 257, Î¼: 127942, ~: 127942)
[PASS] testInvalidInputs() (gas: 12462)
[PASS] testLargeScalePriceUpdates() (gas: 1199016)
[PASS] testLongTermTWAP() (gas: 972413)
[PASS] testMultipleTimePointsAndTWAP() (gas: 365840)
[PASS] testMultipleTokensTWAP() (gas: 392099)
[PASS] testRecentTWAPs() (gas: 455722)
[PASS] testUpdateFrequencyLimit() (gas: 200757)

Suite result: ok. 11 passed; 0 failed; 0 skipped
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
twap/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ MemeTWAP.sol          # ä¸»åˆçº¦
â”œâ”€â”€ test/
â”‚   â””â”€â”€ MemeTWAP.t.sol        # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ script/
â”‚   â””â”€â”€ DeployTWAP.s.sol      # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ lib/                      # ä¾èµ–åº“
â”œâ”€â”€ broadcast/                # éƒ¨ç½²è®°å½•
â”œâ”€â”€ deployments/              # éƒ¨ç½²ä¿¡æ¯
â”œâ”€â”€ foundry.toml             # Foundryé…ç½®
â”œâ”€â”€ .env.example             # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ README.md                # é¡¹ç›®æ–‡æ¡£
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **è®¿é—®æ§åˆ¶**: ä½¿ç”¨ OpenZeppelin çš„ Ownable æ¨¡å¼
- **é¢‘ç‡é™åˆ¶**: é˜²æ­¢ä»·æ ¼æ“çºµæ”»å‡»
- **è¾“å…¥éªŒè¯**: ä¸¥æ ¼çš„å‚æ•°éªŒè¯
- **æº¢å‡ºä¿æŠ¤**: ä½¿ç”¨ Solidity 0.8+ å†…ç½®ä¿æŠ¤
- **é‡å…¥ä¿æŠ¤**: åˆç†çš„çŠ¶æ€ç®¡ç†



## ğŸ§ª æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·

æœ¬é¡¹ç›®åŒ…å«äº†å®Œæ•´çš„æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·,è¯¦æƒ…è§[**æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·æ–‡æ¡£**](./æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·æ–‡æ¡£.md)ï¼Œç”¨äºéªŒè¯å„ç§å¤æ‚äº¤æ˜“åœºæ™¯ä¸‹çš„TWAPè®¡ç®—å‡†ç¡®æ€§ã€‚

### ğŸ“‹ æµ‹è¯•å·¥å…·åŠŸèƒ½

- **åŸºç¡€æ—¶é—´è·³è·ƒ**ï¼šæ”¯æŒç§’ã€åˆ†é’Ÿã€å°æ—¶ã€å¤©ã€å‘¨çš„æ—¶é—´è·³è·ƒ
- **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒå¤šä»£å¸å¹¶å‘ä»·æ ¼æ›´æ–°å’Œæ—¶é—´æ¨¡æ‹Ÿ
- **å¤æ‚åœºæ™¯æ¨¡æ‹Ÿ**ï¼šç‰›å¸‚ã€ç†Šå¸‚ã€é—ªå´©ã€é«˜é¢‘äº¤æ˜“ç­‰11ç§å¸‚åœºåœºæ™¯
- **ç²¾åº¦éªŒè¯**ï¼šç¡®ä¿TWAPè®¡ç®—çš„æ•°å­¦å‡†ç¡®æ€§

### ğŸ¯ æ”¯æŒçš„æµ‹è¯•åœºæ™¯

| æµ‹è¯•ç±»å‹ | åœºæ™¯æè¿° | éªŒè¯ç›®æ ‡ |
|---------|---------|----------|
| æ—¶é—´é—´éš”æµ‹è¯• | ä¸è§„åˆ™é—´éš”ã€é«˜é¢‘äº¤æ˜“ã€å¸‚åœºæ—¶é—´ | æ—¶é—´åŠ æƒè®¡ç®—å‡†ç¡®æ€§ |
| å¸‚åœºåœºæ™¯æµ‹è¯• | ç‰›å¸‚ã€ç†Šå¸‚ã€æ¨ªç›˜ã€é—ªå´©æ¢å¤ | ä¸åŒå¸‚åœºæ¡ä»¶ä¸‹çš„TWAPè¡¨ç° |
| è¾¹ç•Œæ¡ä»¶æµ‹è¯• | æç«¯æ—¶é—´è·³è·ƒã€å¤§æ•°å€¼å¤„ç† | ç³»ç»Ÿé²æ£’æ€§å’Œç¨³å®šæ€§ |
| ç²¾åº¦éªŒè¯æµ‹è¯• | æ•°å­¦è®¡ç®—éªŒè¯ã€å¤šæ—¶é—´æ¡†æ¶å¯¹æ¯” | ç®—æ³•æ­£ç¡®æ€§å’Œç²¾åº¦ |

### ğŸ“– è¯¦ç»†æ–‡æ¡£

å®Œæ•´çš„æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒï¼š[**æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·æ–‡æ¡£**](./æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•å·¥å…·æ–‡æ¡£.md)

æ–‡æ¡£åŒ…å«ï¼š
- ğŸ› ï¸ æ ¸å¿ƒå·¥å…·å‡½æ•°è¯¦è§£
- ğŸ“Š TWAPè®¡ç®—åŸç†å’Œå…¬å¼
- ğŸ¯ 11ç§å¤æ‚äº¤æ˜“åœºæ™¯çš„å®ç°æ–¹æ³•
- ğŸ“ˆ ç²¾åº¦éªŒè¯å’Œæ€§èƒ½åˆ†æ
- ğŸš€ æ‰©å±•åŠŸèƒ½å’Œæœ€ä½³å®è·µ

### ğŸƒâ€â™‚ï¸ å¿«é€Ÿå¼€å§‹æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æ—¶é—´æ¨¡æ‹Ÿæµ‹è¯•
forge test --match-test "testIrregular|testHighFrequency|testMarketHours|testBull|testBear" -vv

# è¿è¡Œæ—¶é—´å·¥å…·å‡½æ•°ç¤ºä¾‹
forge test --match-test "testTimeUtilitiesExample|testBatchUpdateUtilities" -vv

# è¿è¡Œç²¾åº¦éªŒè¯æµ‹è¯•
forge test --match-test "testTWAPCalculationPrecision|testBoundaryTimeTWAP" -vv
```



## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ”— ç›¸å…³é“¾æ¥

- [Foundry æ–‡æ¡£](https://book.getfoundry.sh/)
- [OpenZeppelin åˆçº¦](https://docs.openzeppelin.com/contracts/)
- [Solidity æ–‡æ¡£](https://docs.soliditylang.org/)

*æœ¬é¡¹ç›®éµå¾ª MIT å¼€æºåè®®ï¼Œæ¬¢è¿è´¡çŒ®ä»£ç å’Œæå‡ºæ”¹è¿›å»ºè®®ï¼*

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶ç›®çš„ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†çš„å®‰å…¨å®¡è®¡ã€‚