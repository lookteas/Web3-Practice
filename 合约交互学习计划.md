# 合约交互功能学习计划 📚

## 🎯 学习目标
- 掌握 Web3 前端开发核心技能
- 熟练使用 ethers.js/web3.js 进行合约交互
- 能够独立开发完整的 DApp 应用
- 了解安全最佳实践和性能优化

---

## 📅 第1周：基础环境搭建和工具熟悉

### 🎯 本周目标
建立完整的开发环境，熟悉区块链开发工具链

### 📋 学习任务

#### 第1天：开发环境配置
- [ ] **安装 Node.js 和包管理器**
  ```bash
  # 下载并安装 Node.js 18+ 版本
  # 验证安装
  node --version
  npm --version
  
  # 全局安装常用工具
  npm install -g yarn
  npm install -g @hardhat-runner/hardhat
  ```

- [ ] **配置 VS Code 开发环境**
  ```json
  // 推荐安装的插件
  {
    "recommendations": [
      "JuanBlanco.solidity",
      "esbenp.prettier-vscode",
      "ms-vscode.vscode-json",
      "bradlc.vscode-tailwindcss"
    ]
  }
  ```
  
  **具体操作步骤：**
  1. 打开 VS Code
  2. 按 `Ctrl+Shift+X` 打开扩展面板
  3. 搜索并安装 "Solidity" 插件
  4. 搜索并安装 "Prettier - Code formatter" 插件
  5. 在设置中启用 "Format On Save"

#### 第2天：开发框架选择和配置

##### 🔧 Hardhat 框架搭建
- [ ] **初始化 Hardhat 项目**
  ```bash
  # 在您的项目目录创建新文件夹
  cd d:\code\web3\Web3-Practice
  mkdir contract-interaction-practice
  cd contract-interaction-practice
  
  # 初始化 Hardhat 项目
  npx hardhat init
  # 选择 "Create a JavaScript project"
  # 选择默认设置
  
  # 安装依赖
  npm install --save-dev @nomicfoundation/hardhat-toolbox
  npm install ethers
  ```

- [ ] **配置 hardhat.config.js**
  ```javascript
  require("@nomicfoundation/hardhat-toolbox");
  
  module.exports = {
    solidity: "0.8.19",
    networks: {
      sepolia: {
        url: "https://sepolia.infura.io/v3/YOUR_INFURA_KEY",
        accounts: ["YOUR_PRIVATE_KEY"] // 测试账户私钥
      },
      localhost: {
        url: "http://127.0.0.1:8545"
      }
    }
  };
  ```

##### ⚡ Foundry 框架搭建（推荐）
- [ ] **安装 Foundry**
  ```bash
  # Windows 用户安装 Foundry
  # 方法1：使用 foundryup（推荐）
  curl -L https://foundry.paradigm.xyz | bash
  foundryup
  
  # 方法2：使用预编译二进制文件
  # 下载 foundry 二进制文件到 PATH 目录
  
  # 验证安装
  forge --version
  cast --version
  anvil --version
  ```

- [ ] **初始化 Foundry 项目**
  ```bash
  # 创建新的 Foundry 项目
  cd d:\code\web3\Web3-Practice
  mkdir foundry-practice
  cd foundry-practice
  
  # 初始化项目
  forge init
  
  # 项目结构
  # ├── foundry.toml     # 配置文件
  # ├── src/             # 合约源码
  # ├── test/            # 测试文件
  # ├── script/          # 部署脚本
  # └── lib/             # 依赖库
  ```

- [ ] **配置 foundry.toml**
  ```toml
  [profile.default]
  src = "src"
  out = "out"
  libs = ["lib"]
  solc_version = "0.8.19"
  optimizer = true
  optimizer_runs = 200
  via_ir = false
  
  # RPC 端点配置
  [rpc_endpoints]
  sepolia = "https://sepolia.infura.io/v3/YOUR_INFURA_KEY"
  mainnet = "https://mainnet.infura.io/v3/YOUR_INFURA_KEY"
  localhost = "http://127.0.0.1:8545"
  
  # Etherscan API 配置
  [etherscan]
  sepolia = { key = "YOUR_ETHERSCAN_API_KEY" }
  mainnet = { key = "YOUR_ETHERSCAN_API_KEY" }
  ```

- [ ] **Foundry vs Hardhat 对比**
  ```markdown
  ## Foundry 优势
  ✅ 极快的编译和测试速度（Rust 编写）
  ✅ 内置模糊测试（Fuzz Testing）
  ✅ 强大的调试工具（forge debug）
  ✅ 原生 Solidity 测试（无需 JavaScript）
  ✅ 内置 Gas 快照和优化分析
  ✅ 强大的 cast 命令行工具
  
  ## Hardhat 优势
  ✅ 更成熟的生态系统
  ✅ 丰富的插件支持
  ✅ JavaScript/TypeScript 集成
  ✅ 更好的 IDE 支持
  ✅ 学习资源更多
  
  ## 建议
  🎯 新手学习：先用 Hardhat，生态完善
  🎯 高级开发：使用 Foundry，性能更好
  🎯 最佳实践：两者结合使用
  ```

#### 第3天：MetaMask 钱包配置
- [ ] **安装和基础配置**
  
  1. 访问 [MetaMask官网](https://metamask.io/) 下载浏览器插件
  2. 创建新钱包（记住助记词！）
  3. 设置强密码
  4. 备份助记词到安全位置
  
- [ ] **添加测试网络**
  
  ```javascript
  // Sepolia 测试网配置
  网络名称: Sepolia Test Network
  RPC URL: https://sepolia.infura.io/v3/
  链ID: 11155111
  货币符号: ETH
  区块浏览器: https://sepolia.etherscan.io
  ```
  
  **操作步骤：**
  1. 点击 MetaMask 顶部网络下拉菜单
  2. 选择 "添加网络"
  3. 填入上述配置信息
  4. 点击 "保存"

#### 第4天：获取测试 ETH
- [ ] **使用水龙头获取测试币**
  ```bash
  # 推荐的 Sepolia 水龙头
  https://sepoliafaucet.com/
  https://www.alchemy.com/faucets/ethereum-sepolia
  https://sepolia-faucet.pk910.de/
  ```
  
  **具体操作：**
  1. 复制您的 MetaMask 钱包地址
  2. 访问水龙头网站
  3. 粘贴地址并请求测试 ETH
  4. 等待交易确认（通常1-2分钟）
  5. 在 MetaMask 中查看余额

#### 第5天：区块链浏览器使用
- [ ] **Etherscan 基础操作**
  1. 访问 [Sepolia Etherscan](https://sepolia.etherscan.io)
  2. 搜索您的钱包地址
  3. 查看交易历史
  4. 理解交易详情页面各项信息

- [ ] **Gas 费用理解**
  ```javascript
  // Gas 相关概念
  Gas Limit: 交易允许消耗的最大 Gas 数量
  Gas Price: 每单位 Gas 的价格 (Gwei)
  Transaction Fee = Gas Used × Gas Price
  
  // 常见操作的 Gas 消耗
  ETH 转账: ~21,000 Gas
  ERC20 转账: ~65,000 Gas
  合约部署: 200,000+ Gas
  ```

#### 第6-7天：实践项目 - 部署 Bank 合约

##### 🔧 使用 Hardhat 部署
- [ ] **准备合约文件**
  ```bash
  # 复制您现有的 Bank.sol 到 Hardhat 项目
  cp ../bankContract/Bank.sol contracts/
  ```

- [ ] **编写部署脚本**
  ```javascript
  // scripts/deploy-bank.js
  const hre = require("hardhat");
  
  async function main() {
    console.log("开始部署 Bank 合约...");
    
    // 获取合约工厂
    const Bank = await hre.ethers.getContractFactory("Bank");
    
    // 部署合约
    const bank = await Bank.deploy();
    await bank.waitForDeployment();
    
    const address = await bank.getAddress();
    console.log(`Bank 合约已部署到: ${address}`);
    
    // 验证部署
    const balance = await bank.getContractBalance();
    console.log(`合约初始余额: ${hre.ethers.formatEther(balance)} ETH`);
  }
  
  main().catch((error) => {
    console.error(error);
    process.exitCode = 1;
  });
  ```

- [ ] **执行 Hardhat 部署**
  ```bash
  # 编译合约
  npx hardhat compile
  
  # 部署到本地网络
  npx hardhat node  # 新终端运行
  npx hardhat run scripts/deploy-bank.js --network localhost
  
  # 部署到测试网
  npx hardhat run scripts/deploy-bank.js --network sepolia
  ```

##### ⚡ 使用 Foundry 部署（推荐）
- [ ] **准备合约文件**
  ```bash
  # 复制您现有的 Bank.sol 到 Foundry 项目
  cp ../bankContract/Bank.sol src/
  ```

- [ ] **编写 Foundry 部署脚本**
  ```solidity
  // script/DeployBank.s.sol
  // SPDX-License-Identifier: MIT
  pragma solidity ^0.8.19;
  
  import "forge-std/Script.sol";
  import "../src/Bank.sol";
  
  contract DeployBank is Script {
      function run() external {
          // 获取部署者私钥
          uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
          
          // 开始广播交易
          vm.startBroadcast(deployerPrivateKey);
          
          // 部署 Bank 合约
          Bank bank = new Bank();
          
          console.log("Bank 合约已部署到:", address(bank));
          console.log("部署者地址:", vm.addr(deployerPrivateKey));
          console.log("合约管理员:", bank.admin());
          
          vm.stopBroadcast();
      }
  }
  ```

- [ ] **编写测试文件**
  ```solidity
  // test/Bank.t.sol
  // SPDX-License-Identifier: MIT
  pragma solidity ^0.8.19;
  
  import "forge-std/Test.sol";
  import "../src/Bank.sol";
  
  contract BankTest is Test {
      Bank public bank;
      address public admin;
      address public user1;
      address public user2;
      
      function setUp() public {
          admin = address(this);
          user1 = makeAddr("user1");
          user2 = makeAddr("user2");
          
          bank = new Bank();
          
          // 给测试用户一些 ETH
          vm.deal(user1, 10 ether);
          vm.deal(user2, 10 ether);
      }
      
      function testDeposit() public {
          vm.prank(user1);
          bank.deposit{value: 1 ether}();
          
          assertEq(bank.deposits(user1), 1 ether);
          assertEq(address(bank).balance, 1 ether);
      }
      
      function testWithdraw() public {
          // 先存款
          vm.prank(user1);
          bank.deposit{value: 2 ether}();
          
          // 管理员提取
          uint256 balanceBefore = admin.balance;
          bank.withdraw(1 ether);
          
          assertEq(admin.balance - balanceBefore, 1 ether);
          assertEq(address(bank).balance, 1 ether);
      }
      
      function testTopDepositors() public {
          // 多个用户存款
          vm.prank(user1);
          bank.deposit{value: 3 ether}();
          
          vm.prank(user2);
          bank.deposit{value: 5 ether}();
          
          address[] memory topDepositors = bank.getTopDepositors();
          assertEq(topDepositors[0], user2); // 最高存款者
          assertEq(topDepositors[1], user1);
      }
  }
  ```

- [ ] **执行 Foundry 部署**
  
  ```bash
  # 编译合约
  forge build
  
  # 运行测试
  forge test -vv
  
  # 运行特定测试
  forge test --match-test testDeposit -vv
  
  # 生成 Gas 报告
  forge test --gas-report
  
  # 部署到本地网络
  anvil  # 新终端运行本地节点
  
  # 设置环境变量
  export PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
  
  # 部署到本地
  forge script script/DeployBank.s.sol --rpc-url http://localhost:8545 --broadcast
  
  # 部署到测试网
  forge script script/DeployBank.s.sol --rpc-url sepolia --broadcast --verify
  ```
  
- [ ] **Foundry 高级功能**
  ```bash
  # 模糊测试
  forge test --match-test testFuzz -vv
  
  # 调试交易
  forge debug --debug <transaction_hash>
  
  # 合约验证
  forge verify-contract <contract_address> src/Bank.sol:Bank --chain sepolia
  
  # Gas 快照
  forge snapshot
  
  # 使用 cast 与合约交互
  cast call <contract_address> "getContractBalance()" --rpc-url sepolia
  cast send <contract_address> "deposit()" --value 1ether --private-key $PRIVATE_KEY --rpc-url sepolia
  ```

### 🛠️ 每日检查清单
- [ ] **第1天**: Node.js 环境 + VS Code 配置完成
- [ ] **第2天**: Hardhat 和 Foundry 项目初始化成功
- [ ] **第3天**: MetaMask 安装并连接测试网
- [ ] **第4天**: 获得测试 ETH（至少 0.1 ETH）
- [ ] **第5天**: 能熟练使用 Etherscan 查看交易
- [ ] **第6-7天**: 成功使用 Hardhat 或 Foundry 部署 Bank 合约到测试网

### 📖 学习资源
- [Node.js 官网](https://nodejs.org/)
- [Hardhat 文档](https://hardhat.org/docs)
- [Foundry 官方文档](https://book.getfoundry.sh/)
- [Foundry GitHub](https://github.com/foundry-rs/foundry)
- [MetaMask 官方文档](https://docs.metamask.io/)
- [Sepolia 测试网信息](https://sepolia.dev/)

---

## 📅 第2周：Web3.js/Ethers.js 基础

### 🎯 本周目标
掌握 Web3 库的基本使用，能够连接钱包和读取合约数据

### 📋 学习任务

#### 第1天：Web3 库选择和基础概念
- [ ] **理解 Web3 库的作用**
  ```javascript
  // Web3 库的核心功能
  1. 连接以太坊网络 (Provider)
  2. 管理用户账户 (Signer)
  3. 与智能合约交互 (Contract)
  4. 处理交易和事件 (Transaction/Event)
  ```

- [ ] **Ethers.js vs Web3.js 对比**
  ```javascript
  // Ethers.js 特点
  - 模块化设计，体积更小
  - TypeScript 原生支持
  - 更现代的 Promise/async 语法
  - 更好的错误处理
  
  // Web3.js 特点  
  - 历史更悠久，社区更大
  - 文档和教程更多
  - 与 Truffle 集成更好
  ```

- [ ] **安装和初始化 Ethers.js**
  ```bash
  # 在您的前端项目中安装
  cd d:\code\web3\Web3-Practice\bankContract
  npm init -y
  npm install ethers
  ```

#### 第2天：Provider 和网络连接
- [ ] **理解 Provider 概念**
  
  ```javascript
  // Provider 是连接区块链的桥梁
  // 常见的 Provider 类型：
  
  // 1. MetaMask Provider (浏览器钱包)
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  
  // 2. JSON-RPC Provider (直连节点)
  const provider = new ethers.providers.JsonRpcProvider("https://sepolia.infura.io/v3/YOUR_KEY");
  
  // 3. Alchemy Provider (第三方服务)
  const provider = new ethers.providers.AlchemyProvider("sepolia", "YOUR_API_KEY");
  ```
  
- [ ] **创建基础连接文件**
  ```javascript
  // js/web3-connection.js
  class Web3Connection {
    constructor() {
      this.provider = null;
      this.signer = null;
      this.userAddress = null;
    }
  
    // 检测 MetaMask
    async detectMetaMask() {
      if (typeof window.ethereum !== 'undefined') {
        console.log('MetaMask 已安装!');
        return true;
      } else {
        console.log('请安装 MetaMask!');
        return false;
      }
    }
  
    // 连接钱包
    async connectWallet() {
      try {
        if (!await this.detectMetaMask()) return false;
        
        // 请求连接
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        
        // 创建 provider 和 signer
        this.provider = new ethers.providers.Web3Provider(window.ethereum);
        this.signer = this.provider.getSigner();
        this.userAddress = await this.signer.getAddress();
        
        console.log('钱包连接成功:', this.userAddress);
        return true;
      } catch (error) {
        console.error('连接钱包失败:', error);
        return false;
      }
    }
  
    // 获取网络信息
    async getNetworkInfo() {
      if (!this.provider) return null;
      
      const network = await this.provider.getNetwork();
      return {
        name: network.name,
        chainId: network.chainId,
        ensAddress: network.ensAddress
      };
    }
  
    // 获取余额
    async getBalance(address = null) {
      if (!this.provider) return null;
      
      const targetAddress = address || this.userAddress;
      const balance = await this.provider.getBalance(targetAddress);
      return ethers.utils.formatEther(balance);
    }
  }
  
  // 导出实例
  const web3Connection = new Web3Connection();
  ```

#### 第3天：钱包连接界面实现
- [ ] **创建现代化的连接界面**
  ```html
  <!-- 更新 index.html -->
  <!DOCTYPE html>
  <html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>银行合约 DApp</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- 连接状态显示 -->
      <div id="connectionStatus" class="mb-6 p-4 rounded-lg border">
        <div id="disconnected" class="text-center">
          <h2 class="text-xl font-bold mb-4">连接您的钱包</h2>
          <button id="connectBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            连接 MetaMask
          </button>
        </div>
        
        <div id="connected" class="hidden">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-600">已连接地址:</p>
              <p id="userAddress" class="font-mono text-sm"></p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">余额:</p>
              <p id="userBalance" class="font-bold"></p>
            </div>
          </div>
          <div class="mt-2">
            <p class="text-sm text-gray-600">网络: <span id="networkName"></span></p>
          </div>
        </div>
      </div>
  
      <!-- 合约交互区域 -->
      <div id="contractSection" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-bold mb-4">银行合约交互</h3>
          <!-- 合约内容将在后续添加 -->
        </div>
      </div>
    </div>
  
    <script src="js/web3-connection.js"></script>
    <script src="js/app.js"></script>
  </body>
  </html>
  ```

- [ ] **实现交互逻辑**
  ```javascript
  // js/app.js
  class BankDApp {
    constructor() {
      this.web3 = web3Connection;
      this.init();
    }
  
    async init() {
      this.bindEvents();
      await this.checkConnection();
    }
  
    bindEvents() {
      document.getElementById('connectBtn').addEventListener('click', () => {
        this.connectWallet();
      });
  
      // 监听账户变化
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            this.handleDisconnect();
          } else {
            this.handleAccountChange();
          }
        });
  
        // 监听网络变化
        window.ethereum.on('chainChanged', (chainId) => {
          window.location.reload();
        });
      }
    }
  
    async checkConnection() {
      if (window.ethereum && window.ethereum.selectedAddress) {
        await this.connectWallet();
      }
    }
  
    async connectWallet() {
      const connected = await this.web3.connectWallet();
      if (connected) {
        await this.updateUI();
        this.showConnectedState();
      }
    }
  
    async updateUI() {
      // 更新地址显示
      document.getElementById('userAddress').textContent = this.web3.userAddress;
      
      // 更新余额
      const balance = await this.web3.getBalance();
      document.getElementById('userBalance').textContent = `${parseFloat(balance).toFixed(4)} ETH`;
      
      // 更新网络信息
      const network = await this.web3.getNetworkInfo();
      document.getElementById('networkName').textContent = network.name;
    }
  
    showConnectedState() {
      document.getElementById('disconnected').classList.add('hidden');
      document.getElementById('connected').classList.remove('hidden');
      document.getElementById('contractSection').classList.remove('hidden');
    }
  
    handleDisconnect() {
      document.getElementById('disconnected').classList.remove('hidden');
      document.getElementById('connected').classList.add('hidden');
      document.getElementById('contractSection').classList.add('hidden');
    }
  
    async handleAccountChange() {
      await this.web3.connectWallet();
      await this.updateUI();
    }
  }
  
  // 初始化应用
  document.addEventListener('DOMContentLoaded', () => {
    new BankDApp();
  });
  ```

#### 第4天：合约实例化和 ABI 处理
- [ ] **理解 ABI (Application Binary Interface)**
  ```javascript
  // ABI 是合约的接口描述
  // 包含函数签名、参数类型、返回值等信息
  
  // 获取 ABI 的方法：
  // 1. 从 Hardhat 编译输出获取
  // 2. 从 Etherscan 验证合约页面复制
  // 3. 手动编写（不推荐）
  ```

- [ ] **创建合约 ABI 文件**
  ```javascript
  // js/bank-abi.js
  const BANK_ABI = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "depositor",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Deposit",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "deposit",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getContractBalance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "user",
          "type": "address"
        }
      ],
      "name": "getDeposit",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ];
  
  // 合约地址 (部署后获得)
  const BANK_CONTRACT_ADDRESS = "0x..."; // 替换为实际地址
  ```

- [ ] **实现合约交互类**
  ```javascript
  // js/bank-contract.js
  class BankContract {
    constructor(web3Connection) {
      this.web3 = web3Connection;
      this.contract = null;
      this.contractAddress = BANK_CONTRACT_ADDRESS;
    }
  
    // 初始化合约实例
    async init() {
      if (!this.web3.provider) {
        throw new Error('请先连接钱包');
      }
  
      // 创建只读合约实例 (用于查询)
      this.contract = new ethers.Contract(
        this.contractAddress,
        BANK_ABI,
        this.web3.provider
      );
  
      console.log('合约实例创建成功');
    }
  
    // 获取可写合约实例 (用于交易)
    getWritableContract() {
      if (!this.web3.signer) {
        throw new Error('请先连接钱包');
      }
  
      return new ethers.Contract(
        this.contractAddress,
        BANK_ABI,
        this.web3.signer
      );
    }
  
    // 读取合约总余额
    async getContractBalance() {
      try {
        const balance = await this.contract.getContractBalance();
        return ethers.utils.formatEther(balance);
      } catch (error) {
        console.error('获取合约余额失败:', error);
        throw error;
      }
    }
  
    // 读取用户存款
    async getUserDeposit(address = null) {
      try {
        const userAddress = address || this.web3.userAddress;
        const deposit = await this.contract.getDeposit(userAddress);
        return ethers.utils.formatEther(deposit);
      } catch (error) {
        console.error('获取用户存款失败:', error);
        throw error;
      }
    }
  
    // 存款操作
    async deposit(amount) {
      try {
        const writableContract = this.getWritableContract();
        const tx = await writableContract.deposit({
          value: ethers.utils.parseEther(amount.toString())
        });
        
        console.log('存款交易已发送:', tx.hash);
        return tx;
      } catch (error) {
        console.error('存款失败:', error);
        throw error;
      }
    }
  }
  ```

#### 第5天：读取合约数据实现
- [ ] **完善合约数据显示**
  ```javascript
  // 在 BankDApp 类中添加合约相关方法
  class BankDApp {
    constructor() {
      this.web3 = web3Connection;
      this.bankContract = null;
      this.init();
    }
  
    async init() {
      this.bindEvents();
      await this.checkConnection();
    }
  
    async connectWallet() {
      const connected = await this.web3.connectWallet();
      if (connected) {
        // 初始化合约
        this.bankContract = new BankContract(this.web3);
        await this.bankContract.init();
        
        await this.updateUI();
        await this.updateContractData();
        this.showConnectedState();
      }
    }
  
    async updateContractData() {
      try {
        // 更新合约余额
        const contractBalance = await this.bankContract.getContractBalance();
        document.getElementById('contractBalance').textContent = `${parseFloat(contractBalance).toFixed(4)} ETH`;
        
        // 更新用户存款
        const userDeposit = await this.bankContract.getUserDeposit();
        document.getElementById('userDeposit').textContent = `${parseFloat(userDeposit).toFixed(4)} ETH`;
        
      } catch (error) {
        console.error('更新合约数据失败:', error);
      }
    }
  
    // 设置定时刷新
    startDataRefresh() {
      setInterval(async () => {
        if (this.bankContract) {
          await this.updateContractData();
        }
      }, 10000); // 每10秒刷新一次
    }
  }
  ```

#### 第6-7天：完整的读取界面实现
- [ ] **完善 HTML 界面**
  ```html
  <!-- 在 contractSection 中添加数据显示 -->
  <div id="contractSection" class="hidden">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-lg font-bold mb-4">合约信息</h3>
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-blue-50 p-4 rounded">
          <p class="text-sm text-gray-600">合约总余额</p>
          <p id="contractBalance" class="text-xl font-bold text-blue-600">0 ETH</p>
        </div>
        <div class="bg-green-50 p-4 rounded">
          <p class="text-sm text-gray-600">我的存款</p>
          <p id="userDeposit" class="text-xl font-bold text-green-600">0 ETH</p>
        </div>
      </div>
      <button id="refreshBtn" class="mt-4 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
        刷新数据
      </button>
    </div>
  </div>
  ```

### 🛠️ 每日检查清单
- [ ] **第1天**: 理解 Web3 库概念，完成 Ethers.js 安装
- [ ] **第2天**: 掌握 Provider 概念，创建连接类
- [ ] **第3天**: 实现钱包连接界面和基础交互
- [ ] **第4天**: 理解 ABI，创建合约实例
- [ ] **第5天**: 实现合约数据读取功能
- [ ] **第6-7天**: 完善界面，测试所有读取功能

### 📖 学习资源
- [Ethers.js 官方文档](https://docs.ethers.io/v5/)
- [MetaMask 开发者文档](https://docs.metamask.io/guide/)
- [以太坊 JSON-RPC API](https://ethereum.org/en/developers/docs/apis/json-rpc/)

---

## 📅 第3周：改进现有银行合约前端

### 🎯 本周目标
全面升级现有的银行合约前端界面和交互体验

### 📋 学习任务

#### 第1天：UI/UX 设计规划
- [ ] **分析现有界面问题**
  ```javascript
  // 当前界面存在的问题：
  1. 界面过于简陋，缺乏现代感
  2. 没有响应式设计
  3. 缺乏加载状态提示
  4. 错误处理不够友好
  5. 缺乏交互反馈
  ```

- [ ] **设计新界面结构**
  ```html
  <!-- 新界面结构规划 -->
  <div class="app-container">
    <!-- 头部导航 -->
    <header class="navbar">
      <div class="logo">Bank DApp</div>
      <div class="wallet-info">钱包连接状态</div>
    </header>
    
    <!-- 主要内容区 -->
    <main class="main-content">
      <!-- 统计卡片区 -->
      <section class="stats-cards">
        <div class="card">合约余额</div>
        <div class="card">我的存款</div>
        <div class="card">存款次数</div>
        <div class="card">排行榜位置</div>
      </section>
      
      <!-- 操作区域 -->
      <section class="actions">
        <div class="deposit-form">存款表单</div>
        <div class="withdraw-form">提款表单(管理员)</div>
      </section>
      
      <!-- 数据展示区 -->
      <section class="data-display">
        <div class="transaction-history">交易历史</div>
        <div class="leaderboard">排行榜</div>
      </section>
    </main>
  </div>
  ```

- [ ] **选择 CSS 框架**
  ```bash
  # 推荐使用 Tailwind CSS
  # CDN 方式（快速开始）
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  # 或者使用 Bootstrap
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  ```

#### 第2天：响应式布局实现
- [ ] **创建新的 HTML 结构**
  ```html
  <!DOCTYPE html>
  <html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>银行合约 DApp - 现代化界面</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <i class="fas fa-university text-2xl text-blue-600 mr-3"></i>
            <h1 class="text-xl font-bold text-gray-800">Bank DApp</h1>
          </div>
          
          <!-- 钱包连接状态 -->
          <div id="walletStatus">
            <button id="connectWalletBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
              <i class="fas fa-wallet mr-2"></i>连接钱包
            </button>
            
            <div id="walletConnected" class="hidden flex items-center space-x-4">
              <div class="text-right">
                <p class="text-sm text-gray-600">余额</p>
                <p id="walletBalance" class="font-bold">0 ETH</p>
              </div>
              <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-white"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  
    <!-- 主要内容 -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <!-- 加载状态 -->
      <div id="loadingScreen" class="text-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">正在连接区块链...</p>
      </div>
  
      <!-- 应用主界面 -->
      <div id="appContent" class="hidden">
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-blue-100">
                <i class="fas fa-coins text-blue-600 text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">合约总余额</p>
                <p id="contractBalance" class="text-2xl font-bold text-gray-900">0 ETH</p>
              </div>
            </div>
          </div>
  
          <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-green-100">
                <i class="fas fa-piggy-bank text-green-600 text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">我的存款</p>
                <p id="userDeposit" class="text-2xl font-bold text-gray-900">0 ETH</p>
              </div>
            </div>
          </div>
  
          <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-purple-100">
                <i class="fas fa-chart-line text-purple-600 text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">存款次数</p>
                <p id="depositCount" class="text-2xl font-bold text-gray-900">0</p>
              </div>
            </div>
          </div>
  
          <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-yellow-100">
                <i class="fas fa-trophy text-yellow-600 text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">排行榜</p>
                <p id="userRank" class="text-2xl font-bold text-gray-900">-</p>
              </div>
            </div>
          </div>
        </div>
  
        <!-- 操作区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <!-- 存款表单 -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
              <i class="fas fa-plus-circle text-green-600 mr-2"></i>存款
            </h3>
            <form id="depositForm">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">存款金额 (ETH)</label>
                <div class="relative">
                  <input type="number" id="depositAmount" step="0.001" min="0.001" 
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                         placeholder="请输入存款金额">
                  <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                    <span class="text-gray-500 text-sm">ETH</span>
                  </div>
                </div>
              </div>
              <button type="submit" id="depositBtn" 
                      class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                <i class="fas fa-paper-plane mr-2"></i>确认存款
              </button>
            </form>
          </div>
  
          <!-- 管理员提款 -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
              <i class="fas fa-minus-circle text-red-600 mr-2"></i>管理员提款
            </h3>
            <div id="adminSection" class="hidden">
              <form id="withdrawForm">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">提款金额 (ETH)</label>
                  <input type="number" id="withdrawAmount" step="0.001" min="0.001"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                         placeholder="请输入提款金额">
                </div>
                <button type="submit" id="withdrawBtn"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                  <i class="fas fa-money-bill-wave mr-2"></i>确认提款
                </button>
              </form>
            </div>
            <div id="notAdmin" class="text-center py-8">
              <i class="fas fa-lock text-gray-400 text-3xl mb-4"></i>
              <p class="text-gray-500">仅管理员可操作</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  
    <!-- 通知组件 -->
    <div id="notifications" class="fixed top-4 right-4 z-50"></div>
  
    <!-- 模态框 -->
    <div id="transactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 m-4 max-w-md w-full">
        <div class="text-center">
          <div id="modalSpinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <h3 id="modalTitle" class="text-lg font-bold mb-2">处理交易中...</h3>
          <p id="modalMessage" class="text-gray-600 mb-4">请在钱包中确认交易</p>
          <div id="modalActions" class="hidden">
            <button id="modalClose" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>
  
    <script src="js/web3-connection.js"></script>
    <script src="js/bank-abi.js"></script>
    <script src="js/bank-contract.js"></script>
    <script src="js/ui-components.js"></script>
    <script src="js/app.js"></script>
  </body>
  </html>
  ```

#### 第3天：交互组件开发
- [ ] **创建 UI 组件类**
  ```javascript
  // js/ui-components.js
  class UIComponents {
    // 显示通知
    static showNotification(message, type = 'info', duration = 5000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type} transform transition-all duration-300 translate-x-full`;
      
      const bgColor = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500',
        'info': 'bg-blue-500'
      }[type];
      
      notification.innerHTML = `
        <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-lg mb-4 flex items-center">
          <i class="fas fa-${this.getIcon(type)} mr-3"></i>
          <span>${message}</span>
          <button class="ml-auto text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.getElementById('notifications').appendChild(notification);
      
      // 动画显示
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      // 自动隐藏
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
      }, duration);
    }
    
    static getIcon(type) {
      const icons = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
      };
      return icons[type] || 'info-circle';
    }
    
    // 显示加载模态框
    static showTransactionModal(title, message) {
      const modal = document.getElementById('transactionModal');
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      document.getElementById('modalSpinner').classList.remove('hidden');
      document.getElementById('modalActions').classList.add('hidden');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    // 更新模态框状态
    static updateTransactionModal(title, message, showActions = false) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      
      if (showActions) {
        document.getElementById('modalSpinner').classList.add('hidden');
        document.getElementById('modalActions').classList.remove('hidden');
      }
    }
    
    // 隐藏模态框
    static hideTransactionModal() {
      const modal = document.getElementById('transactionModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // 更新统计卡片
    static updateStatsCard(cardId, value, animated = true) {
      const element = document.getElementById(cardId);
      if (animated) {
        element.classList.add('animate-pulse');
        setTimeout(() => {
          element.textContent = value;
          element.classList.remove('animate-pulse');
        }, 200);
      } else {
        element.textContent = value;
      }
    }
    
    // 设置按钮加载状态
    static setButtonLoading(buttonId, loading = true) {
      const button = document.getElementById(buttonId);
      const originalText = button.dataset.originalText || button.innerHTML;
      
      if (loading) {
        button.dataset.originalText = originalText;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
        button.disabled = true;
      } else {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }
    
    // 表单验证
    static validateForm(formId) {
      const form = document.getElementById(formId);
      const inputs = form.querySelectorAll('input[required]');
      let isValid = true;
      
      inputs.forEach(input => {
        if (!input.value.trim()) {
          this.showFieldError(input, '此字段为必填项');
          isValid = false;
        } else {
          this.clearFieldError(input);
        }
      });
      
      return isValid;
    }
    
    static showFieldError(input, message) {
      input.classList.add('border-red-500');
      let errorElement = input.parentNode.querySelector('.field-error');
      if (!errorElement) {
        errorElement = document.createElement('p');
        errorElement.className = 'field-error text-red-500 text-sm mt-1';
        input.parentNode.appendChild(errorElement);
      }
      errorElement.textContent = message;
    }
    
    static clearFieldError(input) {
      input.classList.remove('border-red-500');
      const errorElement = input.parentNode.querySelector('.field-error');
      if (errorElement) {
        errorElement.remove();
      }
    }
  }
  
  // 绑定模态框关闭事件
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('modalClose').addEventListener('click', () => {
      UIComponents.hideTransactionModal();
    });
  });
  ```

#### 第4天：实时数据更新机制
- [ ] **实现数据刷新管理器**
  ```javascript
  // js/data-manager.js
  class DataManager {
    constructor(bankContract, web3Connection) {
      this.bankContract = bankContract;
      this.web3 = web3Connection;
      this.refreshInterval = null;
      this.refreshRate = 15000; // 15秒刷新一次
      this.isRefreshing = false;
    }
    
    // 开始自动刷新
    startAutoRefresh() {
      this.refreshInterval = setInterval(() => {
        this.refreshAllData();
      }, this.refreshRate);
      
      // 立即刷新一次
      this.refreshAllData();
    }
    
    // 停止自动刷新
    stopAutoRefresh() {
      if (this.refreshInterval) {
        clearInterval(this.refreshInterval);
        this.refreshInterval = null;
      }
    }
    
    // 刷新所有数据
    async refreshAllData() {
      if (this.isRefreshing) return;
      
      this.isRefreshing = true;
      try {
        await Promise.all([
          this.updateContractBalance(),
          this.updateUserDeposit(),
          this.updateUserBalance(),
          this.updateDepositCount(),
          this.updateUserRank()
        ]);
      } catch (error) {
        console.error('数据刷新失败:', error);
      } finally {
        this.isRefreshing = false;
      }
    }
    
    // 更新合约余额
    async updateContractBalance() {
      try {
        const balance = await this.bankContract.getContractBalance();
        UIComponents.updateStatsCard('contractBalance', `${parseFloat(balance).toFixed(4)} ETH`);
      } catch (error) {
        console.error('更新合约余额失败:', error);
      }
    }
    
    // 更新用户存款
    async updateUserDeposit() {
      try {
        const deposit = await this.bankContract.getUserDeposit();
        UIComponents.updateStatsCard('userDeposit', `${parseFloat(deposit).toFixed(4)} ETH`);
      } catch (error) {
        console.error('更新用户存款失败:', error);
      }
    }
    
    // 更新用户余额
    async updateUserBalance() {
      try {
        const balance = await this.web3.getBalance();
        UIComponents.updateStatsCard('walletBalance', `${parseFloat(balance).toFixed(4)} ETH`);
      } catch (error) {
        console.error('更新用户余额失败:', error);
      }
    }
    
    // 更新存款次数（通过事件日志）
    async updateDepositCount() {
      try {
        const filter = this.bankContract.contract.filters.Deposit(this.web3.userAddress);
        const events = await this.bankContract.contract.queryFilter(filter);
        UIComponents.updateStatsCard('depositCount', events.length.toString());
      } catch (error) {
        console.error('更新存款次数失败:', error);
        UIComponents.updateStatsCard('depositCount', '0');
      }
    }
    
    // 更新用户排名
    async updateUserRank() {
      try {
        // 这里需要根据您的合约实现来获取排行榜
        // 如果合约有 getTopDepositors 函数
        const topDepositors = await this.bankContract.getTopDepositors();
        const userAddress = this.web3.userAddress.toLowerCase();
        
        let rank = '-';
        for (let i = 0; i < topDepositors.length; i++) {
          if (topDepositors[i].toLowerCase() === userAddress) {
            rank = `#${i + 1}`;
            break;
          }
        }
        
        UIComponents.updateStatsCard('userRank', rank);
      } catch (error) {
        console.error('更新用户排名失败:', error);
        UIComponents.updateStatsCard('userRank', '-');
      }
    }
    
    // 手动刷新
    async manualRefresh() {
      UIComponents.showNotification('正在刷新数据...', 'info', 2000);
      await this.refreshAllData();
      UIComponents.showNotification('数据刷新完成', 'success', 3000);
    }
  }
  ```

#### 第5天：表单处理和验证
- [ ] **完善表单交互逻辑**
  ```javascript
  // 在 app.js 中添加表单处理
  class BankDApp {
    constructor() {
      this.web3 = web3Connection;
      this.bankContract = null;
      this.dataManager = null;
      this.init();
    }
    
    async init() {
      this.bindEvents();
      await this.checkConnection();
    }
    
    bindEvents() {
      // 钱包连接
      document.getElementById('connectWalletBtn').addEventListener('click', () => {
        this.connectWallet();
      });
      
      // 存款表单
      document.getElementById('depositForm').addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleDeposit();
      });
      
      // 提款表单
      document.getElementById('withdrawForm').addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleWithdraw();
      });
      
      // 监听钱包事件
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            this.handleDisconnect();
          } else {
            this.handleAccountChange();
          }
        });
        
        window.ethereum.on('chainChanged', () => {
          window.location.reload();
        });
      }
    }
    
    async handleDeposit() {
      try {
        // 表单验证
        const amount = document.getElementById('depositAmount').value;
        if (!amount || parseFloat(amount) <= 0) {
          UIComponents.showNotification('请输入有效的存款金额', 'error');
          return;
        }
        
        // 余额检查
        const userBalance = await this.web3.getBalance();
        if (parseFloat(amount) > parseFloat(userBalance)) {
          UIComponents.showNotification('余额不足', 'error');
          return;
        }
        
        // 显示交易模态框
        UIComponents.showTransactionModal('确认存款', '请在钱包中确认交易');
        UIComponents.setButtonLoading('depositBtn', true);
        
        // 执行存款
        const tx = await this.bankContract.deposit(amount);
        
        UIComponents.updateTransactionModal('交易已发送', `交易哈希: ${tx.hash}`);
        
        // 等待确认
        const receipt = await tx.wait();
        
        UIComponents.updateTransactionModal(
          '存款成功!', 
          `存款 ${amount} ETH 已确认`, 
          true
        );
        
        // 清空表单
        document.getElementById('depositAmount').value = '';
        
        // 刷新数据
        await this.dataManager.refreshAllData();
        
        UIComponents.showNotification(`成功存款 ${amount} ETH`, 'success');
        
      } catch (error) {
        console.error('存款失败:', error);
        
        let errorMessage = '存款失败';
        if (error.code === 4001) {
          errorMessage = '用户取消了交易';
        } else if (error.message.includes('insufficient funds')) {
          errorMessage = '余额不足';
        }
        
        UIComponents.updateTransactionModal('存款失败', errorMessage, true);
        UIComponents.showNotification(errorMessage, 'error');
      } finally {
        UIComponents.setButtonLoading('depositBtn', false);
      }
    }
    
    async handleWithdraw() {
      try {
        const amount = document.getElementById('withdrawAmount').value;
        if (!amount || parseFloat(amount) <= 0) {
          UIComponents.showNotification('请输入有效的提款金额', 'error');
          return;
        }
        
        UIComponents.showTransactionModal('确认提款', '请在钱包中确认交易');
        UIComponents.setButtonLoading('withdrawBtn', true);
        
        const tx = await this.bankContract.withdraw(amount);
        
        UIComponents.updateTransactionModal('交易已发送', `交易哈希: ${tx.hash}`);
        
        const receipt = await tx.wait();
        
        UIComponents.updateTransactionModal(
          '提款成功!', 
          `提款 ${amount} ETH 已确认`, 
          true
        );
        
        document.getElementById('withdrawAmount').value = '';
        await this.dataManager.refreshAllData();
        
        UIComponents.showNotification(`成功提款 ${amount} ETH`, 'success');
        
      } catch (error) {
        console.error('提款失败:', error);
        
        let errorMessage = '提款失败';
        if (error.code === 4001) {
          errorMessage = '用户取消了交易';
        } else if (error.message.includes('Only admin')) {
          errorMessage = '只有管理员可以提款';
        }
        
        UIComponents.updateTransactionModal('提款失败', errorMessage, true);
        UIComponents.showNotification(errorMessage, 'error');
      } finally {
        UIComponents.setButtonLoading('withdrawBtn', false);
      }
    }
    
    async connectWallet() {
      try {
        document.getElementById('loadingScreen').classList.remove('hidden');
        
        const connected = await this.web3.connectWallet();
        if (connected) {
          // 初始化合约
          this.bankContract = new BankContract(this.web3);
          await this.bankContract.init();
          
          // 初始化数据管理器
          this.dataManager = new DataManager(this.bankContract, this.web3);
          
          // 检查是否为管理员
          await this.checkAdminStatus();
          
          // 显示连接状态
          this.showConnectedState();
          
          // 开始数据刷新
          this.dataManager.startAutoRefresh();
          
          UIComponents.showNotification('钱包连接成功', 'success');
        }
      } catch (error) {
        console.error('连接失败:', error);
        UIComponents.showNotification('钱包连接失败', 'error');
      } finally {
        document.getElementById('loadingScreen').classList.add('hidden');
      }
    }
    
    async checkAdminStatus() {
      try {
        const isAdmin = await this.bankContract.isAdmin(this.web3.userAddress);
        if (isAdmin) {
          document.getElementById('adminSection').classList.remove('hidden');
          document.getElementById('notAdmin').classList.add('hidden');
        }
      } catch (error) {
        console.error('检查管理员状态失败:', error);
      }
    }
    
    showConnectedState() {
      document.getElementById('connectWalletBtn').classList.add('hidden');
      document.getElementById('walletConnected').classList.remove('hidden');
      document.getElementById('appContent').classList.remove('hidden');
      
      // 显示用户地址（简化显示）
      const address = this.web3.userAddress;
      const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
      document.querySelector('#walletConnected .fa-user').parentElement.title = address;
    }
  }
  
  // 初始化应用
  document.addEventListener('DOMContentLoaded', () => {
    new BankDApp();
  });
  ```

#### 第6-7天：错误处理和用户体验优化
- [ ] **完善错误处理机制**
  ```javascript
  // js/error-handler.js
  class ErrorHandler {
    static handleWeb3Error(error) {
      console.error('Web3 错误:', error);
      
      let userMessage = '操作失败，请重试';
      
      // 常见错误类型处理
      if (error.code === 4001) {
        userMessage = '用户取消了操作';
      } else if (error.code === -32602) {
        userMessage = '参数错误';
      } else if (error.message.includes('insufficient funds')) {
        userMessage = '余额不足';
      } else if (error.message.includes('gas required exceeds allowance')) {
        userMessage = 'Gas 费用不足';
      } else if (error.message.includes('nonce too low')) {
        userMessage = '交易序号错误，请刷新页面';
      } else if (error.message.includes('network')) {
        userMessage = '网络连接错误';
      }
      
      UIComponents.showNotification(userMessage, 'error');
      return userMessage;
    }
    
    static handleContractError(error, operation) {
      console.error(`合约操作 ${operation} 失败:`, error);
      
      let userMessage = `${operation}失败`;
      
      if (error.message.includes('Only admin')) {
        userMessage = '只有管理员可以执行此操作';
      } else if (error.message.includes('Insufficient balance')) {
        userMessage = '合约余额不足';
      }
      
      UIComponents.showNotification(userMessage, 'error');
      return userMessage;
    }
  }
  ```

### 🛠️ 每日检查清单
- [ ] **第1天**: 完成界面设计规划和框架选择
- [ ] **第2天**: 实现响应式布局和基础组件
- [ ] **第3天**: 开发交互组件和通知系统
- [ ] **第4天**: 实现实时数据更新机制
- [ ] **第5天**: 完善表单处理和验证逻辑
- [ ] **第6-7天**: 优化错误处理和用户体验

### 📖 学习资源
- [Tailwind CSS 文档](https://tailwindcss.com/docs)
- [Font Awesome 图标库](https://fontawesome.com/icons)
- [Web3 错误处理最佳实践](https://docs.metamask.io/guide/ethereum-provider.html#errors)

---

## 📅 第4周：事件监听和状态管理

### 🎯 本周目标
深入学习合约事件监听机制和前端状态管理

### 📋 学习任务

#### 第1天：理解事件机制和基础监听
- [ ] **学习事件机制原理**
  ```javascript
  // 事件基础概念
  /*
  1. 事件是什么？
     - 合约执行过程中发出的信号
     - 记录在区块链日志中
     - 可以被前端监听和处理
  
  2. 事件的作用：
     - 通知前端状态变化
     - 记录重要操作历史
     - 降低查询成本
     - 实现实时更新
  
  3. 事件类型：
     - indexed 参数：可以用于过滤
     - non-indexed 参数：存储详细数据
  */
  
  // Bank.sol 中的事件示例
  event Deposit(address indexed user, uint256 amount, uint256 timestamp);
  event Withdraw(address indexed admin, uint256 amount, uint256 timestamp);
  event TopDepositorsUpdated(address[3] topDepositors);
  ```

- [ ] **实现基础事件监听**
  ```javascript
  // js/event-listener.js
  class EventListener {
    constructor(bankContract, web3Connection) {
      this.contract = bankContract.contract;
      this.web3 = web3Connection;
      this.listeners = new Map();
      this.isListening = false;
    }
    
    // 开始监听所有事件
    async startListening() {
      if (this.isListening) return;
      
      try {
        // 监听存款事件
        this.listenToDeposits();
        
        // 监听提款事件
        this.listenToWithdrawals();
        
        // 监听排行榜更新
        this.listenToLeaderboardUpdates();
        
        this.isListening = true;
        console.log('事件监听已启动');
        
      } catch (error) {
        console.error('启动事件监听失败:', error);
      }
    }
    
    // 监听存款事件
    listenToDeposits() {
      const depositFilter = this.contract.filters.Deposit();
      
      this.contract.on(depositFilter, (user, amount, timestamp, event) => {
        console.log('检测到存款事件:', {
          user,
          amount: ethers.utils.formatEther(amount),
          timestamp: new Date(timestamp * 1000),
          txHash: event.transactionHash
        });
        
        // 处理存款事件
        this.handleDepositEvent(user, amount, timestamp, event);
      });
      
      console.log('存款事件监听已启动');
    }
    
    // 监听提款事件
    listenToWithdrawals() {
      const withdrawFilter = this.contract.filters.Withdraw();
      
      this.contract.on(withdrawFilter, (admin, amount, timestamp, event) => {
        console.log('检测到提款事件:', {
          admin,
          amount: ethers.utils.formatEther(amount),
          timestamp: new Date(timestamp * 1000),
          txHash: event.transactionHash
        });
        
        // 处理提款事件
        this.handleWithdrawEvent(admin, amount, timestamp, event);
      });
      
      console.log('提款事件监听已启动');
    }
    
    // 监听排行榜更新
    listenToLeaderboardUpdates() {
      const leaderboardFilter = this.contract.filters.TopDepositorsUpdated();
      
      this.contract.on(leaderboardFilter, (topDepositors, event) => {
        console.log('检测到排行榜更新:', {
          topDepositors,
          txHash: event.transactionHash
        });
        
        // 处理排行榜更新
        this.handleLeaderboardUpdate(topDepositors, event);
      });
      
      console.log('排行榜事件监听已启动');
    }
    
    // 处理存款事件
    handleDepositEvent(user, amount, timestamp, event) {
      const amountEth = ethers.utils.formatEther(amount);
      const userAddress = this.web3.userAddress.toLowerCase();
      
      // 如果是当前用户的存款
      if (user.toLowerCase() === userAddress) {
        UIComponents.showNotification(
          `存款成功！金额：${parseFloat(amountEth).toFixed(4)} ETH`, 
          'success'
        );
        
        // 更新用户数据
        this.updateUserStats();
      } else {
        // 其他用户的存款
        UIComponents.showNotification(
          `有新的存款：${parseFloat(amountEth).toFixed(4)} ETH`, 
          'info', 
          3000
        );
      }
      
      // 更新合约总余额
      this.updateContractBalance();
      
      // 记录到交易历史
      this.addToTransactionHistory({
        type: 'deposit',
        user,
        amount: amountEth,
        timestamp,
        txHash: event.transactionHash
      });
    }
    
    // 处理提款事件
    handleWithdrawEvent(admin, amount, timestamp, event) {
      const amountEth = ethers.utils.formatEther(amount);
      
      UIComponents.showNotification(
        `管理员提款：${parseFloat(amountEth).toFixed(4)} ETH`, 
        'warning'
      );
      
      // 更新合约余额
      this.updateContractBalance();
      
      // 记录到交易历史
      this.addToTransactionHistory({
        type: 'withdraw',
        admin,
        amount: amountEth,
        timestamp,
        txHash: event.transactionHash
      });
    }
    
    // 处理排行榜更新
    handleLeaderboardUpdate(topDepositors, event) {
      UIComponents.showNotification('排行榜已更新', 'info', 2000);
      
      // 更新排行榜显示
      this.updateLeaderboardDisplay(topDepositors);
      
      // 检查当前用户排名变化
      this.checkUserRankChange(topDepositors);
    }
    
    // 停止监听
    stopListening() {
      if (!this.isListening) return;
      
      // 移除所有监听器
      this.contract.removeAllListeners();
      this.isListening = false;
      
      console.log('事件监听已停止');
    }
  }
  ```

#### 第2天：历史事件查询和数据处理
- [ ] **实现历史事件查询**
  ```javascript
  // 扩展 EventListener 类
  class EventListener {
    // ... 前面的代码 ...
    
    // 查询历史存款事件
    async getDepositHistory(userAddress = null, fromBlock = 0) {
      try {
        let filter;
        
        if (userAddress) {
          // 查询特定用户的存款历史
          filter = this.contract.filters.Deposit(userAddress);
        } else {
          // 查询所有存款历史
          filter = this.contract.filters.Deposit();
        }
        
        const events = await this.contract.queryFilter(filter, fromBlock);
        
        return events.map(event => ({
          user: event.args.user,
          amount: ethers.utils.formatEther(event.args.amount),
          timestamp: new Date(event.args.timestamp * 1000),
          txHash: event.transactionHash,
          blockNumber: event.blockNumber
        }));
        
      } catch (error) {
        console.error('查询存款历史失败:', error);
        return [];
      }
    }
    
    // 查询历史提款事件
    async getWithdrawHistory(fromBlock = 0) {
      try {
        const filter = this.contract.filters.Withdraw();
        const events = await this.contract.queryFilter(filter, fromBlock);
        
        return events.map(event => ({
          admin: event.args.admin,
          amount: ethers.utils.formatEther(event.args.amount),
          timestamp: new Date(event.args.timestamp * 1000),
          txHash: event.transactionHash,
          blockNumber: event.blockNumber
        }));
        
      } catch (error) {
        console.error('查询提款历史失败:', error);
        return [];
      }
    }
    
    // 获取用户完整交易历史
    async getUserTransactionHistory(userAddress) {
      try {
        const [deposits, withdrawals] = await Promise.all([
          this.getDepositHistory(userAddress),
          this.getWithdrawHistory()
        ]);
        
        // 合并并按时间排序
        const allTransactions = [
          ...deposits.map(tx => ({ ...tx, type: 'deposit' })),
          ...withdrawals
            .filter(tx => tx.admin.toLowerCase() === userAddress.toLowerCase())
            .map(tx => ({ ...tx, type: 'withdraw' }))
        ];
        
        return allTransactions.sort((a, b) => b.timestamp - a.timestamp);
        
      } catch (error) {
        console.error('获取用户交易历史失败:', error);
        return [];
      }
    }
    
    // 获取统计数据
    async getStatistics() {
      try {
        const [deposits, withdrawals] = await Promise.all([
          this.getDepositHistory(),
          this.getWithdrawHistory()
        ]);
        
        const totalDeposits = deposits.reduce((sum, tx) => 
          sum + parseFloat(tx.amount), 0
        );
        
        const totalWithdrawals = withdrawals.reduce((sum, tx) => 
          sum + parseFloat(tx.amount), 0
        );
        
        return {
          totalTransactions: deposits.length + withdrawals.length,
          totalDeposits: totalDeposits.toFixed(4),
          totalWithdrawals: totalWithdrawals.toFixed(4),
          netBalance: (totalDeposits - totalWithdrawals).toFixed(4),
          uniqueUsers: new Set(deposits.map(tx => tx.user)).size
        };
        
      } catch (error) {
        console.error('获取统计数据失败:', error);
        return null;
      }
    }
  }
  ```

#### 第3天：交易状态跟踪系统
- [ ] **实现交易状态管理器**
  ```javascript
  // js/transaction-tracker.js
  class TransactionTracker {
    constructor() {
      this.pendingTransactions = new Map();
      this.completedTransactions = new Map();
      this.failedTransactions = new Map();
    }
    
    // 添加待处理交易
    addPendingTransaction(txHash, type, details) {
      const transaction = {
        hash: txHash,
        type,
        details,
        status: 'pending',
        timestamp: Date.now(),
        confirmations: 0,
        estimatedTime: this.estimateConfirmationTime()
      };
      
      this.pendingTransactions.set(txHash, transaction);
      
      // 显示交易状态
      this.showTransactionStatus(transaction);
      
      // 开始跟踪
      this.trackTransaction(txHash);
      
      return transaction;
    }
    
    // 跟踪交易状态
    async trackTransaction(txHash) {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // 等待交易确认
        const receipt = await provider.waitForTransaction(txHash, 1);
        
        if (receipt.status === 1) {
          // 交易成功
          this.handleTransactionSuccess(txHash, receipt);
        } else {
          // 交易失败
          this.handleTransactionFailure(txHash, receipt);
        }
        
      } catch (error) {
        console.error('跟踪交易失败:', error);
        this.handleTransactionError(txHash, error);
      }
    }
    
    // 处理交易成功
    handleTransactionSuccess(txHash, receipt) {
      const transaction = this.pendingTransactions.get(txHash);
      if (!transaction) return;
      
      // 更新交易状态
      transaction.status = 'confirmed';
      transaction.confirmations = 1;
      transaction.gasUsed = receipt.gasUsed.toString();
      transaction.blockNumber = receipt.blockNumber;
      
      // 移动到已完成列表
      this.completedTransactions.set(txHash, transaction);
      this.pendingTransactions.delete(txHash);
      
      // 更新UI
      this.updateTransactionUI(transaction);
      
      // 显示成功通知
      UIComponents.showNotification(
        `${this.getTransactionTypeText(transaction.type)}成功确认`, 
        'success'
      );
    }
    
    // 处理交易失败
    handleTransactionFailure(txHash, receipt) {
      const transaction = this.pendingTransactions.get(txHash);
      if (!transaction) return;
      
      transaction.status = 'failed';
      transaction.error = '交易执行失败';
      
      // 移动到失败列表
      this.failedTransactions.set(txHash, transaction);
      this.pendingTransactions.delete(txHash);
      
      // 更新UI
      this.updateTransactionUI(transaction);
      
      // 显示失败通知
      UIComponents.showNotification(
        `${this.getTransactionTypeText(transaction.type)}失败`, 
        'error'
      );
    }
    
    // 处理交易错误
    handleTransactionError(txHash, error) {
      const transaction = this.pendingTransactions.get(txHash);
      if (!transaction) return;
      
      transaction.status = 'error';
      transaction.error = error.message;
      
      this.failedTransactions.set(txHash, transaction);
      this.pendingTransactions.delete(txHash);
      
      this.updateTransactionUI(transaction);
      
      UIComponents.showNotification(
        `${this.getTransactionTypeText(transaction.type)}出错`, 
        'error'
      );
    }
    
    // 显示交易状态
    showTransactionStatus(transaction) {
      const statusHtml = `
        <div id="tx-${transaction.hash}" class="transaction-status bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
              <div>
                <p class="font-medium text-gray-900">${this.getTransactionTypeText(transaction.type)}处理中</p>
                <p class="text-sm text-gray-600">交易哈希: ${transaction.hash.slice(0, 10)}...</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">预计时间</p>
              <p class="font-medium">${transaction.estimatedTime}</p>
            </div>
          </div>
          <div class="mt-3">
            <div class="bg-blue-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 10%"></div>
            </div>
          </div>
        </div>
      `;
      
      // 添加到交易状态容器
      const container = document.getElementById('transactionStatusContainer') || this.createStatusContainer();
      container.insertAdjacentHTML('afterbegin', statusHtml);
    }
    
    // 更新交易UI
    updateTransactionUI(transaction) {
      const element = document.getElementById(`tx-${transaction.hash}`);
      if (!element) return;
      
      let statusClass, statusText, progressWidth;
      
      switch (transaction.status) {
        case 'confirmed':
          statusClass = 'bg-green-50 border-green-200';
          statusText = `${this.getTransactionTypeText(transaction.type)}成功`;
          progressWidth = '100%';
          break;
        case 'failed':
        case 'error':
          statusClass = 'bg-red-50 border-red-200';
          statusText = `${this.getTransactionTypeText(transaction.type)}失败`;
          progressWidth = '100%';
          break;
      }
      
      element.className = `transaction-status ${statusClass} rounded-lg p-4 mb-4`;
      element.querySelector('.font-medium').textContent = statusText;
      element.querySelector('.bg-blue-600').style.width = progressWidth;
      
      // 移除加载动画
      const spinner = element.querySelector('.animate-spin');
      if (spinner && transaction.status !== 'pending') {
        spinner.remove();
      }
      
      // 3秒后自动隐藏成功的交易
      if (transaction.status === 'confirmed') {
        setTimeout(() => {
          element.style.opacity = '0';
          setTimeout(() => element.remove(), 300);
        }, 3000);
      }
    }
    
    // 创建状态容器
    createStatusContainer() {
      const container = document.createElement('div');
      container.id = 'transactionStatusContainer';
      container.className = 'fixed bottom-4 right-4 w-96 z-50';
      document.body.appendChild(container);
      return container;
    }
    
    // 获取交易类型文本
    getTransactionTypeText(type) {
      const types = {
        'deposit': '存款',
        'withdraw': '提款',
        'transfer': '转账'
      };
      return types[type] || '交易';
    }
    
    // 估算确认时间
    estimateConfirmationTime() {
      // 基于当前网络状况估算
      return '1-2 分钟';
    }
    
    // 获取所有待处理交易
    getPendingTransactions() {
      return Array.from(this.pendingTransactions.values());
    }
    
    // 获取交易历史
    getTransactionHistory() {
      return [
        ...Array.from(this.completedTransactions.values()),
        ...Array.from(this.failedTransactions.values())
      ].sort((a, b) => b.timestamp - a.timestamp);
    }
  }
  ```

#### 第4天：本地数据存储和缓存
- [ ] **实现数据缓存管理器**
  ```javascript
  // js/cache-manager.js
  class CacheManager {
    constructor() {
      this.dbName = 'BankDAppCache';
      this.dbVersion = 1;
      this.db = null;
      this.init();
    }
    
    // 初始化 IndexedDB
    async init() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(this.dbName, this.dbVersion);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          this.db = request.result;
          resolve();
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // 创建交易历史存储
          if (!db.objectStoreNames.contains('transactions')) {
            const txStore = db.createObjectStore('transactions', { keyPath: 'txHash' });
            txStore.createIndex('userAddress', 'userAddress', { unique: false });
            txStore.createIndex('timestamp', 'timestamp', { unique: false });
            txStore.createIndex('type', 'type', { unique: false });
          }
          
          // 创建用户数据存储
          if (!db.objectStoreNames.contains('userData')) {
            db.createObjectStore('userData', { keyPath: 'address' });
          }
          
          // 创建合约状态存储
          if (!db.objectStoreNames.contains('contractState')) {
            db.createObjectStore('contractState', { keyPath: 'key' });
          }
        };
      });
    }
    
    // 缓存交易数据
    async cacheTransaction(transaction) {
      if (!this.db) await this.init();
      
      const tx = this.db.transaction(['transactions'], 'readwrite');
      const store = tx.objectStore('transactions');
      
      await store.put({
        txHash: transaction.txHash,
        userAddress: transaction.user || transaction.admin,
        type: transaction.type,
        amount: transaction.amount,
        timestamp: transaction.timestamp,
        blockNumber: transaction.blockNumber,
        cachedAt: Date.now()
      });
    }
    
    // 获取缓存的交易历史
    async getCachedTransactions(userAddress, limit = 50) {
      if (!this.db) await this.init();
      
      return new Promise((resolve, reject) => {
        const tx = this.db.transaction(['transactions'], 'readonly');
        const store = tx.objectStore('transactions');
        const index = store.index('userAddress');
        
        const request = index.getAll(userAddress);
        
        request.onsuccess = () => {
          const transactions = request.result
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, limit);
          resolve(transactions);
        };
        
        request.onerror = () => reject(request.error);
      });
    }
    
    // 缓存用户数据
    async cacheUserData(address, data) {
      if (!this.db) await this.init();
      
      const tx = this.db.transaction(['userData'], 'readwrite');
      const store = tx.objectStore('userData');
      
      await store.put({
        address,
        ...data,
        cachedAt: Date.now()
      });
    }
    
    // 获取缓存的用户数据
    async getCachedUserData(address) {
      if (!this.db) await this.init();
      
      return new Promise((resolve, reject) => {
        const tx = this.db.transaction(['userData'], 'readonly');
        const store = tx.objectStore('userData');
        const request = store.get(address);
        
        request.onsuccess = () => {
          const data = request.result;
          // 检查缓存是否过期（5分钟）
          if (data && Date.now() - data.cachedAt < 5 * 60 * 1000) {
            resolve(data);
          } else {
            resolve(null);
          }
        };
        
        request.onerror = () => reject(request.error);
      });
    }
    
    // 缓存合约状态
    async cacheContractState(key, value) {
      if (!this.db) await this.init();
      
      const tx = this.db.transaction(['contractState'], 'readwrite');
      const store = tx.objectStore('contractState');
      
      await store.put({
        key,
        value,
        cachedAt: Date.now()
      });
    }
    
    // 获取缓存的合约状态
    async getCachedContractState(key) {
      if (!this.db) await this.init();
      
      return new Promise((resolve, reject) => {
        const tx = this.db.transaction(['contractState'], 'readonly');
        const store = tx.objectStore('contractState');
        const request = store.get(key);
        
        request.onsuccess = () => {
          const data = request.result;
          // 检查缓存是否过期（1分钟）
          if (data && Date.now() - data.cachedAt < 60 * 1000) {
            resolve(data.value);
          } else {
            resolve(null);
          }
        };
        
        request.onerror = () => reject(request.error);
      });
    }
    
    // 清理过期缓存
    async cleanExpiredCache() {
      if (!this.db) await this.init();
      
      const stores = ['transactions', 'userData', 'contractState'];
      const expireTime = 24 * 60 * 60 * 1000; // 24小时
      
      for (const storeName of stores) {
        const tx = this.db.transaction([storeName], 'readwrite');
        const store = tx.objectStore('store');
        const request = store.getAll();
        
        request.onsuccess = () => {
          const items = request.result;
          items.forEach(item => {
            if (Date.now() - item.cachedAt > expireTime) {
              store.delete(item.key || item.txHash || item.address);
            }
          });
        };
      }
    }
  }
  ```

#### 第5天：状态管理和数据同步
- [ ] **实现状态管理器**
  ```javascript
  // js/state-manager.js
  class StateManager {
    constructor() {
      this.state = {
        user: {
          address: null,
          balance: '0',
          deposit: '0',
          isAdmin: false,
          rank: null
        },
        contract: {
          balance: '0',
          totalDepositors: 0,
          topDepositors: []
        },
        ui: {
          isConnected: false,
          isLoading: false,
          currentView: 'dashboard'
        },
        transactions: {
          pending: [],
          history: []
        }
      };
      
      this.listeners = new Map();
      this.cacheManager = new CacheManager();
    }
    
    // 订阅状态变化
    subscribe(key, callback) {
      if (!this.listeners.has(key)) {
        this.listeners.set(key, []);
      }
      this.listeners.get(key).push(callback);
      
      // 返回取消订阅函数
      return () => {
        const callbacks = this.listeners.get(key);
        const index = callbacks.indexOf(callback);
        if (index > -1) {
          callbacks.splice(index, 1);
        }
      };
    }
    
    // 更新状态
    setState(key, value) {
      const keys = key.split('.');
      let current = this.state;
      
      // 导航到目标位置
      for (let i = 0; i < keys.length - 1; i++) {
        if (!current[keys[i]]) {
          current[keys[i]] = {};
        }
        current = current[keys[i]];
      }
      
      // 设置值
      const lastKey = keys[keys.length - 1];
      const oldValue = current[lastKey];
      current[lastKey] = value;
      
      // 通知监听器
      this.notifyListeners(key, value, oldValue);
      
      // 缓存重要数据
      this.cacheImportantData(key, value);
    }
    
    // 获取状态
    getState(key) {
      const keys = key.split('.');
      let current = this.state;
      
      for (const k of keys) {
        if (current[k] === undefined) {
          return undefined;
        }
        current = current[k];
      }
      
      return current;
    }
    
    // 通知监听器
    notifyListeners(key, newValue, oldValue) {
      const callbacks = this.listeners.get(key) || [];
      callbacks.forEach(callback => {
        try {
          callback(newValue, oldValue);
        } catch (error) {
          console.error('状态监听器执行失败:', error);
        }
      });
    }
    
    // 缓存重要数据
    async cacheImportantData(key, value) {
      try {
        if (key.startsWith('user.')) {
          await this.cacheManager.cacheUserData(
            this.state.user.address, 
            this.state.user
          );
        } else if (key.startsWith('contract.')) {
          await this.cacheManager.cacheContractState(key, value);
        }
      } catch (error) {
        console.error('缓存数据失败:', error);
      }
    }
    
    // 从缓存加载数据
    async loadFromCache(userAddress) {
      try {
        // 加载用户数据
        const cachedUserData = await this.cacheManager.getCachedUserData(userAddress);
        if (cachedUserData) {
          Object.keys(cachedUserData).forEach(key => {
            if (key !== 'address' && key !== 'cachedAt') {
              this.setState(`user.${key}`, cachedUserData[key]);
            }
          });
        }
        
        // 加载合约状态
        const contractBalance = await this.cacheManager.getCachedContractState('contract.balance');
        if (contractBalance) {
          this.setState('contract.balance', contractBalance);
        }
        
        // 加载交易历史
        const cachedTransactions = await this.cacheManager.getCachedTransactions(userAddress);
        if (cachedTransactions.length > 0) {
          this.setState('transactions.history', cachedTransactions);
        }
        
      } catch (error) {
        console.error('从缓存加载数据失败:', error);
      }
    }
    
    // 批量更新状态
    batchUpdate(updates) {
      Object.entries(updates).forEach(([key, value]) => {
        this.setState(key, value);
      });
    }
    
    // 重置状态
    reset() {
      this.state = {
        user: {
          address: null,
          balance: '0',
          deposit: '0',
          isAdmin: false,
          rank: null
        },
        contract: {
          balance: '0',
          totalDepositors: 0,
          topDepositors: []
        },
        ui: {
          isConnected: false,
          isLoading: false,
          currentView: 'dashboard'
        },
        transactions: {
          pending: [],
          history: []
        }
      };
      
      // 通知所有监听器
      this.listeners.forEach((callbacks, key) => {
        callbacks.forEach(callback => {
          try {
            callback(this.getState(key), null);
          } catch (error) {
            console.error('重置状态通知失败:', error);
          }
        });
      });
    }
  }
  ```

#### 第6-7天：集成和优化
- [ ] **整合所有组件**
  ```javascript
  // js/enhanced-app.js
  class EnhancedBankDApp {
    constructor() {
      this.web3 = web3Connection;
      this.bankContract = null;
      this.eventListener = null;
      this.transactionTracker = new TransactionTracker();
      this.stateManager = new StateManager();
      this.dataManager = null;
      
      this.init();
    }
    
    async init() {
      // 绑定状态监听器
      this.bindStateListeners();
      
      // 绑定事件
      this.bindEvents();
      
      // 检查连接状态
      await this.checkConnection();
    }
    
    // 绑定状态监听器
    bindStateListeners() {
      // 监听连接状态变化
      this.stateManager.subscribe('ui.isConnected', (isConnected) => {
        if (isConnected) {
          this.showConnectedState();
        } else {
          this.showDisconnectedState();
        }
      });
      
      // 监听用户余额变化
      this.stateManager.subscribe('user.balance', (balance) => {
        UIComponents.updateStatsCard('walletBalance', `${parseFloat(balance).toFixed(4)} ETH`);
      });
      
      // 监听用户存款变化
      this.stateManager.subscribe('user.deposit', (deposit) => {
        UIComponents.updateStatsCard('userDeposit', `${parseFloat(deposit).toFixed(4)} ETH`);
      });
      
      // 监听合约余额变化
      this.stateManager.subscribe('contract.balance', (balance) => {
        UIComponents.updateStatsCard('contractBalance', `${parseFloat(balance).toFixed(4)} ETH`);
      });
      
      // 监听用户排名变化
      this.stateManager.subscribe('user.rank', (rank) => {
        UIComponents.updateStatsCard('userRank', rank || '-');
      });
    }
    
    // 连接钱包（增强版）
    async connectWallet() {
      try {
        this.stateManager.setState('ui.isLoading', true);
        
        const connected = await this.web3.connectWallet();
        if (connected) {
          const userAddress = this.web3.userAddress;
          this.stateManager.setState('user.address', userAddress);
          
          // 从缓存加载数据
          await this.stateManager.loadFromCache(userAddress);
          
          // 初始化合约
          this.bankContract = new BankContract(this.web3);
          await this.bankContract.init();
          
          // 初始化事件监听
          this.eventListener = new EventListener(this.bankContract, this.web3);
          await this.eventListener.startListening();
          
          // 初始化数据管理器
          this.dataManager = new DataManager(this.bankContract, this.web3, this.stateManager);
          
          // 检查管理员状态
          await this.checkAdminStatus();
          
          // 开始数据刷新
          this.dataManager.startAutoRefresh();
          
          // 更新连接状态
          this.stateManager.setState('ui.isConnected', true);
          
          UIComponents.showNotification('钱包连接成功', 'success');
        }
      } catch (error) {
        console.error('连接失败:', error);
        UIComponents.showNotification('钱包连接失败', 'error');
      } finally {
        this.stateManager.setState('ui.isLoading', false);
      }
    }
    
    // 处理存款（增强版）
    async handleDeposit() {
      try {
        const amount = document.getElementById('depositAmount').value;
        if (!amount || parseFloat(amount) <= 0) {
          UIComponents.showNotification('请输入有效的存款金额', 'error');
          return;
        }
        
        // 余额检查
        const userBalance = this.stateManager.getState('user.balance');
        if (parseFloat(amount) > parseFloat(userBalance)) {
          UIComponents.showNotification('余额不足', 'error');
          return;
        }
        
        UIComponents.setButtonLoading('depositBtn', true);
        
        // 执行存款
        const tx = await this.bankContract.deposit(amount);
        
        // 添加到交易跟踪器
        this.transactionTracker.addPendingTransaction(tx.hash, 'deposit', {
          amount,
          userAddress: this.stateManager.getState('user.address')
        });
        
        // 乐观更新（预期成功）
        const currentDeposit = parseFloat(this.stateManager.getState('user.deposit'));
        this.stateManager.setState('user.deposit', (currentDeposit + parseFloat(amount)).toString());
        
        // 清空表单
        document.getElementById('depositAmount').value = '';
        
        UIComponents.showNotification(`存款交易已发送，等待确认...`, 'info');
        
      } catch (error) {
        console.error('存款失败:', error);
        
        let errorMessage = '存款失败';
        if (error.code === 4001) {
          errorMessage = '用户取消了交易';
        } else if (error.message.includes('insufficient funds')) {
          errorMessage = '余额不足';
        }
        
        UIComponents.showNotification(errorMessage, 'error');
      } finally {
        UIComponents.setButtonLoading('depositBtn', false);
      }
    }
  }
  
  // 初始化增强版应用
  document.addEventListener('DOMContentLoaded', () => {
    new EnhancedBankDApp();
  });
  ```

### 🛠️ 每日检查清单
- [ ] **第1天**: 理解事件机制，实现基础事件监听
- [ ] **第2天**: 实现历史事件查询和数据处理
- [ ] **第3天**: 开发交易状态跟踪系统
- [ ] **第4天**: 实现本地数据存储和缓存机制
- [ ] **第5天**: 开发状态管理和数据同步
- [ ] **第6-7天**: 整合所有组件，优化用户体验

### 📖 学习资源
- [Ethers.js 事件文档](https://docs.ethers.io/v5/concepts/events/)
- [IndexedDB API 指南](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
- [Web3 事件监听最佳实践](https://ethereum.org/en/developers/tutorials/)

---

## 📅 第5周：高级交互功能

### 🎯 本周目标
实现高级合约交互功能、性能优化和用户体验提升

### 📋 学习任务

#### 第1天：批量操作和并发处理
- [ ] **实现批量查询系统**
  ```javascript
  // js/batch-operations.js
  class BatchOperations {
    constructor(bankContract, web3Connection) {
      this.contract = bankContract.contract;
      this.web3 = web3Connection;
      this.batchSize = 10; // 每批处理的数量
      this.concurrentLimit = 5; // 并发限制
    }
    
    // 批量查询用户存款
    async batchQueryDeposits(addresses) {
      try {
        const batches = this.createBatches(addresses, this.batchSize);
        const results = [];
        
        for (const batch of batches) {
          const batchPromises = batch.map(async (address) => {
            try {
              const deposit = await this.contract.deposits(address);
              return {
                address,
                deposit: ethers.utils.formatEther(deposit),
                success: true
              };
            } catch (error) {
              console.error(`查询 ${address} 失败:`, error);
              return {
                address,
                deposit: '0',
                success: false,
                error: error.message
              };
            }
          });
          
          const batchResults = await Promise.all(batchPromises);
          results.push(...batchResults);
          
          // 批次间延迟，避免过于频繁的请求
          if (batches.indexOf(batch) < batches.length - 1) {
            await this.delay(100);
          }
        }
        
        return results;
      } catch (error) {
        console.error('批量查询失败:', error);
        return [];
      }
    }
    
    // 批量查询余额
    async batchQueryBalances(addresses) {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const batches = this.createBatches(addresses, this.batchSize);
        const results = [];
        
        for (const batch of batches) {
          const batchPromises = batch.map(async (address) => {
            try {
              const balance = await provider.getBalance(address);
              return {
                address,
                balance: ethers.utils.formatEther(balance),
                success: true
              };
            } catch (error) {
              return {
                address,
                balance: '0',
                success: false,
                error: error.message
              };
            }
          });
          
          const batchResults = await Promise.all(batchPromises);
          results.push(...batchResults);
          
          await this.delay(100);
        }
        
        return results;
      } catch (error) {
        console.error('批量查询余额失败:', error);
        return [];
      }
    }
    
    // 批量查询交易历史
    async batchQueryTransactionHistory(addresses, fromBlock = 0) {
      try {
        const results = new Map();
        
        // 使用并发限制
        const semaphore = new Semaphore(this.concurrentLimit);
        
        const promises = addresses.map(async (address) => {
          await semaphore.acquire();
          
          try {
            const [deposits, withdrawals] = await Promise.all([
              this.getDepositHistory(address, fromBlock),
              this.getWithdrawHistory(address, fromBlock)
            ]);
            
            const allTransactions = [
              ...deposits.map(tx => ({ ...tx, type: 'deposit' })),
              ...withdrawals.map(tx => ({ ...tx, type: 'withdraw' }))
            ].sort((a, b) => b.timestamp - a.timestamp);
            
            results.set(address, allTransactions);
            
          } catch (error) {
            console.error(`查询 ${address} 交易历史失败:`, error);
            results.set(address, []);
          } finally {
            semaphore.release();
          }
        });
        
        await Promise.all(promises);
        return results;
        
      } catch (error) {
        console.error('批量查询交易历史失败:', error);
        return new Map();
      }
    }
    
    // 创建批次
    createBatches(array, batchSize) {
      const batches = [];
      for (let i = 0; i < array.length; i += batchSize) {
        batches.push(array.slice(i, i + batchSize));
      }
      return batches;
    }
    
    // 延迟函数
    delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // 获取存款历史（单个地址）
    async getDepositHistory(address, fromBlock) {
      const filter = this.contract.filters.Deposit(address);
      const events = await this.contract.queryFilter(filter, fromBlock);
      
      return events.map(event => ({
        user: event.args.user,
        amount: ethers.utils.formatEther(event.args.amount),
        timestamp: new Date(event.args.timestamp * 1000),
        txHash: event.transactionHash,
        blockNumber: event.blockNumber
      }));
    }
    
    // 获取提款历史（单个地址）
    async getWithdrawHistory(address, fromBlock) {
      const filter = this.contract.filters.Withdraw(address);
      const events = await this.contract.queryFilter(filter, fromBlock);
      
      return events.map(event => ({
        admin: event.args.admin,
        amount: ethers.utils.formatEther(event.args.amount),
        timestamp: new Date(event.args.timestamp * 1000),
        txHash: event.transactionHash,
        blockNumber: event.blockNumber
      }));
    }
  }
  
  // 信号量类，用于控制并发
  class Semaphore {
    constructor(maxConcurrency) {
      this.maxConcurrency = maxConcurrency;
      this.currentConcurrency = 0;
      this.queue = [];
    }
    
    async acquire() {
      return new Promise((resolve) => {
        if (this.currentConcurrency < this.maxConcurrency) {
          this.currentConcurrency++;
          resolve();
        } else {
          this.queue.push(resolve);
        }
      });
    }
    
    release() {
      this.currentConcurrency--;
      if (this.queue.length > 0) {
        const resolve = this.queue.shift();
        this.currentConcurrency++;
        resolve();
      }
    }
  }
  ```

#### 第2天：Gas 优化和费用估算
- [ ] **实现 Gas 管理系统**
  ```javascript
  // js/gas-manager.js
  class GasManager {
    constructor(web3Connection) {
      this.web3 = web3Connection;
      this.provider = new ethers.providers.Web3Provider(window.ethereum);
      this.gasCache = new Map();
      this.gasPriceHistory = [];
    }
    
    // 获取当前 Gas 价格
    async getCurrentGasPrice() {
      try {
        const gasPrice = await this.provider.getGasPrice();
        const gasPriceGwei = ethers.utils.formatUnits(gasPrice, 'gwei');
        
        // 缓存 Gas 价格历史
        this.gasPriceHistory.push({
          price: parseFloat(gasPriceGwei),
          timestamp: Date.now()
        });
        
        // 只保留最近1小时的数据
        const oneHourAgo = Date.now() - 60 * 60 * 1000;
        this.gasPriceHistory = this.gasPriceHistory.filter(
          item => item.timestamp > oneHourAgo
        );
        
        return {
          wei: gasPrice,
          gwei: gasPriceGwei,
          formatted: `${parseFloat(gasPriceGwei).toFixed(2)} Gwei`
        };
        
      } catch (error) {
        console.error('获取 Gas 价格失败:', error);
        return null;
      }
    }
    
    // 估算交易 Gas 费用
    async estimateTransactionCost(contract, method, params = [], value = '0') {
      try {
        const cacheKey = `${method}-${JSON.stringify(params)}-${value}`;
        
        // 检查缓存
        if (this.gasCache.has(cacheKey)) {
          const cached = this.gasCache.get(cacheKey);
          if (Date.now() - cached.timestamp < 5 * 60 * 1000) { // 5分钟缓存
            return cached.data;
          }
        }
        
        // 估算 Gas 限制
        const gasLimit = await contract.estimateGas[method](...params, {
          value: ethers.utils.parseEther(value)
        });
        
        // 获取当前 Gas 价格
        const gasPriceInfo = await this.getCurrentGasPrice();
        if (!gasPriceInfo) throw new Error('无法获取 Gas 价格');
        
        // 计算费用
        const gasCost = gasLimit.mul(gasPriceInfo.wei);
        const gasCostEth = ethers.utils.formatEther(gasCost);
        
        // 添加安全边距（20%）
        const safeGasLimit = gasLimit.mul(120).div(100);
        const safeCost = safeGasLimit.mul(gasPriceInfo.wei);
        const safeCostEth = ethers.utils.formatEther(safeCost);
        
        const result = {
          gasLimit: gasLimit.toString(),
          safeGasLimit: safeGasLimit.toString(),
          gasPrice: gasPriceInfo,
          estimatedCost: {
            wei: gasCost.toString(),
            eth: gasCostEth,
            formatted: `${parseFloat(gasCostEth).toFixed(6)} ETH`
          },
          safeCost: {
            wei: safeCost.toString(),
            eth: safeCostEth,
            formatted: `${parseFloat(safeCostEth).toFixed(6)} ETH`
          }
        };
        
        // 缓存结果
        this.gasCache.set(cacheKey, {
          data: result,
          timestamp: Date.now()
        });
        
        return result;
        
      } catch (error) {
        console.error('估算 Gas 费用失败:', error);
        
        // 返回默认估算
        return {
          gasLimit: '100000',
          safeGasLimit: '120000',
          gasPrice: { gwei: '20', formatted: '20 Gwei' },
          estimatedCost: { formatted: '~0.002 ETH' },
          safeCost: { formatted: '~0.0024 ETH' },
          error: error.message
        };
      }
    }
    
    // 获取 Gas 价格建议
    getGasPriceSuggestions() {
      if (this.gasPriceHistory.length === 0) {
        return {
          slow: '10',
          standard: '20',
          fast: '30'
        };
      }
      
      const prices = this.gasPriceHistory.map(item => item.price);
      const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
      
      return {
        slow: (avgPrice * 0.8).toFixed(1),
        standard: avgPrice.toFixed(1),
        fast: (avgPrice * 1.2).toFixed(1)
      };
    }
    
    // 优化交易参数
    async optimizeTransactionParams(contract, method, params, userPreference = 'standard') {
      try {
        const costEstimate = await this.estimateTransactionCost(contract, method, params);
        const suggestions = this.getGasPriceSuggestions();
        
        let selectedGasPrice;
        switch (userPreference) {
          case 'slow':
            selectedGasPrice = ethers.utils.parseUnits(suggestions.slow, 'gwei');
            break;
          case 'fast':
            selectedGasPrice = ethers.utils.parseUnits(suggestions.fast, 'gwei');
            break;
          default:
            selectedGasPrice = ethers.utils.parseUnits(suggestions.standard, 'gwei');
        }
        
        return {
          gasLimit: costEstimate.safeGasLimit,
          gasPrice: selectedGasPrice,
          maxFeePerGas: selectedGasPrice.mul(110).div(100), // EIP-1559
          maxPriorityFeePerGas: ethers.utils.parseUnits('2', 'gwei'),
          estimatedCost: costEstimate.safeCost
        };
        
      } catch (error) {
        console.error('优化交易参数失败:', error);
        return null;
      }
    }
    
    // 监控 Gas 价格变化
    startGasPriceMonitoring(callback, interval = 30000) {
      const monitor = setInterval(async () => {
        const gasPrice = await this.getCurrentGasPrice();
        if (gasPrice && callback) {
          callback(gasPrice);
        }
      }, interval);
      
      return () => clearInterval(monitor);
    }
    
    // 清理缓存
    clearCache() {
      this.gasCache.clear();
      this.gasPriceHistory = [];
    }
  }
  ```

#### 第3天：智能重试机制和错误处理
- [ ] **实现重试管理系统**
  ```javascript
  // js/retry-manager.js
  class RetryManager {
    constructor() {
      this.retryConfig = {
        maxRetries: 3,
        baseDelay: 1000,
        maxDelay: 10000,
        backoffFactor: 2,
        retryableErrors: [
          'NETWORK_ERROR',
          'TIMEOUT',
          'INSUFFICIENT_FUNDS',
          'REPLACEMENT_UNDERPRICED',
          'NONCE_EXPIRED'
        ]
      };
      
      this.activeRetries = new Map();
    }
    
    // 执行带重试的操作
    async executeWithRetry(operation, operationId, customConfig = {}) {
      const config = { ...this.retryConfig, ...customConfig };
      let lastError;
      
      for (let attempt = 0; attempt <= config.maxRetries; attempt++) {
        try {
          // 更新重试状态
          this.updateRetryStatus(operationId, {
            attempt: attempt + 1,
            maxAttempts: config.maxRetries + 1,
            status: 'attempting'
          });
          
          const result = await operation();
          
          // 成功，清理重试状态
          this.activeRetries.delete(operationId);
          return result;
          
        } catch (error) {
          lastError = error;
          console.warn(`操作失败 (尝试 ${attempt + 1}/${config.maxRetries + 1}):`, error.message);
          
          // 检查是否应该重试
          if (attempt === config.maxRetries || !this.shouldRetry(error)) {
            this.activeRetries.delete(operationId);
            throw error;
          }
          
          // 计算延迟时间
          const delay = Math.min(
            config.baseDelay * Math.pow(config.backoffFactor, attempt),
            config.maxDelay
          );
          
          // 更新重试状态
          this.updateRetryStatus(operationId, {
            attempt: attempt + 1,
            maxAttempts: config.maxRetries + 1,
            status: 'waiting',
            nextRetryIn: delay,
            error: error.message
          });
          
          // 等待后重试
          await this.delay(delay);
        }
      }
      
      throw lastError;
    }
    
    // 判断是否应该重试
    shouldRetry(error) {
      // 检查错误类型
      if (error.code === 4001) { // 用户拒绝
        return false;
      }
      
      if (error.code === -32603) { // 内部错误，可能是网络问题
        return true;
      }
      
      // 检查错误消息
      const errorMessage = error.message.toLowerCase();
      
      const retryablePatterns = [
        'network error',
        'timeout',
        'connection',
        'replacement underpriced',
        'nonce too low',
        'already known',
        'gas price too low'
      ];
      
      return retryablePatterns.some(pattern => 
        errorMessage.includes(pattern)
      );
    }
    
    // 智能存款重试
    async retryableDeposit(bankContract, amount, userAddress) {
      const operationId = `deposit-${userAddress}-${Date.now()}`;
      
      return await this.executeWithRetry(async () => {
        // 检查余额
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const balance = await provider.getBalance(userAddress);
        const amountWei = ethers.utils.parseEther(amount);
        
        if (balance.lt(amountWei)) {
          throw new Error('余额不足');
        }
        
        // 获取优化的交易参数
        const gasManager = new GasManager();
        const txParams = await gasManager.optimizeTransactionParams(
          bankContract.contract,
          'deposit',
          [],
          'standard'
        );
        
        // 执行存款
        const tx = await bankContract.contract.deposit({
          value: amountWei,
          gasLimit: txParams.gasLimit,
          gasPrice: txParams.gasPrice
        });
        
        return tx;
        
      }, operationId, {
        maxRetries: 5,
        baseDelay: 2000
      });
    }
    
    // 智能提款重试
    async retryableWithdraw(bankContract, amount) {
      const operationId = `withdraw-${Date.now()}`;
      
      return await this.executeWithRetry(async () => {
        const amountWei = ethers.utils.parseEther(amount);
        
        // 检查合约余额
        const contractBalance = await bankContract.contract.getBalance();
        if (contractBalance.lt(amountWei)) {
          throw new Error('合约余额不足');
        }
        
        // 获取优化的交易参数
        const gasManager = new GasManager();
        const txParams = await gasManager.optimizeTransactionParams(
          bankContract.contract,
          'withdraw',
          [amountWei],
          'standard'
        );
        
        // 执行提款
        const tx = await bankContract.contract.withdraw(amountWei, {
          gasLimit: txParams.gasLimit,
          gasPrice: txParams.gasPrice
        });
        
        return tx;
        
      }, operationId, {
        maxRetries: 3,
        baseDelay: 3000
      });
    }
    
    // 更新重试状态
    updateRetryStatus(operationId, status) {
      this.activeRetries.set(operationId, {
        ...status,
        timestamp: Date.now()
      });
      
      // 通知UI更新
      this.notifyRetryStatus(operationId, status);
    }
    
    // 通知重试状态
    notifyRetryStatus(operationId, status) {
      const event = new CustomEvent('retryStatusUpdate', {
        detail: { operationId, status }
      });
      document.dispatchEvent(event);
    }
    
    // 获取活跃重试状态
    getActiveRetries() {
      return Array.from(this.activeRetries.entries()).map(([id, status]) => ({
        id,
        ...status
      }));
    }
    
    // 取消重试
    cancelRetry(operationId) {
      this.activeRetries.delete(operationId);
    }
    
    // 延迟函数
    delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  }
  ```

#### 第4天：性能监控和优化
- [ ] **实现性能监控系统**
  ```javascript
  // js/performance-monitor.js
  class PerformanceMonitor {
    constructor() {
      this.metrics = {
        transactions: [],
        apiCalls: [],
        renderTimes: [],
        errors: []
      };
      
      this.thresholds = {
        transactionTime: 30000, // 30秒
        apiCallTime: 5000,      // 5秒
        renderTime: 100,        // 100ms
        errorRate: 0.05         // 5%
      };
      
      this.isMonitoring = false;
    }
    
    // 开始监控
    startMonitoring() {
      if (this.isMonitoring) return;
      
      this.isMonitoring = true;
      
      // 监控页面性能
      this.monitorPagePerformance();
      
      // 监控网络请求
      this.monitorNetworkRequests();
      
      // 监控错误
      this.monitorErrors();
      
      console.log('性能监控已启动');
    }
    
    // 记录交易性能
    recordTransaction(txHash, type, startTime) {
      const endTime = Date.now();
      const duration = endTime - startTime;
      
      const record = {
        txHash,
        type,
        startTime,
        endTime,
        duration,
        timestamp: Date.now()
      };
      
      this.metrics.transactions.push(record);
      
      // 检查性能阈值
      if (duration > this.thresholds.transactionTime) {
        console.warn(`交易 ${txHash} 耗时过长: ${duration}ms`);
        this.recordPerformanceIssue('slow_transaction', record);
      }
      
      // 清理旧数据
      this.cleanOldMetrics('transactions');
      
      return record;
    }
    
    // 记录 API 调用性能
    recordApiCall(method, params, startTime, success = true, error = null) {
      const endTime = Date.now();
      const duration = endTime - startTime;
      
      const record = {
        method,
        params: JSON.stringify(params),
        startTime,
        endTime,
        duration,
        success,
        error: error?.message,
        timestamp: Date.now()
      };
      
      this.metrics.apiCalls.push(record);
      
      // 检查性能阈值
      if (duration > this.thresholds.apiCallTime) {
        console.warn(`API 调用 ${method} 耗时过长: ${duration}ms`);
        this.recordPerformanceIssue('slow_api_call', record);
      }
      
      if (!success) {
        this.metrics.errors.push({
          type: 'api_error',
          method,
          error: error?.message,
          timestamp: Date.now()
        });
      }
      
      this.cleanOldMetrics('apiCalls');
      
      return record;
    }
    
    // 记录渲染性能
    recordRenderTime(component, startTime) {
      const endTime = Date.now();
      const duration = endTime - startTime;
      
      const record = {
        component,
        startTime,
        endTime,
        duration,
        timestamp: Date.now()
      };
      
      this.metrics.renderTimes.push(record);
      
      if (duration > this.thresholds.renderTime) {
        console.warn(`组件 ${component} 渲染耗时过长: ${duration}ms`);
        this.recordPerformanceIssue('slow_render', record);
      }
      
      this.cleanOldMetrics('renderTimes');
      
      return record;
    }
    
    // 监控页面性能
    monitorPagePerformance() {
      // 监控页面加载时间
      window.addEventListener('load', () => {
        const navigation = performance.getEntriesByType('navigation')[0];
        if (navigation) {
          console.log('页面加载性能:', {
            domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
            loadComplete: navigation.loadEventEnd - navigation.loadEventStart,
            totalTime: navigation.loadEventEnd - navigation.fetchStart
          });
        }
      });
      
      // 监控资源加载
      const observer = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
          if (entry.duration > 1000) { // 超过1秒的资源
            console.warn('慢资源加载:', entry.name, entry.duration + 'ms');
          }
        });
      });
      
      observer.observe({ entryTypes: ['resource'] });
    }
    
    // 监控网络请求
    monitorNetworkRequests() {
      // 拦截 fetch 请求
      const originalFetch = window.fetch;
      window.fetch = async (...args) => {
        const startTime = Date.now();
        try {
          const response = await originalFetch(...args);
          const duration = Date.now() - startTime;
          
          this.recordApiCall(
            'fetch',
            { url: args[0] },
            startTime,
            response.ok,
            response.ok ? null : new Error(`HTTP ${response.status}`)
          );
          
          return response;
        } catch (error) {
          this.recordApiCall('fetch', { url: args[0] }, startTime, false, error);
          throw error;
        }
      };
    }
    
    // 监控错误
    monitorErrors() {
      window.addEventListener('error', (event) => {
        this.metrics.errors.push({
          type: 'javascript_error',
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          timestamp: Date.now()
        });
      });
      
      window.addEventListener('unhandledrejection', (event) => {
        this.metrics.errors.push({
          type: 'promise_rejection',
          message: event.reason?.message || 'Unhandled promise rejection',
          timestamp: Date.now()
        });
      });
    }
    
    // 获取性能报告
    getPerformanceReport() {
      const now = Date.now();
      const oneHour = 60 * 60 * 1000;
      
      // 过滤最近一小时的数据
      const recentTransactions = this.metrics.transactions.filter(
        t => now - t.timestamp < oneHour
      );
      const recentApiCalls = this.metrics.apiCalls.filter(
        a => now - a.timestamp < oneHour
      );
      const recentErrors = this.metrics.errors.filter(
        e => now - e.timestamp < oneHour
      );
      
      // 计算统计数据
      const avgTransactionTime = recentTransactions.length > 0 
        ? recentTransactions.reduce((sum, t) => sum + t.duration, 0) / recentTransactions.length
        : 0;
      
      const avgApiCallTime = recentApiCalls.length > 0
        ? recentApiCalls.reduce((sum, a) => sum + a.duration, 0) / recentApiCalls.length
        : 0;
      
      const errorRate = recentApiCalls.length > 0
        ? recentErrors.length / recentApiCalls.length
        : 0;
      
      return {
        summary: {
          totalTransactions: recentTransactions.length,
          totalApiCalls: recentApiCalls.length,
          totalErrors: recentErrors.length,
          avgTransactionTime: Math.round(avgTransactionTime),
          avgApiCallTime: Math.round(avgApiCallTime),
          errorRate: (errorRate * 100).toFixed(2) + '%'
        },
        transactions: recentTransactions.slice(-10), // 最近10笔交易
        slowOperations: this.getSlowOperations(),
        errors: recentErrors.slice(-5), // 最近5个错误
        recommendations: this.getOptimizationRecommendations()
      };
    }
    
    // 获取慢操作
    getSlowOperations() {
      const slowTransactions = this.metrics.transactions.filter(
        t => t.duration > this.thresholds.transactionTime
      );
      
      const slowApiCalls = this.metrics.apiCalls.filter(
        a => a.duration > this.thresholds.apiCallTime
      );
      
      return {
        transactions: slowTransactions.slice(-5),
        apiCalls: slowApiCalls.slice(-5)
      };
    }
    
    // 获取优化建议
    getOptimizationRecommendations() {
      const recommendations = [];
      const report = this.getPerformanceReport();
      
      if (report.summary.avgTransactionTime > this.thresholds.transactionTime) {
        recommendations.push({
          type: 'transaction_optimization',
          message: '交易确认时间较长，建议优化 Gas 价格设置',
          priority: 'high'
        });
      }
      
      if (report.summary.avgApiCallTime > this.thresholds.apiCallTime) {
        recommendations.push({
          type: 'api_optimization',
          message: 'API 调用响应较慢，建议实现缓存机制',
          priority: 'medium'
        });
      }
      
      if (parseFloat(report.summary.errorRate) > this.thresholds.errorRate * 100) {
        recommendations.push({
          type: 'error_handling',
          message: '错误率较高，建议加强错误处理和重试机制',
          priority: 'high'
        });
      }
      
      return recommendations;
    }
    
    // 记录性能问题
    recordPerformanceIssue(type, details) {
      console.warn('性能问题:', type, details);
      
      // 可以发送到监控服务
      // this.sendToMonitoringService(type, details);
    }
    
    // 清理旧数据
    cleanOldMetrics(type) {
      const maxAge = 24 * 60 * 60 * 1000; // 24小时
      const now = Date.now();
      
      this.metrics[type] = this.metrics[type].filter(
        item => now - item.timestamp < maxAge
      );
    }
    
    // 停止监控
    stopMonitoring() {
      this.isMonitoring = false;
      console.log('性能监控已停止');
    }
  }
  ```

#### 第5天：用户体验优化
- [ ] **实现 UX 增强组件**
  ```javascript
  // js/ux-enhancements.js
  class UXEnhancements {
    constructor(stateManager, performanceMonitor) {
      this.stateManager = stateManager;
      this.performanceMonitor = performanceMonitor;
      this.loadingStates = new Map();
      this.notifications = [];
      
      this.init();
    }
    
    init() {
      this.createLoadingOverlay();
      this.createNotificationContainer();
      this.setupProgressIndicators();
      this.setupTooltips();
    }
    
    // 创建加载遮罩
    createLoadingOverlay() {
      const overlay = document.createElement('div');
      overlay.id = 'loadingOverlay';
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-sm mx-4">
          <div class="flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <div>
              <p class="font-medium text-gray-900" id="loadingTitle">处理中...</p>
              <p class="text-sm text-gray-600" id="loadingMessage">请稍候</p>
            </div>
          </div>
          <div class="mt-4">
            <div class="bg-gray-200 rounded-full h-2">
              <div id="loadingProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
    }
    
    // 显示加载状态
    showLoading(title = '处理中...', message = '请稍候', showProgress = false) {
      const overlay = document.getElementById('loadingOverlay');
      const titleEl = document.getElementById('loadingTitle');
      const messageEl = document.getElementById('loadingMessage');
      const progressEl = document.getElementById('loadingProgress');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      if (showProgress) {
        progressEl.style.width = '0%';
        progressEl.parentElement.style.display = 'block';
      } else {
        progressEl.parentElement.style.display = 'none';
      }
      
      overlay.classList.remove('hidden');
    }
    
    // 更新加载进度
    updateLoadingProgress(progress, message = null) {
      const progressEl = document.getElementById('loadingProgress');
      const messageEl = document.getElementById('loadingMessage');
      
      if (progressEl) {
        progressEl.style.width = `${Math.min(100, Math.max(0, progress))}%`;
      }
      
      if (message && messageEl) {
        messageEl.textContent = message;
      }
    }
    
    // 隐藏加载状态
    hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.add('hidden');
    }
    
    // 智能加载管理
    async withLoading(operation, config = {}) {
      const {
        title = '处理中...',
        initialMessage = '请稍候',
        showProgress = false,
        estimatedTime = null
      } = config;
      
      try {
        this.showLoading(title, initialMessage, showProgress);
        
        let progressInterval;
        if (showProgress && estimatedTime) {
          let progress = 0;
          progressInterval = setInterval(() => {
            progress += (100 / (estimatedTime / 1000)) * 0.5; // 每500ms更新
            if (progress < 90) { // 不要到100%，等实际完成
              this.updateLoadingProgress(progress);
            }
          }, 500);
        }
        
        const result = await operation();
        
        if (progressInterval) {
          clearInterval(progressInterval);
          this.updateLoadingProgress(100, '完成');
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        return result;
        
      } finally {
        this.hideLoading();
      }
    }
    
    // 创建通知容器
    createNotificationContainer() {
      const container = document.createElement('div');
      container.id = 'notificationContainer';
      container.className = 'fixed top-4 right-4 z-50 space-y-2';
      document.body.appendChild(container);
    }
    
    // 显示智能通知
    showSmartNotification(message, type = 'info', options = {}) {
      const {
        duration = 5000,
        actions = [],
        persistent = false,
        icon = null
      } = options;
      
      const notification = {
        id: Date.now().toString(),
        message,
        type,
        timestamp: Date.now(),
        actions,
        persistent
      };
      
      this.notifications.push(notification);
      this.renderNotification(notification, duration);
      
      return notification.id;
    }
    
    // 渲染通知
    renderNotification(notification, duration) {
      const container = document.getElementById('notificationContainer');
      
      const typeStyles = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
      };
      
      const typeIcons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'ℹ'
      };
      
      const notificationEl = document.createElement('div');
      notificationEl.id = `notification-${notification.id}`;
      notificationEl.className = `${typeStyles[notification.type]} border rounded-lg p-4 shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
      
      notificationEl.innerHTML = `
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <span class="text-lg">${typeIcons[notification.type]}</span>
          </div>
          <div class="ml-3 flex-1">
            <p class="text-sm font-medium">${notification.message}</p>
            ${notification.actions.length > 0 ? `
              <div class="mt-2 space-x-2">
                ${notification.actions.map(action => `
                  <button class="text-xs px-2 py-1 rounded border hover:bg-opacity-20 transition-colors"
                          onclick="window.uxEnhancements.handleNotificationAction('${notification.id}', '${action.id}')">
                    ${action.label}
                  </button>
                `).join('')}
              </div>
            ` : ''}
          </div>
          ${!notification.persistent ? `
            <button class="flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600"
                    onclick="window.uxEnhancements.dismissNotification('${notification.id}')">
              <span class="sr-only">关闭</span>
              <span class="text-lg">×</span>
            </button>
          ` : ''}
        </div>
      `;
      
      container.appendChild(notificationEl);
      
      // 动画显示
      setTimeout(() => {
        notificationEl.classList.remove('translate-x-full');
      }, 100);
      
      // 自动消失
      if (!notification.persistent && duration > 0) {
        setTimeout(() => {
          this.dismissNotification(notification.id);
        }, duration);
      }
    }
    
    // 处理通知操作
    handleNotificationAction(notificationId, actionId) {
      const notification = this.notifications.find(n => n.id === notificationId);
      if (!notification) return;
      
      const action = notification.actions.find(a => a.id === actionId);
      if (action && action.handler) {
        action.handler();
      }
      
      this.dismissNotification(notificationId);
    }
    
    // 关闭通知
    dismissNotification(notificationId) {
      const notificationEl = document.getElementById(`notification-${notificationId}`);
      if (notificationEl) {
        notificationEl.classList.add('translate-x-full');
        setTimeout(() => {
          notificationEl.remove();
        }, 300);
      }
      
      this.notifications = this.notifications.filter(n => n.id !== notificationId);
    }
    
    // 设置进度指示器
    setupProgressIndicators() {
      // 为所有按钮添加加载状态
      document.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-loading]');
        if (button && !button.disabled) {
          this.setButtonLoading(button, true);
        }
      });
    }
    
    // 设置按钮加载状态
    setButtonLoading(button, loading) {
      if (typeof button === 'string') {
        button = document.getElementById(button);
      }
      
      if (!button) return;
      
      if (loading) {
        button.disabled = true;
        button.dataset.originalText = button.textContent;
        button.innerHTML = `
          <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
            处理中...
          </div>
        `;
      } else {
        button.disabled = false;
        button.textContent = button.dataset.originalText || button.textContent;
      }
    }
    
    // 设置工具提示
    setupTooltips() {
      // 简单的工具提示实现
      document.addEventListener('mouseenter', (event) => {
        const element = event.target.closest('[data-tooltip]');
        if (element) {
          this.showTooltip(element, element.dataset.tooltip);
        }
      });
      
      document.addEventListener('mouseleave', (event) => {
        const element = event.target.closest('[data-tooltip]');
        if (element) {
          this.hideTooltip();
        }
      });
    }
    
    // 显示工具提示
    showTooltip(element, text) {
      const tooltip = document.createElement('div');
      tooltip.id = 'tooltip';
      tooltip.className = 'absolute bg-gray-900 text-white text-xs rounded py-1 px-2 z-50';
      tooltip.textContent = text;
      
      document.body.appendChild(tooltip);
      
      const rect = element.getBoundingClientRect();
      tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
      tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';
    }
    
    // 隐藏工具提示
    hideTooltip() {
      const tooltip = document.getElementById('tooltip');
      if (tooltip) {
        tooltip.remove();
      }
    }
  }
  
  // 全局实例
  window.uxEnhancements = null;
  ```

#### 第6-7天：集成测试和性能调优
- [ ] **完整的性能优化集成**
  ```javascript
  // js/optimized-bank-app.js
  class OptimizedBankDApp {
    constructor() {
      this.web3 = web3Connection;
      this.bankContract = null;
      this.eventListener = null;
      this.transactionTracker = new TransactionTracker();
      this.stateManager = new StateManager();
      this.gasManager = new GasManager(this.web3);
      this.retryManager = new RetryManager();
      this.performanceMonitor = new PerformanceMonitor();
      this.batchOperations = null;
      this.uxEnhancements = null;
      
      this.init();
    }
    
    async init() {
      // 启动性能监控
      this.performanceMonitor.startMonitoring();
      
      // 初始化 UX 增强
      this.uxEnhancements = new UXEnhancements(this.stateManager, this.performanceMonitor);
      window.uxEnhancements = this.uxEnhancements;
      
      // 绑定事件
      this.bindEvents();
      
      // 检查连接状态
      await this.checkConnection();
      
      // 启动 Gas 价格监控
      this.gasManager.startGasPriceMonitoring((gasPrice) => {
        this.stateManager.setState('network.gasPrice', gasPrice);
      });
    }
    
    // 优化的连接钱包
    async connectWallet() {
      const startTime = Date.now();
      
      try {
        const result = await this.uxEnhancements.withLoading(async () => {
          const connected = await this.web3.connectWallet();
          if (!connected) throw new Error('连接失败');
          
          const userAddress = this.web3.userAddress;
          this.stateManager.setState('user.address', userAddress);
          
          // 并行初始化
          await Promise.all([
            this.initializeContract(),
            this.stateManager.loadFromCache(userAddress)
          ]);
          
          // 初始化批量操作
          this.batchOperations = new BatchOperations(this.bankContract, this.web3);
          
          // 启动事件监听
          this.eventListener = new EventListener(this.bankContract, this.web3);
          await this.eventListener.startListening();
          
          // 批量加载初始数据
          await this.loadInitialData();
          
          this.stateManager.setState('ui.isConnected', true);
          
          return true;
        }, {
          title: '连接钱包',
          initialMessage: '正在连接...',
          showProgress: true,
          estimatedTime: 5000
        });
        
        this.uxEnhancements.showSmartNotification('钱包连接成功', 'success');
        
        // 记录性能
        this.performanceMonitor.recordApiCall('connectWallet', {}, startTime, true);
        
      } catch (error) {
        console.error('连接失败:', error);
        this.uxEnhancements.showSmartNotification('钱包连接失败: ' + error.message, 'error');
        this.performanceMonitor.recordApiCall('connectWallet', {}, startTime, false, error);
      }
    }
    
    // 优化的存款操作
    async handleDeposit() {
      const amount = document.getElementById('depositAmount').value;
      if (!amount || parseFloat(amount) <= 0) {
        this.uxEnhancements.showSmartNotification('请输入有效的存款金额', 'error');
        return;
      }
      
      const startTime = Date.now();
      
      try {
        // 预检查
        const userBalance = this.stateManager.getState('user.balance');
        if (parseFloat(amount) > parseFloat(userBalance)) {
          this.uxEnhancements.showSmartNotification('余额不足', 'error');
          return;
        }
        
        // 估算 Gas 费用
        const gasEstimate = await this.gasManager.estimateTransactionCost(
          this.bankContract.contract,
          'deposit',
          [],
          amount
        );
        
        // 显示确认对话框
        const confirmed = await this.showTransactionConfirmation({
          type: '存款',
          amount: `${amount} ETH`,
          gasEstimate: gasEstimate.safeCost.formatted,
          total: `${(parseFloat(amount) + parseFloat(gasEstimate.safeCost.eth)).toFixed(6)} ETH`
        });
        
        if (!confirmed) return;
        
        // 执行带重试的存款
        const tx = await this.retryManager.retryableDeposit(
          this.bankContract,
          amount,
          this.stateManager.getState('user.address')
        );
        
        // 添加到交易跟踪
        this.transactionTracker.addPendingTransaction(tx.hash, 'deposit', {
          amount,
          userAddress: this.stateManager.getState('user.address')
        });
        
        // 乐观更新
        const currentDeposit = parseFloat(this.stateManager.getState('user.deposit'));
        this.stateManager.setState('user.deposit', (currentDeposit + parseFloat(amount)).toString());
        
        // 清空表单
        document.getElementById('depositAmount').value = '';
        
        this.uxEnhancements.showSmartNotification(
          `存款交易已发送，交易哈希: ${tx.hash.slice(0, 10)}...`,
          'info',
          {
            actions: [{
              id: 'view_tx',
              label: '查看交易',
              handler: () => window.open(`https://etherscan.io/tx/${tx.hash}`, '_blank')
            }]
          }
        );
        
        // 记录性能
        this.performanceMonitor.recordTransaction(tx.hash, 'deposit', startTime);
        
      } catch (error) {
        console.error('存款失败:', error);
        
        let errorMessage = '存款失败';
        if (error.code === 4001) {
          errorMessage = '用户取消了交易';
        } else if (error.message.includes('insufficient funds')) {
          errorMessage = '余额不足';
        }
        
        this.uxEnhancements.showSmartNotification(errorMessage, 'error', {
          actions: [{
            id: 'retry',
            label: '重试',
            handler: () => this.handleDeposit()
          }]
        });
        
        this.performanceMonitor.recordTransaction('failed', 'deposit', startTime);
      }
    }
    
    // 显示交易确认对话框
    async showTransactionConfirmation(details) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-medium text-gray-900 mb-4">确认${details.type}</h3>
            <div class="space-y-3 mb-6">
              <div class="flex justify-between">
                <span class="text-gray-600">金额:</span>
                <span class="font-medium">${details.amount}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">预估 Gas 费:</span>
                <span class="font-medium">${details.gasEstimate}</span>
              </div>
              <div class="flex justify-between border-t pt-3">
                <span class="text-gray-900 font-medium">总计:</span>
                <span class="font-bold">${details.total}</span>
              </div>
            </div>
            <div class="flex space-x-3">
              <button id="confirmBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                确认
              </button>
              <button id="cancelBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                取消
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelector('#confirmBtn').onclick = () => {
          modal.remove();
          resolve(true);
        };
        
        modal.querySelector('#cancelBtn').onclick = () => {
          modal.remove();
          resolve(false);
        };
        
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.remove();
            resolve(false);
          }
        };
      });
    }
    
    // 批量加载初始数据
    async loadInitialData() {
      const userAddress = this.stateManager.getState('user.address');
      
      try {
        // 并行加载数据
        const [userBalance, userDeposit, contractBalance, topDepositors] = await Promise.all([
          this.web3.provider.getBalance(userAddress),
          this.bankContract.contract.deposits(userAddress),
          this.bankContract.contract.getBalance(),
          this.bankContract.contract.getTopDepositors()
        ]);
        
        // 批量更新状态
        this.stateManager.batchUpdate({
          'user.balance': ethers.utils.formatEther(userBalance),
          'user.deposit': ethers.utils.formatEther(userDeposit),
          'contract.balance': ethers.utils.formatEther(contractBalance),
          'contract.topDepositors': topDepositors
        });
        
        // 检查用户排名
        const userRank = topDepositors.findIndex(addr => 
          addr.toLowerCase() === userAddress.toLowerCase()
        );
        
        if (userRank !== -1) {
          this.stateManager.setState('user.rank', userRank + 1);
        }
        
      } catch (error) {
        console.error('加载初始数据失败:', error);
        this.uxEnhancements.showSmartNotification('加载数据失败', 'error');
      }
    }
    
    // 获取性能报告
    getPerformanceReport() {
      return this.performanceMonitor.getPerformanceReport();
    }
    
    // 显示性能报告
    showPerformanceReport() {
      const report = this.getPerformanceReport();
      console.log('性能报告:', report);
      
      // 可以创建一个性能报告的 UI 界面
      this.uxEnhancements.showSmartNotification(
        `平均交易时间: ${report.summary.avgTransactionTime}ms, 错误率: ${report.summary.errorRate}`,
        'info',
        { duration: 10000 }
      );
    }
  }
  
  // 初始化优化版应用
  document.addEventListener('DOMContentLoaded', () => {
    new OptimizedBankDApp();
  });
  ```

### 🛠️ 每日检查清单
- [ ] **第1天**: 实现批量操作和并发处理系统
- [ ] **第2天**: 开发 Gas 优化和费用估算功能
- [ ] **第3天**: 实现智能重试机制和错误处理
- [ ] **第4天**: 建立性能监控和分析系统
- [ ] **第5天**: 优化用户体验和交互设计
- [ ] **第6-7天**: 集成测试和性能调优

### 📖 学习资源
- [以太坊 Gas 优化指南](https://ethereum.org/en/developers/docs/gas/)
- [Web 性能优化最佳实践](https://web.dev/performance/)
- [JavaScript 并发编程](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)

---

## 📅 第6周：新项目实战

### 🎯 本周目标
综合运用所学技能，开发一个新的 DApp 项目

### 📋 项目选择（二选一）
**选项A：代币交换 DApp**
- 创建 ERC20 代币合约
- 实现代币交换功能
- 添加流动性池概念

**选项B：投票治理 DApp**
- 创建投票合约
- 实现提案创建和投票
- 添加治理代币机制

### 📋 学习任务
- [ ] **合约设计和开发**
  - 设计合约架构
  - 实现核心功能
  - 编写测试用例

- [ ] **前端完整开发**
  - 设计用户界面
  - 实现所有交互功能
  - 添加数据可视化

- [ ] **项目部署**
  - 部署到测试网
  - 验证合约代码
  - 发布前端应用

### 🛠️ 技术栈
- **智能合约开发**: Solidity + Hardhat/Foundry
- **前端框架**: React/Vue + ethers.js/web3.js
- **样式框架**: 现代 CSS 框架 (Tailwind CSS)
- **测试工具**: Foundry (模糊测试) + Hardhat (集成测试)
- **部署工具**: Foundry (高性能) + Hardhat (生态丰富)

---

## 📅 第7周：安全和最佳实践

### 🎯 本周目标
学习智能合约和 DApp 安全最佳实践

### 📋 学习任务
- [ ] **常见安全问题**
  - 重入攻击防护
  - 整数溢出处理
  - 权限控制检查
  - 前端安全考虑

- [ ] **代码审计和安全测试**
  - 学习代码审计方法
  - 使用 Foundry 进行模糊测试
  - 使用 Slither/Mythril 静态分析
  - 编写不变量测试
  
  ```solidity
  // 使用 Foundry 进行模糊测试示例
  function testFuzzDeposit(uint256 amount) public {
      vm.assume(amount > 0 && amount <= 100 ether);
      vm.deal(user1, amount);
      
      vm.prank(user1);
      bank.deposit{value: amount}();
      
      assertEq(bank.deposits(user1), amount);
  }
  
  // 不变量测试
  function invariant_contractBalanceEqualsDeposits() public {
      uint256 totalDeposits = 0;
      for (uint i = 0; i < depositors.length; i++) {
          totalDeposits += bank.deposits(depositors[i]);
      }
      assertEq(address(bank).balance, totalDeposits);
  }
  ```

- [ ] **安全分析工具使用**
  ```bash
  # 使用 Slither 进行静态分析
  pip install slither-analyzer
  slither src/Bank.sol
  
  # 使用 Foundry 的内置安全检查
  forge test --gas-report
  forge coverage
  
  # 生成测试覆盖率报告
  forge coverage --report lcov
  ```

- [ ] **部署优化**
  - 合约升级策略
  - 多签钱包使用
  - 监控和告警

### 🛠️ 实践项目
- 审计之前开发的合约
- 修复发现的安全问题
- 添加安全防护措施
- 编写安全文档

---

## 📅 第8周：进阶主题

### 🎯 本周目标
探索区块链生态的前沿技术

### 📋 学习任务
- [ ] **Layer2 集成**
  - 了解 Layer2 解决方案
  - 集成 Polygon/Arbitrum
  - 跨链桥接技术

- [ ] **DeFi 协议集成**
  - 集成 Uniswap/Aave
  - 理解 DeFi 组合性
  - 实现收益农场

- [ ] **高级工具使用**
  - The Graph 数据索引
  - IPFS 去中心化存储
  - ENS 域名服务

### 🛠️ 实践项目
选择一个感兴趣的方向深入实践：
- 多链 DApp 开发
- DeFi 协议集成
- NFT 市场开发

---

## 📊 学习进度跟踪

### 每周检查清单
- [ ] 完成理论学习
- [ ] 完成实践项目
- [ ] 代码提交到 GitHub
- [ ] 写学习总结

### 技能评估标准
- **初级**：能够连接钱包，读取合约数据
- **中级**：能够发送交易，处理事件，管理状态
- **高级**：能够独立开发完整 DApp，考虑安全和性能

## 🔗 推荐资源

### 官方文档
- [Ethers.js 文档](https://docs.ethers.io/)
- [Web3.js 文档](https://web3js.readthedocs.io/)
- [Solidity 文档](https://docs.soliditylang.org/)

### 学习平台
- [Ethereum.org 开发者资源](https://ethereum.org/developers/)
- [OpenZeppelin 学习中心](https://docs.openzeppelin.com/learn/)
- [Consensys Academy](https://consensys.net/academy/)

### 实用工具
- [Remix IDE](https://remix.ethereum.org/)
- [Hardhat](https://hardhat.org/)
- [MetaMask](https://metamask.io/)

---

## 💡 学习建议

1. **循序渐进**：按周计划执行，不要跳跃式学习
2. **实践为主**：每个概念都要通过代码实践
3. **记录总结**：每周写学习笔记和项目总结
4. **社区参与**：加入开发者社区，参与讨论
5. **持续更新**：区块链技术发展快，保持学习

开始您的 Web3 开发之旅吧！🚀