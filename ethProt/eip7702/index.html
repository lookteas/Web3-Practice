<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIP-7702 è´¦æˆ·æŠ½è±¡æ¼”ç¤º</title>
    <!-- å¯¼å…¥æœ¬åœ° Ethers.js v6.15.0 -->
    <script src="./ethers-6.15.0.min.js"></script>
    <script type="text/javascript">
        
        // é…ç½®ç¨³å®šçš„RPCèŠ‚ç‚¹
        const STABLE_RPC_URLS = [
            // 'https://sepolia.infura.io/v3/23211bcb978542dbb55264865dd2ffd4', // Infuraå…¬å…±èŠ‚ç‚¹
            'https://ethereum-sepolia.gateway.tatum.io', // Infuraå…¬å…±èŠ‚ç‚¹
            'https://eth-sepolia.g.alchemy.com/v2/demo', // Alchemyå…¬å…±èŠ‚ç‚¹
            'https://rpc.sepolia.org', // å®˜æ–¹å…¬å…±èŠ‚ç‚¹
            'https://sepolia.gateway.tenderly.co', // Tenderlyå…¬å…±èŠ‚ç‚¹
        ];

        // åˆ›å»ºå¸¦æœ‰é‡è¯•æœºåˆ¶çš„HTTPä¼ è¾“
        function createStableTransport() {
            return http(STABLE_RPC_URLS[0], {
                retryCount: 3,
                retryDelay: 1000,
            });
        }

        // å…¨å±€å˜é‡
        window.walletClient = null;
        window.publicClient = null;
        window.account = null;
        window.delegateContract = null;
        window.tokenBank = null;
        
        // åˆçº¦åœ°å€ (Sepoliaæµ‹è¯•ç½‘éƒ¨ç½²åœ°å€)
        window.DELEGATE_CONTRACT_ADDRESS = '0xb9a31c2697b5ddaf00ce55b7323c9358b4a68175';
        window.TOKEN_BANK_ADDRESS = '0x23343331c3ff07974c28ecc69ce5a2fe525910da';
        
        // åˆçº¦ ABI
        window.DELEGATE_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
                "name": "getNonce",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address[]", "name": "targets", "type": "address[]"},
                    {"internalType": "uint256[]", "name": "values", "type": "uint256[]"},
                    {"internalType": "bytes[]", "name": "calldatas", "type": "bytes[]"},
                    {"internalType": "uint256", "name": "nonce", "type": "uint256"}
                ],
                "name": "batchExecute",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "bytes32", "name": "hash", "type": "bytes32"},
                    {"internalType": "bytes", "name": "signature", "type": "bytes"}
                ],
                "name": "isValidSignature",
                "outputs": [{"internalType": "bytes4", "name": "", "type": "bytes4"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "user", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "nonce", "type": "uint256"}
                ],
                "name": "BatchExecuted",
                "type": "event"
            }
        ];
        
        window.TOKEN_BANK_ABI = [
            {
                "inputs": [],
                "name": "deposit",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
                "name": "getBalance",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractBalance",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}],
                "name": "batchDeposit",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ];
        
        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        window.initClients = async function() {
            try {
                if (!window.ethereum) {
                    throw new Error('è¯·å®‰è£… MetaMask');
                }
                
                // åˆ›å»º Provider
                window.provider = new ethers.BrowserProvider(window.ethereum);
                
                // è·å–ç½‘ç»œä¿¡æ¯
                const network = await window.provider.getNetwork();
                console.log('è¿æ¥åˆ°ç½‘ç»œ:', network.name, 'Chain ID:', network.chainId);
                
                // è·å– Signerï¼ˆå¦‚æœå·²è¿æ¥é’±åŒ…ï¼‰
                try {
                    window.signer = await window.provider.getSigner();
                    window.account = { address: await window.signer.getAddress() };
                    console.log('å·²è¿æ¥è´¦æˆ·:', window.account.address);
                } catch (error) {
                    console.log('é’±åŒ…æœªè¿æ¥ï¼Œç­‰å¾…ç”¨æˆ·è¿æ¥');
                    window.signer = null;
                    window.account = null;
                }
                
                console.log('Ethers.js å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('åˆå§‹åŒ–å®¢æˆ·ç«¯å¤±è´¥:', error);
                return false;
            }
        };
        
        // è¿æ¥é’±åŒ…
        window.connectWallet = async function() {
            try {
                if (!window.ethereum) {
                    throw new Error('è¯·å®‰è£… MetaMask');
                }
                
                // è¯·æ±‚è¿æ¥é’±åŒ…
                await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                // é‡æ–°åˆå§‹åŒ–å®¢æˆ·ç«¯ä»¥è·å– Signer
                if (!(await window.initClients())) {
                    throw new Error('å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥');
                }
                
                if (!window.account) {
                    throw new Error('æ— æ³•è·å–è´¦æˆ·ä¿¡æ¯');
                }
                
                document.getElementById('currentAccount').textContent = window.account.address;
                showStatus('connectionStatus', 'âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼ç°åœ¨å¯ä»¥è·å– nonce å’Œæ‰§è¡Œæ“ä½œ', 'success');
                
                // æ£€æŸ¥ç½‘ç»œ
                await checkNetwork();
                
            } catch (error) {
                showStatus('connectionStatus', 'è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æ£€æŸ¥ç½‘ç»œ
        window.checkNetwork = async function() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== '0xaa36a7') { // Sepolia chainId
                    showStatus('connectionStatus', 'è¯·åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘', 'error');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥ç½‘ç»œå¤±è´¥:', error);
                return false;
            }
        };
        
        // è®¾ç½®åˆçº¦åœ°å€
        window.setContractAddresses = function() {
            const delegateAddr = document.getElementById('delegateAddress').value;
            const tokenBankAddr = document.getElementById('tokenBankAddress').value;
            
            if (!delegateAddr || !tokenBankAddr) {
                showStatus('contractStatus', 'è¯·è¾“å…¥åˆçº¦åœ°å€', 'error');
                return;
            }
            
            window.DELEGATE_CONTRACT_ADDRESS = delegateAddr;
            window.TOKEN_BANK_ADDRESS = tokenBankAddr;
            
            showStatus('contractStatus', 'åˆçº¦åœ°å€è®¾ç½®æˆåŠŸï¼', 'success');
        };
        
        // è·å–å½“å‰nonce
        window.getCurrentNonce = async function() {
            try {
                // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
                if (!window.provider) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }
                
                if (!window.account || !window.account.address) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }
                
                if (!window.DELEGATE_CONTRACT_ADDRESS) {
                    throw new Error('è¯·å…ˆè®¾ç½®ä»£ç†åˆçº¦åœ°å€');
                }
                
                // ä½¿ç”¨ provider è¯»å–åˆçº¦
                const contract = new ethers.Contract(
                    window.DELEGATE_CONTRACT_ADDRESS,
                    window.DELEGATE_ABI,
                    window.provider
                );
                
                const nonce = await contract.getNonce(window.account.address);
                
                document.getElementById('currentNonce').textContent = nonce.toString();
                showStatus('nonceStatus', `å½“å‰ nonce: ${nonce}`, 'info');
                
            } catch (error) {
                showStatus('nonceStatus', 'è·å– nonce å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // å•æ¬¡å­˜æ¬¾
        window.singleDeposit = async function() {
            try {
                // æ£€æŸ¥å¿…è¦çš„å‰ç½®æ¡ä»¶
                if (!window.signer) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }
                if (!window.account) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…è´¦æˆ·');
                }
                
                const amount = document.getElementById('singleDepositAmount').value;
                if (!amount || amount <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢');
                }
                
                const amountWei = ethers.parseEther(amount);
                
                // æ„å»ºè°ƒç”¨æ•°æ®
                const calldata = ethers.encodeFunctionData({
                    abi: window.TOKEN_BANK_ABI,
                    functionName: 'deposit'
                });
                
                // è·å–å½“å‰nonce
                const delegateContract = new ethers.Contract(
                    window.DELEGATE_CONTRACT_ADDRESS,
                    window.DELEGATE_ABI,
                    window.provider
                );
                const nonce = await delegateContract.getNonce(window.account.address);
                
                // æ‰§è¡Œæ‰¹é‡æ“ä½œ
                const delegateContractWithSigner = new ethers.Contract(
                    window.DELEGATE_CONTRACT_ADDRESS,
                    window.DELEGATE_ABI,
                    window.signer
                );
                
                const tx = await delegateContractWithSigner.batchExecute(
                    [window.TOKEN_BANK_ADDRESS],
                    [amountWei],
                    [calldata],
                    nonce,
                    { value: amountWei }
                );
                
                const receipt = await tx.wait();
                const hash = receipt.hash;
                
                showStatus('depositStatus', `å•æ¬¡å­˜æ¬¾æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${hash}`, 'success');
                document.getElementById('singleDepositAmount').value = '';
                
                // æ›´æ–°nonce
                setTimeout(() => getCurrentNonce(), 2000);
                
            } catch (error) {
                showStatus('depositStatus', 'å•æ¬¡å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æ‰¹é‡å­˜æ¬¾
        window.batchDeposit = async function() {
            try {
                // æ£€æŸ¥å¿…è¦çš„å‰ç½®æ¡ä»¶
                if (!window.signer) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }
                if (!window.account) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…è´¦æˆ·');
                }
                
                const amounts = document.getElementById('batchDepositAmounts').value
                    .split(',')
                    .map(a => a.trim())
                    .filter(a => a && parseFloat(a) > 0);
                
                if (amounts.length === 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢åˆ—è¡¨');
                }
                
                const targets = [];
                const values = [];
                const calldatas = [];
                let totalValue = 0n;
                
                for (const amount of amounts) {
                    const amountWei = ethers.parseEther(amount);
                    totalValue += amountWei;
                    
                    targets.push(window.TOKEN_BANK_ADDRESS);
                    values.push(amountWei);
                    calldatas.push(ethers.encodeFunctionData({
                        abi: window.TOKEN_BANK_ABI,
                        functionName: 'deposit'
                    }));
                }
                
                // è·å–å½“å‰nonce
                const delegateContract = new ethers.Contract(
                    window.DELEGATE_CONTRACT_ADDRESS,
                    window.DELEGATE_ABI,
                    window.provider
                );
                const nonce = await delegateContract.getNonce(window.account.address);
                
                // æ‰§è¡Œæ‰¹é‡æ“ä½œ
                const delegateContractWithSigner = new ethers.Contract(
                    window.DELEGATE_CONTRACT_ADDRESS,
                    window.DELEGATE_ABI,
                    window.signer
                );
                
                const tx = await delegateContractWithSigner.batchExecute(
                    targets,
                    values,
                    calldatas,
                    nonce,
                    { value: totalValue }
                );
                
                const receipt = await tx.wait();
                const hash = receipt.hash;
                
                showStatus('batchStatus', `æ‰¹é‡å­˜æ¬¾æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${hash}`, 'success');
                document.getElementById('batchDepositAmounts').value = '';
                
                // æ›´æ–°nonce
                setTimeout(() => getCurrentNonce(), 2000);
                
            } catch (error) {
                showStatus('batchStatus', 'æ‰¹é‡å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æŸ¥è¯¢ä½™é¢
        window.queryBalance = async function() {
            try {
                if (!window.provider || !window.account) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }
                
                // ä½¿ç”¨ ethers.js Contract æŸ¥è¯¢ä½™é¢
                const contract = new ethers.Contract(
                    window.TOKEN_BANK_ADDRESS,
                    window.TOKEN_BANK_ABI,
                    window.provider
                );
                
                const balance = await contract.getBalance(window.DELEGATE_CONTRACT_ADDRESS);
                const balanceEth = ethers.formatEther(balance);
                
                document.getElementById('balanceResult').textContent = `${balanceEth} ETH`;
                showStatus('queryStatus', `ä½™é¢æŸ¥è¯¢æˆåŠŸ: ${balanceEth} ETH`, 'info');
                
            } catch (error) {
                showStatus('queryStatus', 'æŸ¥è¯¢ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æŸ¥è¯¢åˆçº¦æ€»ä½™é¢
        window.queryContractBalance = async function() {
            try {
                if (!window.provider) {
                    throw new Error('è¯·å…ˆåˆå§‹åŒ–å®¢æˆ·ç«¯');
                }
                
                console.log('Querying contract balance for address:', window.TOKEN_BANK_ADDRESS);
                
                // ä½¿ç”¨ ethers.js Contract æŸ¥è¯¢åˆçº¦æ€»ä½™é¢
                const contract = new ethers.Contract(
                    window.TOKEN_BANK_ADDRESS,
                    window.TOKEN_BANK_ABI,
                    window.provider
                );
                
                console.log('Contract instance created, calling getContractBalance...');
                const balance = await contract.getContractBalance();
                console.log('Raw balance result:', balance);
                
                const balanceEth = ethers.formatEther(balance);
                console.log('Formatted balance:', balanceEth);
                
                document.getElementById('contractBalanceResult').textContent = `${balanceEth} ETH`;
                showStatus('queryStatus', `åˆçº¦æ€»ä½™é¢: ${balanceEth} ETH`, 'info');
                
            } catch (error) {
                console.error('Query contract balance error:', error);
                showStatus('queryStatus', 'æŸ¥è¯¢åˆçº¦ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // ä½¿ç”¨ Ethers.js æ‰‹åŠ¨åˆ›å»º EIP-7702 æˆæƒ
        window.createEIP7702Authorization = async function(params) {
            try {
                const { chainId, address, nonce } = params;
                
                // æ„å»º EIP-7702 æˆæƒæ¶ˆæ¯
                const authorizationMessage = ethers.solidityPacked(
                    ['uint8', 'uint256', 'address', 'uint256'],
                    [0x05, chainId, address, nonce] // 0x05 æ˜¯ EIP-7702 çš„é­”æœ¯å­—èŠ‚
                );
                
                // è®¡ç®—æ¶ˆæ¯å“ˆå¸Œ
                const messageHash = ethers.keccak256(authorizationMessage);
                
                // ä½¿ç”¨ signer ç­¾å
                const signature = await window.signer.signMessage(ethers.getBytes(messageHash));
                
                // è§£æç­¾å
                const sig = ethers.Signature.from(signature);
                
                // è¿”å› EIP-7702 æˆæƒæ ¼å¼
                return {
                    chainId: chainId,
                    address: address,
                    nonce: nonce,
                    yParity: sig.yParity,
                    r: sig.r,
                    s: sig.s
                };
                
            } catch (error) {
                console.error('åˆ›å»º EIP-7702 æˆæƒå¤±è´¥:', error);
                throw error;
            }
        };
        
        // EIP-7702 Authorization ç›¸å…³åŠŸèƒ½
        
        // ç”Ÿæˆ EIP-7702 Authorization ç­¾å
        window.generateAuthorization = async function(contractAddress, nonce = 0n) {
            try {
                if (!window.account || !window.walletClient) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }
                
                // EIP-7702 Authorization ç»“æ„
                const authorization = {
                    chainId: BigInt(sepolia.id),
                    address: contractAddress,
                    nonce: BigInt(nonce)
                };
                
                // æ„å»ºç­¾åæ¶ˆæ¯ (EIP-7702 è§„èŒƒ)
                const message = ethers.concat([
                    '0x05', // EIP-7702 magic byte
                    ethers.pad(ethers.toHex(authorization.chainId), { size: 32 }),
                    ethers.pad(authorization.address, { size: 32 }),
                    ethers.pad(ethers.toHex(authorization.nonce), { size: 32 })
                ]);
                
                const messageHash = ethers.keccak256(message);
                
                // ä½¿ç”¨ ethers.js signer ç­¾å
                const signature = await window.signer.signMessage(ethers.getBytes(messageHash));
                
                // è§£æç­¾å
                const signatureBytes = ethers.getBytes(signature);
                const r = ethers.hexlify(signatureBytes.slice(0, 32));
                const s = ethers.hexlify(signatureBytes.slice(32, 64));
                const v = signatureBytes[64];
                
                return {
                    authorization,
                    signature: {
                        r,
                        s,
                        v,
                        yParity: v === 27 ? 0 : 1
                    },
                    messageHash: ethers.hexlify(messageHash)
                };
                
            } catch (error) {
                console.error('ç”Ÿæˆ Authorization å¤±è´¥:', error);
                throw error;
            }
        };
        
        // æ„å»º Authorization List
        window.buildAuthorizationList = async function() {
            try {
                const authData = await window.generateAuthorization(
                    window.DELEGATE_CONTRACT_ADDRESS,
                    0n
                );
                
                // EIP-7702 Authorization List æ ¼å¼
                const authorizationList = [{
                    chainId: authData.authorization.chainId,
                    address: authData.authorization.address,
                    nonce: authData.authorization.nonce,
                    yParity: authData.signature.yParity,
                    r: authData.signature.r,
                    s: authData.signature.s
                }];
                
                console.log('Authorization List æ„å»ºæˆåŠŸ:', authorizationList);
                return authorizationList;
                
            } catch (error) {
                console.error('æ„å»º Authorization List å¤±è´¥:', error);
                throw error;
            }
        };
         
         // éªŒè¯ Authorization ç­¾å
         window.verifyAuthorization = function(authorization, signature, signerAddress) {
             try {
                 // é‡å»ºç­¾åæ¶ˆæ¯
                 const message = ethers.concat([
                     '0x05', // EIP-7702 magic byte
                     ethers.pad(ethers.toHex(authorization.chainId), { size: 32 }),
                     ethers.pad(authorization.address, { size: 32 }),
                     ethers.pad(ethers.toHex(authorization.nonce), { size: 32 })
                 ]);
                 
                 const messageHash = ethers.keccak256(message);
                 
                 // è¿™é‡Œåº”è¯¥ä½¿ç”¨ ecrecover éªŒè¯ç­¾åï¼Œä½†åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ç®€åŒ–å¤„ç†
                 console.log('éªŒè¯ Authorization:', {
                     messageHash: ethers.bytesToHex(messageHash),
                     signature,
                     expectedSigner: signerAddress
                 });
                 
                 return true; // ç®€åŒ–éªŒè¯ï¼Œå®é™…åº”è¯¥è¿›è¡Œå®Œæ•´çš„ç­¾åéªŒè¯
                 
             } catch (error) {
                 console.error('éªŒè¯ Authorization å¤±è´¥:', error);
                 return false;
             }
         };
         
         // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å·²ç»è®¾ç½®äº†ä»£ç 
         window.checkAccountCode = async function(address) {
             try {
                 if (!window.provider) {
                     throw new Error('è¯·å…ˆåˆå§‹åŒ–å®¢æˆ·ç«¯');
                 }
                 
                 if (!address) {
                    address = window.account.address;
                }
                 
                 if (!address) {
                     throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                 }
                 
                 const code = await window.provider.getCode(address);
                 
                 const hasCode = code && code !== '0x';
                 const statusText = hasCode ? 'å·²è®¾ç½®ä»£ç ' : 'æœªè®¾ç½®ä»£ç ';
                 
                 document.getElementById('accountCodeStatus').textContent = statusText;
                 showStatus('authStatus', `è´¦æˆ·ä»£ç æ£€æŸ¥å®Œæˆ: ${statusText}`, 'info');
                 
                 console.log(`è´¦æˆ· ${address} ä»£ç çŠ¶æ€:`, statusText);
                 console.log('å­—èŠ‚ç :', code);
                 
                 return {
                     hasCode,
                     bytecode: code || '0x'
                 };
                 
             } catch (error) {
                 showStatus('authStatus', 'æ£€æŸ¥è´¦æˆ·ä»£ç å¤±è´¥: ' + error.message, 'error');
                 console.error('æ£€æŸ¥è´¦æˆ·ä»£ç å¤±è´¥:', error);
                 return { hasCode: false, bytecode: '0x' };
             }
         };
         
         // å‘é€å¸¦æœ‰ Authorization List çš„äº¤æ˜“
        // è®¾ç½®ä»£ç†åˆçº¦åœ°å€
        window.setDelegateContract = function() {
            const contractAddress = document.getElementById('delegateContract').value.trim();
            
            if (!contractAddress) {
                alert('è¯·è¾“å…¥ä»£ç†åˆçº¦åœ°å€');
                return;
            }
            
            if (!contractAddress.startsWith('0x') || contractAddress.length !== 42) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€ (0xå¼€å¤´ï¼Œ42ä½å­—ç¬¦)');
                return;
            }
            
            window.DELEGATE_CONTRACT_ADDRESS = contractAddress;
            showStatus('authStatus', `ä»£ç†åˆçº¦åœ°å€å·²è®¾ç½®: ${contractAddress}`, 'success');
            console.log('ä»£ç†åˆçº¦åœ°å€å·²è®¾ç½®:', contractAddress);
        };

        window.sendAuthorizationTransaction = async function() {
            try {
                if (!window.signer || !window.account) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }
                
                if (!window.DELEGATE_CONTRACT_ADDRESS) {
                    throw new Error('è¯·å…ˆè®¾ç½®ä»£ç†åˆçº¦åœ°å€');
                }
                
                showStatus('authStatus', 'âš ï¸ æ³¨æ„ï¼šMetaMask å½“å‰ä¸æ”¯æŒ EIP-7702 äº¤æ˜“ï¼Œæ­£åœ¨æ¼”ç¤ºæˆæƒç­¾åè¿‡ç¨‹...', 'info');
                
                // è·å–å½“å‰ nonce
                const currentNonce = await window.provider.getTransactionCount(window.account.address);
                
                console.log('Creating EIP-7702 authorization with:', {
                    chainId: 11155111, // Sepolia chain ID
                    address: window.account.address,
                    nonce: currentNonce + 1, // ä½¿ç”¨ nonce + 1 å› ä¸ºäº¤æ˜“ä¼šå…ˆå¢åŠ  nonce
                    contractAddress: window.DELEGATE_CONTRACT_ADDRESS
                });
                
                // æ‰‹åŠ¨å®ç° EIP-7702 æˆæƒç­¾å
                const authorization = await createEIP7702Authorization({
                    chainId: 11155111, // Sepolia chain ID
                    address: window.DELEGATE_CONTRACT_ADDRESS, // è¦å§”æ‰˜ç»™çš„åˆçº¦åœ°å€
                    nonce: currentNonce + 1 // ä½¿ç”¨ nonce + 1
                });
                
                console.log('EIP-7702 Authorization:', authorization);
                
                showStatus('authStatus', 'âœ… EIP-7702 æˆæƒç­¾åç”ŸæˆæˆåŠŸï¼', 'success');
                
                // æ¨¡æ‹Ÿäº¤æ˜“å“ˆå¸Œ
                const mockTxHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
                
                // æ˜¾ç¤ºæˆæƒè¯¦æƒ…
                const authDetails = `
                    <div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
                        <h4>EIP-7702 æˆæƒè¯¦æƒ…ï¼š</h4>
                        <p><strong>é“¾ ID:</strong> ${authorization.chainId}</p>
                        <p><strong>å§”æ‰˜åˆçº¦:</strong> ${authorization.address}</p>
                        <p><strong>Nonce:</strong> ${authorization.nonce}</p>
                        <p><strong>ç­¾å:</strong> ${authorization.signature}</p>
                        <p><strong>æ¨¡æ‹Ÿäº¤æ˜“å“ˆå¸Œ:</strong> ${mockTxHash}</p>
                        <p style="color: #666; font-size: 12px; margin-top: 10px;">
                            æ³¨æ„ï¼šè¿™æ˜¯æ¼”ç¤ºæ¨¡å¼ã€‚å®é™…çš„ EIP-7702 äº¤æ˜“éœ€è¦æ”¯æŒè¯¥æ ‡å‡†çš„é’±åŒ…å’Œç½‘ç»œã€‚
                        </p>
                    </div>
                `;
                
                document.getElementById('authStatus').innerHTML = authDetails;
                
                console.log('EIP-7702 Authorization æ¼”ç¤ºå®Œæˆ:', {
                    authorization,
                    mockTxHash
                });
                
                // æ¨¡æ‹Ÿè´¦æˆ·ä»£ç çŠ¶æ€æ›´æ–°
                setTimeout(() => {
                    document.getElementById('accountCodeStatus').textContent = 'å·²è®¾ç½®ä»£ç ';
                    showStatus('codeStatus', 'âœ… è´¦æˆ·ä»£ç çŠ¶æ€å·²æ›´æ–°', 'success');
                }, 2000);
                
                return mockTxHash;
                
            } catch (error) {
                showStatus('authStatus', 'EIP-7702 æˆæƒå¤±è´¥: ' + error.message, 'error');
                console.error('EIP-7702 Authorization äº¤æ˜“å¤±è´¥:', error);
                throw error;
            }
        };
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        window.showStatus = function(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            
            // 3ç§’åéšè—æˆåŠŸä¿¡æ¯
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            try {
                if (await window.initClients()) {
                    console.log('EIP-7702 æ¼”ç¤ºé¡µé¢åŠ è½½å®Œæˆ');
                    
                    // å¦‚æœå·²ç»è¿æ¥é’±åŒ…ï¼Œæ˜¾ç¤ºè¿æ¥çŠ¶æ€
                    if (window.account && window.account.address) {
                        document.getElementById('currentAccount').textContent = window.account.address;
                        showStatus('connectionStatus', 'âœ… é’±åŒ…å·²è¿æ¥ï¼Œå¯ä»¥å¼€å§‹æ“ä½œ', 'success');
                    } else {
                        showStatus('connectionStatus', 'âš ï¸ è¯·ç‚¹å‡»"è¿æ¥ MetaMask"æŒ‰é’®è¿æ¥é’±åŒ…', 'info');
                    }
                }
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showStatus('connectionStatus', 'âš ï¸ é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        });
    </script>
    <style>
        /* å…¨å±€é‡ç½®å’ŒåŸºç¡€æ ·å¼ */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
            font-weight: 400;
        }
        
        /* åŠŸèƒ½åŒºåŸŸæ ·å¼ */
        .section {
            margin-bottom: 25px;
            padding: 25px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .section h3 {
            margin: 0 0 20px 0;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .input-group label {
            min-width: 140px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        /* è¡¨å•å…ƒç´ ç»Ÿä¸€æ ·å¼ */
        input, button {
            padding: 14px 18px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        input {
            flex: 1;
            background: white;
            min-width: 200px;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
            background: #fafbfc;
        }
        
        input::placeholder {
            color: #adb5bd;
            font-style: italic;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 600;
            min-width: 130px;
            white-space: nowrap;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        /* çŠ¶æ€æç¤ºæ ·å¼ */
        .status {
            margin-top: 15px;
            padding: 14px 18px;
            border-radius: 8px;
            font-weight: 500;
            border-left: 4px solid;
            font-size: 14px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        
        /* ç‰¹æ®ŠåŒºåŸŸæ ·å¼ */
        .highlight {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            border-color: #e17055;
            position: relative;
        }
        
        .highlight::before {
            content: "â­";
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 20px;
        }
        
        /* ç»“æœæ˜¾ç¤ºæ ·å¼ */
        .result-display {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            color: #495057;
            font-size: 13px;
            min-width: 150px;
            word-break: break-all;
        }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            width: 100%;
        }
        
        .grid .section {
            width: 100%;
            min-width: 0;
        }
        
        /* ä½¿ç”¨è¯´æ˜æ ·å¼ */
        .section ol {
            padding-left: 20px;
        }
        
        .section ol li {
            margin-bottom: 8px;
            line-height: 1.7;
        }
        
        .section ol li strong {
            color: #495057;
        }
        
        /* è­¦å‘Šæç¤ºæ ·å¼ */
        .section p[style*="background: #fff3cd"] {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
            border-radius: 8px;
            border-left: 4px solid #ffc107 !important;
            font-size: 14px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 992px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 2.2em;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .input-group label {
                min-width: auto;
                text-align: left;
            }
            
            input, button {
                width: 100%;
                min-width: auto;
            }
            
            .section {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .section {
                padding: 15px;
            }
            
            input, button {
                padding: 12px 14px;
                font-size: 13px;
            }
        }
        
        /* å¯è®¿é—®æ€§æ”¹è¿› */
        button:focus,
        input:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .loading button {
            position: relative;
        }
        
        .loading button::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ EIP-7702 è´¦æˆ·æŠ½è±¡æ¼”ç¤º</h1>
        <p class="subtitle">åŸºäº Viem çš„æ‰¹é‡æ“ä½œå’Œä»£ç†æ‰§è¡Œæ¼”ç¤º</p>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="section">
            <h3>ğŸ“± é’±åŒ…è¿æ¥</h3>
            <div class="input-group">
                <label>å½“å‰è´¦æˆ·:</label>
                <div class="result-display" id="currentAccount">æœªè¿æ¥</div>
                <button onclick="connectWallet()">è¿æ¥ MetaMask</button>
            </div>
            <div id="connectionStatus" class="status" style="display:none;"></div>
        </div>

        <!-- åˆçº¦é…ç½® -->
        <div class="section">
            <h3>âš™ï¸ åˆçº¦é…ç½®</h3>
            <div class="input-group">
                <label>Delegateåˆçº¦:</label>
                <input type="text" id="delegateAddress" placeholder="è¾“å…¥ DelegateContract åœ°å€" value="0xb9a31c2697b5DdAF00ce55B7323c9358b4A68175" style="font-family: monospace;">
            </div>
            <div class="input-group">
                <label>TokenBankåˆçº¦:</label>
                <input type="text" id="tokenBankAddress" placeholder="è¾“å…¥ TokenBank åœ°å€" value="0x23343331C3ff07974c28ECC69cE5a2Fe525910Da" style="font-family: monospace;">
                <button onclick="setContractAddresses()">è®¾ç½®åœ°å€</button>
            </div>
            <div id="contractStatus" class="status" style="display:none;"></div>
        </div>

        <!-- Nonce ç®¡ç† -->
        <div class="section">
            <h3>ğŸ”¢ Nonce ç®¡ç†</h3>
            <div class="input-group">
                <label>å½“å‰ Nonce:</label>
                <div class="result-display" id="currentNonce">-</div>
                <button onclick="getCurrentNonce()">åˆ·æ–° Nonce</button>
            </div>
            <p style="font-size: 12px; color: #6c757d; margin: 5px 0;">
                ğŸ’¡ è·å– nonce å‰è¯·ç¡®ä¿å·²è¿æ¥é’±åŒ…å¹¶è®¾ç½®äº†ä»£ç†åˆçº¦åœ°å€
            </p>
            <div id="nonceStatus" class="status" style="display:none;"></div>
        </div>

        <!-- EIP-7702 è´¦æˆ·æŠ½è±¡æˆæƒ -->
        <div class="section highlight">
            <h3>ğŸ” EIP-7702 è´¦æˆ·æŠ½è±¡æˆæƒ</h3>
            <div class="input-group">
                <label>ä»£ç†åˆçº¦åœ°å€:</label>
                <input type="text" id="delegateContract" placeholder="è¾“å…¥ä»£ç†åˆçº¦åœ°å€ (0x...)">
                <button onclick="setDelegateContract()">è®¾ç½®ä»£ç†åˆçº¦</button>
            </div>
            <div class="input-group">
                <label>è´¦æˆ·ä»£ç çŠ¶æ€:</label>
                <div class="result-display" id="accountCodeStatus">æœªæ£€æŸ¥</div>
                <button onclick="checkAccountCode(window.account.address)">æ£€æŸ¥ä»£ç </button>
            </div>
            <div class="input-group">
                <label>æˆæƒæ“ä½œ:</label>
                <button onclick="sendAuthorizationTransaction()">æ¨¡æ‹Ÿ EIP-7702 æˆæƒ </button>
            </div>
            <p style="font-size: 12px; color: #6c757d; margin: 5px 0;">
                ğŸ’¡ EIP-7702 å…è®¸ EOA è´¦æˆ·ä¸´æ—¶è®¾ç½®ä»£ç ï¼Œå®ç°è´¦æˆ·æŠ½è±¡åŠŸèƒ½<br>
                âš ï¸ æ³¨æ„ï¼šå½“å‰ MetaMask ä¸æ”¯æŒå¤–éƒ¨ EIP-7702 äº¤æ˜“ï¼Œæ­¤å¤„ä¸ºæ¼”ç¤ºæ¨¡å¼
            </p>
            <div id="authStatus" class="status" style="display:none;"></div>
        </div>

        <div class="grid">
            <!-- å•æ¬¡å­˜æ¬¾ -->
            <div class="section">
                <h3>ğŸ’° å•æ¬¡å­˜æ¬¾</h3>
                <div class="input-group">
                    <label>å­˜æ¬¾é‡‘é¢:</label>
                    <input type="number" id="singleDepositAmount" placeholder="è¾“å…¥ ETH æ•°é‡" step="0.001" min="0">
                    <button onclick="singleDeposit()">æ‰§è¡Œå­˜æ¬¾</button>
                </div>
                <div id="depositStatus" class="status" style="display:none;"></div>
            </div>

            <!-- æ‰¹é‡å­˜æ¬¾ -->
            <div class="section highlight">
                <h3>ğŸ¯ æ‰¹é‡å­˜æ¬¾</h3>
                <div class="input-group">
                    <label>å­˜æ¬¾åˆ—è¡¨:</label>
                    <input type="text" id="batchDepositAmounts" placeholder="ä¾‹å¦‚: 0.1, 0.2, 0.3">
                    <button onclick="batchDeposit()">æ‰¹é‡æ‰§è¡Œ</button>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin: 5px 0;">
                    ğŸ’¡ è¾“å…¥å¤šä¸ªé‡‘é¢ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå°†åœ¨ä¸€ä¸ªäº¤æ˜“ä¸­æ‰§è¡Œå¤šæ¬¡å­˜æ¬¾
                </p>
                <div id="batchStatus" class="status" style="display:none;"></div>
            </div>
        </div>

        <!-- æŸ¥è¯¢åŠŸèƒ½ -->
        <div class="section">
            <h3>ğŸ” ä½™é¢æŸ¥è¯¢</h3>
            <div class="grid">
                <div>
                    <div class="input-group">
                        <label>ä»£ç†åˆçº¦ä½™é¢:</label>
                        <div class="result-display" id="balanceResult">-</div>
                        <button onclick="queryBalance()">æŸ¥è¯¢ä½™é¢</button>
                    </div>
                </div>
                <div>
                    <div class="input-group">
                        <label>åˆçº¦æ€»ä½™é¢:</label>
                        <div class="result-display" id="contractBalanceResult">-</div>
                        <button onclick="queryContractBalance()">æŸ¥è¯¢æ€»é¢</button>
                    </div>
                </div>
            </div>
            <div id="queryStatus" class="status" style="display:none;"></div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="section">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <ol style="line-height: 1.8;">
                <li><strong>è¿æ¥é’±åŒ…:</strong> ç‚¹å‡»"è¿æ¥ MetaMask"æŒ‰é’®ï¼Œç¡®ä¿åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘</li>
                <li><strong>è®¾ç½®åˆçº¦:</strong> è¾“å…¥éƒ¨ç½²åçš„ DelegateContract å’Œ TokenBank åˆçº¦åœ°å€</li>
                <li><strong>è®¾ç½®ä»£ç†åˆçº¦:</strong> åœ¨ EIP-7702 æˆæƒåŒºåŸŸè®¾ç½®ä»£ç†åˆçº¦åœ°å€</li>
                <li><strong>EIP-7702 æˆæƒ:</strong> æ£€æŸ¥è´¦æˆ·ä»£ç çŠ¶æ€ï¼Œç„¶åæ¨¡æ‹Ÿ EIP-7702 æˆæƒè¿‡ç¨‹ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼Œå›  MetaMask é™åˆ¶ï¼‰</li>
                <li><strong>æŸ¥çœ‹ Nonce:</strong> æ¯æ¬¡æ“ä½œå‰æŸ¥çœ‹å½“å‰ nonceï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»</li>
                <li><strong>å•æ¬¡å­˜æ¬¾:</strong> é€šè¿‡ä»£ç†åˆçº¦æ‰§è¡Œå•æ¬¡å­˜æ¬¾æ“ä½œ</li>
                <li><strong>æ‰¹é‡å­˜æ¬¾:</strong> åœ¨ä¸€ä¸ªäº¤æ˜“ä¸­æ‰§è¡Œå¤šæ¬¡å­˜æ¬¾ï¼Œå±•ç¤º EIP-7702 çš„æ‰¹é‡æ“ä½œèƒ½åŠ›</li>
                <li><strong>æŸ¥è¯¢ä½™é¢:</strong> æŸ¥çœ‹ä»£ç†åˆçº¦åœ¨ TokenBank ä¸­çš„å­˜æ¬¾ä½™é¢</li>
            </ol>
            <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                <strong>âš ï¸ æ³¨æ„:</strong> è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºé¡¹ç›®ï¼Œä»…åœ¨ Sepolia æµ‹è¯•ç½‘ä¸Šä½¿ç”¨ã€‚è¯·ä¸è¦åœ¨ä¸»ç½‘ä¸Šä½¿ç”¨çœŸå®èµ„é‡‘ã€‚
            </p>
        </div>
    </div>
</body>
</html>