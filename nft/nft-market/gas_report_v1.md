# NFTMarket 合约 Gas 消耗报告 V1 (优化前)

## 概述
本报告记录了 NFTMarket 合约在优化前的 gas 消耗情况。测试运行于 Foundry 框架，包含 86 个测试用例，全部通过。

## 合约部署成本
- **NFTMarket 合约部署成本**: 2,617,157 gas
- **部署大小**: 11,382 bytes

## 主要函数 Gas 消耗分析

### 核心交易函数
| 函数名 | 最小值 | 平均值 | 中位数 | 最大值 | 调用次数 |
|--------|--------|--------|--------|--------|----------|
| `listNFT` | 29,568 | 234,089 | 293,867 | 293,867 | 36 |
| `buyNFT` | 28,712 | 109,239 | 162,523 | 169,456 | 12 |
| `cancelListing` | 33,110 | 35,719 | 36,598 | 38,300 | 6 |
| `updateListingPrice` | 26,599 | 31,697 | 30,892 | 37,602 | 3 |

### 拍卖相关函数
| 函数名 | 最小值 | 平均值 | 中位数 | 最大值 | 调用次数 |
|--------|--------|--------|--------|--------|----------|
| `createAuction` | 31,885 | 259,374 | 298,711 | 298,717 | 14 |
| `placeBid` | 35,530 | 67,675 | 81,281 | 84,242 | 10 |
| `endAuction` | 38,162 | 110,230 | 142,543 | 167,543 | 5 |

### 报价相关函数
| 函数名 | 最小值 | 平均值 | 中位数 | 最大值 | 调用次数 |
|--------|--------|--------|--------|--------|----------|
| `makeOffer` | 37,619 | 263,956 | 309,224 | 309,224 | 6 |
| `acceptOffer` | 133,113 | 157,046 | 167,613 | 170,413 | 3 |
| `cancelOffer` | 35,917 | 35,917 | 35,917 | 35,917 | 1 |

### 查询函数
| 函数名 | 最小值 | 平均值 | 中位数 | 最大值 | 调用次数 |
|--------|--------|--------|--------|--------|----------|
| `getActiveListings` | 43,693 | 43,693 | 43,693 | 43,693 | 2 |
| `getUserListings` | 44,357 | 44,357 | 44,357 | 44,357 | 1 |

### 管理员函数
| 函数名 | 最小值 | 平均值 | 中位数 | 最大值 | 调用次数 |
|--------|--------|--------|--------|--------|----------|
| `setPlatformFee` | 23,643 | 26,758 | 26,758 | 29,873 | 2 |
| `setFeeRecipient` | 29,552 | 29,552 | 29,552 | 29,552 | 1 |
| `setMinimumPrice` | 28,610 | 28,610 | 28,610 | 28,610 | 1 |
| `pause` | 27,884 | 27,884 | 27,884 | 27,884 | 3 |
| `unpause` | 27,558 | 27,558 | 27,558 | 27,558 | 1 |
| `emergencyWithdraw` | 31,032 | 31,032 | 31,032 | 31,032 | 1 |

### 状态查询函数
| 函数名 | 最小值 | 平均值 | 中位数 | 最大值 | 调用次数 |
|--------|--------|--------|--------|--------|----------|
| `listings` | 17,875 | 17,875 | 17,875 | 17,875 | 13 |
| `auctions` | 21,682 | 21,682 | 21,682 | 21,682 | 10 |
| `offers` | 17,589 | 17,589 | 17,589 | 17,589 | 5 |
| `nftToListingId` | 2,979 | 2,979 | 2,979 | 2,979 | 11 |
| `platformFeePercentage` | 2,850 | 2,850 | 2,850 | 2,850 | 2 |
| `minimumPrice` | 2,542 | 2,542 | 2,542 | 2,542 | 4 |
| `feeRecipient` | 2,408 | 2,408 | 2,408 | 2,408 | 2 |
| `paused` | 2,472 | 2,472 | 2,472 | 2,472 | 3 |
| `owner` | 2,651 | 2,651 | 2,651 | 2,651 | 1 |

## 测试用例执行情况

### 集成测试 (Integration.t.sol)
- 测试数量: 9 个
- 执行时间: 3.43ms (6.16ms CPU)
- 最高 gas 消耗: `testComplexScenario` - 1,428,204 gas
- 最低 gas 消耗: `testUnauthorizedActions` - 427,330 gas

### NFTMarket 测试 (NFTMarket.t.sol)
- 测试数量: 43 个
- 执行时间: 3.53ms (12.76ms CPU)
- 最高 gas 消耗: `testGetActiveListings` - 929,253 gas
- 最低 gas 消耗: `testDeployment` - 24,468 gas

### MyNFT 测试 (MyNFT.t.sol)
- 测试数量: 34 个
- 执行时间: 3.54ms (12.74ms CPU)
- 最高 gas 消耗: `testTokensOfOwner` - 855,266 gas
- 最低 gas 消耗: `testSupportsInterface` - 9,248 gas

## Gas 消耗热点分析

### 高消耗函数 (>200,000 gas 平均值)
1. **makeOffer**: 263,956 gas (平均)
2. **createAuction**: 259,374 gas (平均)  
3. **listNFT**: 234,089 gas (平均)

### 中等消耗函数 (50,000-200,000 gas)
1. **acceptOffer**: 157,046 gas (平均)
2. **buyNFT**: 109,239 gas (平均)
3. **endAuction**: 110,230 gas (平均)
4. **placeBid**: 67,675 gas (平均)

### 低消耗函数 (<50,000 gas)
1. **getUserListings**: 44,357 gas
2. **getActiveListings**: 43,693 gas
3. **cancelListing**: 35,719 gas (平均)
4. **cancelOffer**: 35,917 gas

## 优化机会识别

基于当前 gas 消耗数据，以下是主要的优化机会：

1. **存储优化**: 高消耗函数主要涉及存储操作，可以通过打包结构体、减少存储写入来优化
2. **事件优化**: 减少事件参数数量和复杂度
3. **循环优化**: 在查询函数中优化循环逻辑
4. **条件检查优化**: 重新排序条件检查，将最可能失败的条件放在前面

## 总结

当前 NFTMarket 合约的 gas 消耗情况：
- 部署成本较高 (2.6M gas)
- 核心交易函数消耗适中 (100-300k gas)
- 查询函数相对高效 (40-50k gas)
- 存在明显的优化空间，特别是在存储操作和结构体设计方面

---
*报告生成时间: 2025/10/15*
*测试框架: Foundry*
*Solidity 版本: 0.8.25*